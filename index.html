<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Investissement | Antoine - Olympus Capital</title>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f0b429">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tracker">
    <meta name="description" content="Suivi de portefeuille professionnel - Olympus Capital">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            /* Bloomberg Dark Palette */
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: rgba(26, 26, 36, 0.6);
            --bg-card-hover: rgba(36, 36, 48, 0.8);
            --bg-elevated: #1e1e2a;

            /* Borders */
            --border: #2a2a3a;
            --border-light: rgba(240, 180, 41, 0.2);
            --border-subtle: rgba(255, 255, 255, 0.06);

            /* Accent - Gold/Amber institutionnel */
            --accent-primary: #f0b429;
            --accent-secondary: #d4a012;
            --accent-dim: rgba(240, 180, 41, 0.15);
            --accent-glow: rgba(240, 180, 41, 0.3);

            /* Text Hierarchy */
            --text-primary: #f0b429;
            --text-secondary: #e8e8e8;
            --text-tertiary: #a0a0a8;
            --text-white: #ffffff;
            --text-muted: rgba(240, 180, 41, 0.6);
            --text-dim: rgba(255, 255, 255, 0.5);

            /* Semantic States */
            --positive: #00d47e;
            --positive-dim: rgba(0, 212, 126, 0.15);
            --negative: #ff4757;
            --negative-dim: rgba(255, 71, 87, 0.15);
            --warning: #ffa502;
            --warning-dim: rgba(255, 165, 2, 0.15);
            --info: #3b82f6;
            --info-dim: rgba(59, 130, 246, 0.15);

            /* Legacy compatibility */
            --success: var(--positive);
            --success-dim: var(--positive-dim);
            --danger: var(--negative);
            --danger-dim: var(--negative-dim);

            /* Colors */
            --gold: #f0b429;
            --purple: #8b5cf6;
            --orange: #f97316;
            --btc: #f7931a;
            --eth: #627eea;

            /* Typography */
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', 'Consolas', monospace;
            --font-size-xs: 0.7rem;
            --font-size-sm: 0.8rem;
            --font-size-base: 0.9rem;
            --font-size-lg: 1.1rem;
            --font-size-xl: 1.4rem;
            --font-size-2xl: 2rem;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;

            /* Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Shadows */
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 30px rgba(240, 180, 41, 0.1);
            --shadow-inset: inset 0 1px 0 rgba(255, 255, 255, 0.05);

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.25s ease;
            --transition-slow: 0.4s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-mono);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 14px;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Header - Bloomberg Trading Platform Style */
        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3), var(--shadow-inset);
            padding: var(--space-md) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-primary);
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(240, 180, 41, 0.3);
            position: relative;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, var(--accent-primary), transparent);
            opacity: 0.3;
            z-index: -1;
        }

        .logo-text {
            font-size: var(--font-size-lg);
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .logo-text span {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .header-prices {
            display: flex;
            gap: var(--space-md);
            align-items: center;
        }

        .price-badge {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            transition: var(--transition-fast);
        }

        .price-badge:hover {
            background: var(--bg-card);
            border-color: var(--border);
        }

        .price-badge .icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            font-weight: 700;
        }

        .price-badge .icon.btc { background: var(--btc); color: #000; }
        .price-badge .icon.eth { background: var(--eth); color: #fff; }
        .price-badge .icon.sp500 { background: var(--purple); color: #fff; }

        .price-badge .value {
            color: var(--text-white);
            font-weight: 500;
            font-size: var(--font-size-sm);
        }
        .price-badge .change { font-size: var(--font-size-xs); font-weight: 500; }
        .price-badge .change.up { color: var(--positive); }
        .price-badge .change.down { color: var(--negative); }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .refresh-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(240, 180, 41, 0.2);
        }

        .refresh-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Navigation - Bloomberg Tab Style */
        .nav {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            padding: 0 var(--space-lg);
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-tab {
            padding: var(--space-md) var(--space-lg);
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            background: rgba(240, 180, 41, 0.05);
        }

        .nav-tab.active::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Cards - Glassmorphism Bloomberg Style */
        .card {
            background: linear-gradient(135deg, rgba(26, 26, 36, 0.8) 0%, rgba(18, 18, 26, 0.9) 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow), var(--shadow-inset);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(240, 180, 41, 0.3), transparent);
            opacity: 0;
            transition: var(--transition-base);
        }

        .card:hover {
            background: linear-gradient(135deg, rgba(36, 36, 48, 0.85) 0%, rgba(26, 26, 36, 0.95) 100%);
            border-color: rgba(240, 180, 41, 0.2);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(240, 180, 41, 0.05);
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-subtle);
        }

        .card-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Patrimoine Hero - Premium Bloomberg Style */
        .patrimoine-hero {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            background: linear-gradient(135deg, rgba(26, 26, 36, 0.9) 0%, rgba(240, 180, 41, 0.08) 50%, rgba(26, 26, 36, 0.9) 100%);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
            position: relative;
            overflow: hidden;
        }

        .patrimoine-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(240, 180, 41, 0.05) 0%, transparent 50%);
            animation: pulse-glow 8s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .patrimoine-label {
            font-size: var(--font-size-xs);
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: var(--space-sm);
            position: relative;
        }

        .patrimoine-total {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--text-white);
            letter-spacing: -0.02em;
            margin-bottom: var(--space-sm);
            position: relative;
            text-shadow: 0 0 40px rgba(240, 180, 41, 0.2);
        }

        .patrimoine-total .currency {
            font-size: var(--font-size-xl);
            color: var(--accent-primary);
            margin-left: var(--space-xs);
            font-weight: 400;
        }

        .patrimoine-invested {
            font-size: var(--font-size-base);
            color: var(--text-tertiary);
            margin-bottom: var(--space-sm);
            position: relative;
        }

        .patrimoine-gain {
            font-size: var(--font-size-xl);
            font-weight: 600;
            position: relative;
        }

        .patrimoine-gain.positive { color: var(--positive); }
        .patrimoine-gain.negative { color: var(--negative); }

        .patrimoine-metrics {
            display: flex;
            justify-content: center;
            gap: var(--space-2xl);
            margin-top: var(--space-xl);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-subtle);
            flex-wrap: wrap;
            position: relative;
        }

        .metric-box {
            text-align: center;
            min-width: 120px;
            padding: var(--space-sm);
        }

        .metric-box .label {
            font-size: var(--font-size-xs);
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: var(--space-xs);
        }

        .metric-box .value {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Asset Grid */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 900px) {
            .asset-grid { grid-template-columns: 1fr; }
            .patrimoine-total { font-size: 2.5rem; }
        }

        .asset-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }

        .asset-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .asset-card.livret::before { background: var(--info); }
        .asset-card.pea::before { background: var(--purple); }
        .asset-card.crypto::before { background: var(--orange); }

        .asset-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .asset-name {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .asset-alloc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .asset-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 0.25rem;
        }

        .asset-invested {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .asset-gain {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .asset-gain.positive { color: var(--success); }
        .asset-gain.negative { color: var(--danger); }

        .asset-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .asset-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .livret .asset-bar-fill { background: var(--info); }
        .pea .asset-bar-fill { background: var(--purple); }
        .crypto .asset-bar-fill { background: var(--orange); }

        /* Holdings Detail */
        .holdings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .holding-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
        }

        .holding-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .holding-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .holding-icon.btc { background: linear-gradient(135deg, #f7931a, #ffb74d); color: #000; }
        .holding-icon.eth { background: linear-gradient(135deg, #627eea, #a4b3f7); color: #fff; }
        .holding-icon.sp500 { background: linear-gradient(135deg, #a855f7, #c084fc); color: #fff; }
        .holding-icon.livret { background: linear-gradient(135deg, #00d9ff, #67e8f9); color: #000; }

        .holding-info { flex: 1; }
        .holding-name { font-weight: 600; color: var(--text-white); }
        .holding-ticker { font-size: 0.75rem; color: var(--text-dim); }

        .holding-value { text-align: right; }
        .holding-amount { font-weight: 600; color: var(--text-white); }
        .holding-change { font-size: 0.8rem; }
        .holding-change.up { color: var(--success); }
        .holding-change.down { color: var(--danger); }

        .holding-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .holding-stat {
            text-align: center;
        }

        .holding-stat .label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .holding-stat .value {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Buttons - Bloomberg Professional Style */
        .btn {
            font-family: var(--font-mono);
            font-size: var(--font-size-sm);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(240, 180, 41, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(240, 180, 41, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background: transparent;
            color: var(--negative);
            border-color: var(--negative);
        }

        .btn-danger:hover {
            background: var(--negative-dim);
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.2);
        }

        .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); }

        .btn-lg { padding: var(--space-md) var(--space-lg); font-size: var(--font-size-base); }

        /* Forms - Institutional Style */
        .form-group { margin-bottom: var(--space-md); }

        .form-label {
            display: block;
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: var(--space-sm);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: var(--space-md);
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-white);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            transition: var(--transition-fast);
        }

        .form-input:hover {
            border-color: var(--border-light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px rgba(240, 180, 41, 0.1);
            background: rgba(0, 0, 0, 0.4);
        }

        .form-input::placeholder {
            color: var(--text-dim);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-md);
        }

        .form-hint {
            font-size: var(--font-size-xs);
            color: var(--text-dim);
            margin-top: var(--space-xs);
        }

        /* Quick Add - Bloomberg Style */
        .quick-add {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(59, 130, 246, 0.08) 100%);
            border: 1px solid var(--info);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .quick-add-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-add-form {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .quick-add-form .form-group {
            flex: 1;
            min-width: 120px;
            margin-bottom: 0;
        }

        .quick-add-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .preview-item {
            text-align: center;
        }

        .preview-item .label {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .preview-item .value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .preview-item .sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Tables */
        .table-container { overflow-x: auto; }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .table th {
            text-align: left;
            padding: 0.75rem 1rem;
            color: var(--text-dim);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.7rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-white);
        }

        .table tr:hover td { background: var(--bg-card); }

        .table .positive { color: var(--success); }
        .table .negative { color: var(--danger); }
        .table .muted { color: var(--text-dim); }

        /* Charts */
        .chart-container {
            height: 300px;
            position: relative;
        }

        .chart-container.small { height: 200px; }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .grid-2 { grid-template-columns: 1fr; }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0.25rem;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body { padding: 1.5rem; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .alert-info { background: var(--info-dim); border: 1px solid var(--info); color: var(--info); }
        .alert-success { background: var(--success-dim); border: 1px solid var(--success); color: var(--success); }
        .alert-warning { background: var(--warning-dim); border: 1px solid var(--warning); color: var(--warning); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state .title {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .empty-state .desc {
            margin-bottom: 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
            font-size: 0.75rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        .keyboard-hint {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.75rem;
            opacity: 0.7;
        }

        .keyboard-hint kbd {
            background: var(--bg-secondary);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            border: 1px solid var(--border);
            font-family: var(--font-mono);
            font-size: 0.7rem;
        }

        /* Shortcuts Panel */
        .shortcuts-section {
            margin-bottom: 2rem;
        }

        .shortcuts-grid-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            padding: 0 1rem;
        }

        .shortcut-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .shortcut-card:hover {
            border-color: var(--text-secondary);
            transform: translateY(-2px);
        }

        .shortcut-card kbd {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            width: fit-content;
            min-width: 40px;
            box-shadow: 0 2px 0 var(--border);
        }

        .shortcut-card span {
            font-weight: 600;
            color: var(--text-white);
            font-size: 0.9rem;
        }

        .shortcut-card small {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeIn 0.3s ease; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse 2s infinite; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .live-indicator::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        /* ==================== MÃ‰TRIQUES PRO ==================== */
        .metrics-pro-section {
            margin: 1.5rem 0;
        }

        .metrics-pro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metrics-pro-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metrics-pro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
        }

        .metric-pro-card {
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .metric-pro-card:hover {
            border-color: var(--text-primary);
            box-shadow: var(--shadow-glow);
        }

        .metric-pro-card .metric-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .metric-pro-card .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .metric-pro-card .metric-value.positive { color: var(--success); }
        .metric-pro-card .metric-value.negative { color: var(--danger); }
        .metric-pro-card .metric-value.neutral { color: var(--text-secondary); }

        .metric-pro-card .metric-hint {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .metric-pro-card .metric-rating {
            display: inline-block;
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin-top: 0.35rem;
        }

        .metric-rating.excellent { background: var(--success-dim); color: var(--success); }
        .metric-rating.good { background: rgba(0, 217, 255, 0.15); color: var(--info); }
        .metric-rating.average { background: var(--warning-dim); color: var(--warning); }
        .metric-rating.poor { background: var(--danger-dim); color: var(--danger); }

        /* ==================== ALERTES ==================== */
        .alerts-container {
            margin-bottom: 1.5rem;
        }

        .alert-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .alert-card.high { border-left: 4px solid var(--danger); }
        .alert-card.medium { border-left: 4px solid var(--warning); }
        .alert-card.info { border-left: 4px solid var(--info); }

        .alert-card .alert-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .alert-card .alert-content { flex: 1; }
        .alert-card .alert-message { color: var(--text-white); font-size: 0.9rem; }
        .alert-card .alert-action { color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem; }

        .alert-card .alert-dismiss {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .alert-card .alert-dismiss:hover { color: var(--text-primary); }

        /* ==================== RÃ‰Ã‰QUILIBRAGE ==================== */
        .rebalance-suggestion {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px dashed var(--info);
            border-radius: var(--radius-md);
        }

        .suggestion-title {
            font-size: 0.8rem;
            color: var(--info);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .suggestion-amounts {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .suggestion-amounts strong {
            color: var(--text-secondary);
        }

        /* ==================== MODULE INTELLIGENCE ==================== */
        /* Score de Timing */
        .timing-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(0, 212, 170, 0.05) 100%);
            border: 1px solid var(--accent-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .timing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .timing-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timing-score-container {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .timing-score-circle {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .timing-score-circle svg {
            transform: rotate(-90deg);
            width: 120px;
            height: 120px;
        }

        .timing-score-circle .score-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }

        .timing-score-circle .score-fill {
            fill: none;
            stroke: var(--accent-primary);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 1s ease-out, stroke 0.3s ease;
        }

        .timing-score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .timing-score-value .score-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .timing-score-value .score-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .timing-recommendation {
            flex: 1;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .timing-recommendation .reco-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .timing-recommendation .reco-action {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 0.25rem;
        }

        .timing-recommendation .reco-message {
            font-size: 0.8rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        .timing-factors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-color);
        }

        .timing-factor {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
        }

        .timing-factor .factor-name {
            color: var(--text-dim);
        }

        .timing-factor .factor-value {
            font-weight: 600;
        }

        .timing-factor .factor-value.positive { color: var(--success); }
        .timing-factor .factor-value.negative { color: var(--danger); }
        .timing-factor .factor-value.neutral { color: var(--text-secondary); }

        .timing-last-update {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        /* Indicateurs Grid */
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .indicator-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .indicator-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .indicator-card .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .indicator-card .indicator-name {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .indicator-card .indicator-icon {
            font-size: 1rem;
        }

        .indicator-card .indicator-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .indicator-card .indicator-label {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            display: inline-block;
        }

        .indicator-card .indicator-label.fear { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .indicator-card .indicator-label.greed { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .indicator-card .indicator-label.neutral { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .indicator-card .indicator-label.bullish { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .indicator-card .indicator-label.bearish { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        .indicator-card .indicator-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .indicator-card .indicator-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* ==================== MODULE GAMIFICATION ==================== */
        .profile-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid rgba(168, 85, 247, 0.5);
        }

        .profile-info {
            flex: 1;
        }

        .profile-level {
            font-size: 0.75rem;
            color: #a855f7;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.25rem;
        }

        .profile-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .xp-bar-container {
            background: var(--bg-tertiary);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #a855f7 0%, #6366f1 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
            text-align: right;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .profile-stat .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Badges */
        .badges-section {
            margin-bottom: 1.5rem;
        }

        .badges-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }

        .badge-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .badge-item.unlocked {
            border-color: #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(168, 85, 247, 0.1) 100%);
        }

        .badge-item.unlocked .badge-icon {
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .badge-item.locked {
            opacity: 0.5;
            filter: grayscale(0.8);
            background: var(--bg-tertiary);
            border-style: dashed;
        }

        .badge-item.locked:hover {
            opacity: 0.7;
            filter: grayscale(0.5);
        }

        .badge-item .badge-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .badge-item.locked .badge-icon::after {
            content: 'ðŸ”’';
            font-size: 0.8rem;
            position: absolute;
            bottom: -5px;
            right: -10px;
        }

        .badge-item .badge-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .badge-item.unlocked .badge-name {
            color: #a855f7;
        }

        .badge-item .badge-desc {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        .badge-item.locked .badge-desc {
            font-style: italic;
        }

        .badge-item .badge-status {
            font-size: 0.6rem;
            margin-top: 0.5rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            display: inline-block;
        }

        .badge-item.unlocked .badge-status {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .badge-item.locked .badge-status {
            background: rgba(100, 100, 100, 0.2);
            color: var(--text-dim);
        }

        /* Streaks */
        .streaks-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .streak-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: center;
        }

        .streak-card .streak-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .streak-card .streak-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .streak-card .streak-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .streak-card .streak-best {
            font-size: 0.7rem;
            color: var(--accent-primary);
            margin-top: 0.25rem;
        }

        /* XP Popup Animation */
        .xp-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: var(--radius-lg);
            font-size: 1.25rem;
            font-weight: 700;
            z-index: 1000;
            pointer-events: none;
            animation: xpPopup 1.5s ease forwards;
        }

        @keyframes xpPopup {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -80%) scale(0.8); opacity: 0; }
        }

        /* Level Up Modal */
        .levelup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .levelup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .levelup-content {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(168, 85, 247, 0.2) 100%);
            border: 2px solid #a855f7;
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .levelup-overlay.active .levelup-content {
            transform: scale(1);
        }

        .levelup-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: levelupBounce 0.5s ease infinite alternate;
        }

        @keyframes levelupBounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .levelup-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #a855f7;
            margin-bottom: 0.5rem;
        }

        .levelup-level {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .levelup-close {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .levelup-close:hover {
            transform: scale(1.05);
        }

        /* ==================== TOOLTIPS PÃ‰DAGOGIQUES ==================== */
        .tooltip-trigger {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 0.4rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }

        .tooltip-trigger:hover {
            background: var(--info-dim);
            border-color: var(--info);
            color: var(--info);
        }

        .tooltip-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .tooltip-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0;
            max-width: 520px;
            width: 92%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .tooltip-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .tooltip-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1.25rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .tooltip-emoji {
            font-size: 1.5rem;
        }

        .tooltip-header h4 {
            flex: 1;
            font-size: 1rem;
            color: var(--text-white);
            margin: 0;
        }

        .tooltip-close {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .tooltip-close:hover {
            color: var(--danger);
        }

        .tooltip-section {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .tooltip-section:last-child {
            border-bottom: none;
        }

        .tooltip-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .tooltip-section p {
            color: var(--text-dim);
            font-size: 0.85rem;
            line-height: 1.6;
            margin: 0;
        }

        .formula-box {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
        }

        .formula-box code {
            display: block;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: var(--font-mono);
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .formula-legend {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .formula-legend span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .interpretation-scale {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .scale-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
        }

        .scale-item.excellent { background: var(--success-dim); border-left: 3px solid var(--success); }
        .scale-item.good { background: var(--info-dim); border-left: 3px solid var(--info); }
        .scale-item.ok { background: var(--warning-dim); border-left: 3px solid var(--warning); }
        .scale-item.bad { background: var(--danger-dim); border-left: 3px solid var(--danger); }

        .scale-item .range {
            font-weight: 600;
            color: var(--text-white);
            min-width: 100px;
        }

        .scale-item .label {
            color: var(--text-dim);
            flex: 1;
        }

        .scale-item .note {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .example-box {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.6;
        }

        .pro-tip {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(0, 217, 255, 0.1));
        }

        .pro-tip p {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* ==================== MONTE CARLO ==================== */
        .monte-carlo-card {
            border: 1px solid var(--info);
        }

        .mc-config {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .form-select-sm {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.4rem 0.75rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }

        .mc-advanced-params {
            padding: 1rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .mc-advanced-params summary {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .param-group label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }

        .param-group input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.4rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .mc-results {
            padding: 1rem;
        }

        .mc-params-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            margin: 1rem;
            border-radius: var(--radius-md);
        }

        .mc-params-grid .form-group {
            margin-bottom: 0;
        }

        .mc-params-grid .form-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }

        .mc-params-grid .form-input {
            padding: 0.4rem 0.5rem;
            font-size: 0.85rem;
        }

        .mc-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-dim);
        }

        .mc-loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .mc-stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }

        .mc-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .mc-stat-value.success { color: var(--success); }
        .mc-stat-value.danger { color: var(--danger); }

        .mc-probability-bars {
            display: grid;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-primary);
            margin: 0 1rem 1rem 1rem;
            border-radius: var(--radius-md);
        }

        .prob-item {
            display: grid;
            grid-template-columns: 120px 1fr 50px;
            align-items: center;
            gap: 1rem;
        }

        .prob-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .prob-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: right;
        }

        .prob-bar.gain20 { background: var(--success); }
        .prob-bar.gain50 { background: var(--info); }

        .mc-chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1.5rem;
        }

        .mc-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mc-stat {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .mc-stat .label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }

        .mc-stat .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .mc-stat .value.positive { color: var(--success); }
        .mc-stat .value.negative { color: var(--danger); }

        .mc-probabilities {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: var(--radius-md);
        }

        .mc-probabilities h5 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .prob-bar-container {
            display: flex;
            height: 30px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: var(--bg-primary);
        }

        .prob-bar {
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .prob-bar.loss50 { background: var(--danger); }
        .prob-bar.loss20 { background: var(--warning); }
        .prob-bar.profit { background: var(--success); }
        .prob-bar.double { background: var(--info); }

        .prob-legend {
            display: flex;
            justify-content: space-around;
            margin-top: 0.75rem;
            font-size: 0.7rem;
        }

        .prob-legend span { display: flex; align-items: center; gap: 0.3rem; }
        .prob-legend .loss50::before { content: ''; width: 10px; height: 10px; background: var(--danger); border-radius: 2px; }
        .prob-legend .loss20::before { content: ''; width: 10px; height: 10px; background: var(--warning); border-radius: 2px; }
        .prob-legend .profit::before { content: ''; width: 10px; height: 10px; background: var(--success); border-radius: 2px; }
        .prob-legend .double::before { content: ''; width: 10px; height: 10px; background: var(--info); border-radius: 2px; }

        /* ==================== STRESS TEST ==================== */
        .stress-test-card {
            border: 1px solid var(--warning);
        }

        .stress-scenarios {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stress-scenario-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .stress-scenario-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        .stress-scenario-btn.active {
            border-color: var(--warning);
            background: var(--warning-dim);
            color: var(--warning);
        }

        .stress-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .stress-btn:hover {
            border-color: var(--warning);
            background: rgba(255, 170, 0, 0.1);
            transform: translateY(-2px);
        }

        .stress-icon {
            font-size: 1.5rem;
        }

        .stress-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .stress-impact {
            font-size: 0.75rem;
            color: var(--danger);
            font-weight: 600;
        }

        .stress-results {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: var(--radius-md);
            margin-top: 1rem;
            border: 1px solid var(--border);
        }

        .stress-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .stress-result-header span:first-child {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .stress-date {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .stress-result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stress-result-item {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .stress-result-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }

        .stress-result-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .stress-result-value.danger {
            color: var(--danger);
        }

        .stress-asset-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .stress-asset-item .asset-name {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .stress-asset-item .asset-impact {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stress-result {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: var(--radius-md);
        }

        .stress-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stress-result-loss {
            font-size: 2rem;
            font-weight: 700;
            color: var(--danger);
        }

        .stress-breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stress-breakdown-item {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .stress-breakdown-item .asset {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }

        .stress-breakdown-item .impact {
            font-weight: 600;
        }

        /* ==================== CALCULATEURS PRO ==================== */
        .calculators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .calc-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .calc-card-header {
            padding: 1rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .calc-card-header h4 {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-white);
            margin: 0;
        }

        .calc-card-body {
            padding: 1rem;
        }

        .calc-result {
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }

        .calc-result .main-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .calc-result .sub-value {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }

        .calc-details {
            display: grid;
            gap: 0.5rem;
        }

        .calc-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }

        .calc-detail-row .label {
            color: var(--text-dim);
        }

        .calc-detail-row .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .calc-main-value {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }

        .calc-main-value .calc-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .calc-main-value .calc-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--success);
        }

        .calc-main-value .calc-value.danger {
            color: var(--danger);
        }

        .calc-sub-values {
            display: grid;
            gap: 0.5rem;
        }

        .calc-sub {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .calc-sub-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .calc-sub-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .calc-sub-value.danger {
            color: var(--danger);
        }

        /* ==================== KEYBOARD HELP ==================== */
        .keyboard-help {
            max-width: 400px;
        }

        .shortcuts-grid {
            display: grid;
            gap: 0.5rem;
            padding: 1rem;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
        }

        .shortcut-item kbd {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-primary);
            min-width: 30px;
            text-align: center;
        }

        .shortcut-item span {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        /* Keyboard hint in header */
        .keyboard-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .keyboard-hint:hover {
            color: var(--text-primary);
        }

        /* ============================================
           SYNC INDICATOR
           ============================================ */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-elevated, #1e1e2a);
            border: 1px solid var(--border, #2a2a3a);
            border-radius: 20px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            color: var(--text-secondary, #a0a0a8);
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .sync-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .sync-indicator.synced {
            color: var(--positive, #00d47e);
            border-color: var(--positive, #00d47e);
        }

        .sync-indicator.syncing {
            color: var(--accent-primary, #f0b429);
            border-color: var(--accent-primary, #f0b429);
        }

        .sync-indicator.offline {
            color: var(--negative, #ff4757);
            border-color: var(--negative, #ff4757);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            flex-shrink: 0;
        }

        .sync-indicator.syncing .sync-dot {
            animation: syncPulse 1s ease-in-out infinite;
        }

        @keyframes syncPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">OC</div>
            <div class="logo-text">TRACKER <span>PRO</span></div>
        </div>
        <div class="header-prices">
            <div class="price-badge">
                <div class="icon btc">B</div>
                <span class="value" id="headerBtc">--</span>
                <span class="change up" id="headerBtcChange">--</span>
            </div>
            <div class="price-badge">
                <div class="icon eth">E</div>
                <span class="value" id="headerEth">--</span>
                <span class="change up" id="headerEthChange">--</span>
            </div>
            <div class="price-badge">
                <div class="icon sp500">S</div>
                <span class="value" id="headerSp500">--</span>
                <span class="change up" id="headerSp500Change">--</span>
            </div>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshPrices()" title="Actualiser les cours">
                &#8635;
            </button>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <button class="nav-tab active" onclick="showPanel('dashboard')">Dashboard</button>
        <button class="nav-tab" onclick="showPanel('trackrecord')">Track Record</button>
        <button class="nav-tab" onclick="showPanel('transactions')">Transactions</button>
        <button class="nav-tab" onclick="showPanel('analytics')">Analytics</button>
        <button class="nav-tab" onclick="showPanel('settings')">Parametres</button>
        <button class="nav-tab" onclick="showPanel('shortcuts')">âŒ¨ï¸ Raccourcis</button>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- ==================== DASHBOARD ==================== -->
        <div class="panel active" id="panel-dashboard">
            <!-- Alertes -->
            <div class="alerts-container" id="alertsContainer"></div>

            <!-- Quick Add Versement -->
            <div class="quick-add fade-in">
                <div class="quick-add-title">
                    <span>+ Nouveau Versement Mensuel</span>
                    <span class="live-indicator">Prix en direct</span>
                </div>
                <div class="quick-add-form">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="quickDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Livret A</label>
                        <input type="number" class="form-input" id="quickLivret" value="300" step="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">PEA (S&P 500)</label>
                        <input type="number" class="form-input" id="quickPea" value="350" step="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bitcoin</label>
                        <input type="number" class="form-input" id="quickBtc" value="105" step="5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ethereum</label>
                        <input type="number" class="form-input" id="quickEth" value="45" step="5">
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="addVersement()">Ajouter</button>
                </div>
                <div class="quick-add-preview" id="quickPreview">
                    <div class="preview-item">
                        <div class="label">Total</div>
                        <div class="value" id="previewTotal">800 EUR</div>
                    </div>
                    <div class="preview-item">
                        <div class="label">BTC a acheter</div>
                        <div class="value" id="previewBtcQty">--</div>
                        <div class="sub" id="previewBtcPrice">@ -- EUR</div>
                    </div>
                    <div class="preview-item">
                        <div class="label">ETH a acheter</div>
                        <div class="value" id="previewEthQty">--</div>
                        <div class="sub" id="previewEthPrice">@ -- EUR</div>
                    </div>
                    <div class="preview-item">
                        <div class="label">Parts ETF</div>
                        <div class="value" id="previewSpQty">--</div>
                        <div class="sub" id="previewSpPrice">@ -- EUR</div>
                    </div>
                </div>
                <!-- Suggestion rÃ©Ã©quilibrage -->
                <div class="rebalance-suggestion" id="rebalanceSuggestion" style="display: none;">
                    <div class="suggestion-title">Suggestion pour reequilibrer :</div>
                    <div class="suggestion-amounts">
                        <span>Livret A: <strong id="suggestLivret">--</strong></span>
                        <span>PEA: <strong id="suggestPea">--</strong></span>
                        <span>BTC: <strong id="suggestBtc">--</strong></span>
                        <span>ETH: <strong id="suggestEth">--</strong></span>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="applySuggestion()" style="margin-top: 0.75rem;">Appliquer</button>
                </div>
            </div>

            <!-- ==================== MODULE INTELLIGENCE ==================== -->
            <!-- Score de Timing -->
            <div class="timing-card fade-in" id="timingCard" style="display: none;">
                <div class="timing-header">
                    <div class="timing-title">
                        <span>ðŸŽ¯</span> Score de Timing
                    </div>
                    <div class="timing-last-update" id="timingLastUpdate">--</div>
                </div>
                <div class="timing-score-container">
                    <div class="timing-score-circle">
                        <svg viewBox="0 0 120 120">
                            <circle class="score-bg" cx="60" cy="60" r="54"></circle>
                            <circle class="score-fill" id="scoreCircleFill" cx="60" cy="60" r="54"></circle>
                        </svg>
                        <div class="timing-score-value">
                            <div class="score-number" id="timingScoreValue">--</div>
                            <div class="score-label">/ 100</div>
                        </div>
                    </div>
                    <div class="timing-recommendation">
                        <div class="reco-emoji" id="recoEmoji">ðŸ”„</div>
                        <div class="reco-action" id="recoAction">Chargement...</div>
                        <div class="reco-message" id="recoMessage">Analyse des indicateurs en cours</div>
                    </div>
                </div>
                <div class="timing-factors" id="timingFactors">
                    <!-- Facteurs gÃ©nÃ©rÃ©s dynamiquement -->
                </div>
            </div>

            <!-- Indicateurs de MarchÃ© -->
            <div class="indicators-grid" id="indicatorsGrid" style="display: none;">
                <!-- Fear & Greed -->
                <div class="indicator-card">
                    <div class="indicator-header">
                        <span class="indicator-name">Fear & Greed <button class="tooltip-trigger" onclick="showTooltip('fearGreed')">â“˜</button></span>
                        <span class="indicator-icon">ðŸ˜±</span>
                    </div>
                    <div class="indicator-value" id="fgValue">--</div>
                    <div class="indicator-label neutral" id="fgLabel">--</div>
                    <div class="indicator-bar">
                        <div class="indicator-bar-fill" id="fgBar" style="width: 50%; background: var(--warning);"></div>
                    </div>
                </div>
                <!-- RSI BTC -->
                <div class="indicator-card">
                    <div class="indicator-header">
                        <span class="indicator-name">RSI 14 (BTC) <button class="tooltip-trigger" onclick="showTooltip('rsi')">â“˜</button></span>
                        <span class="indicator-icon">ðŸ“Š</span>
                    </div>
                    <div class="indicator-value" id="rsiValue">--</div>
                    <div class="indicator-label neutral" id="rsiLabel">--</div>
                    <div class="indicator-bar">
                        <div class="indicator-bar-fill" id="rsiBar" style="width: 50%; background: var(--warning);"></div>
                    </div>
                </div>
                <!-- MA 50 -->
                <div class="indicator-card">
                    <div class="indicator-header">
                        <span class="indicator-name">MA 50j (BTC) <button class="tooltip-trigger" onclick="showTooltip('ma50')">â“˜</button></span>
                        <span class="indicator-icon">ðŸ“ˆ</span>
                    </div>
                    <div class="indicator-value" id="ma50Value">--</div>
                    <div class="indicator-label neutral" id="ma50Label">--</div>
                </div>
                <!-- MA 200 -->
                <div class="indicator-card">
                    <div class="indicator-header">
                        <span class="indicator-name">MA 200j (BTC) <button class="tooltip-trigger" onclick="showTooltip('ma200')">â“˜</button></span>
                        <span class="indicator-icon">ðŸ“‰</span>
                    </div>
                    <div class="indicator-value" id="ma200Value">--</div>
                    <div class="indicator-label neutral" id="ma200Label">--</div>
                </div>
                <!-- Tendance -->
                <div class="indicator-card">
                    <div class="indicator-header">
                        <span class="indicator-name">Tendance <button class="tooltip-trigger" onclick="showTooltip('tendance')">â“˜</button></span>
                        <span class="indicator-icon">ðŸ§­</span>
                    </div>
                    <div class="indicator-value" id="trendValue">--</div>
                    <div class="indicator-label neutral" id="trendLabel">--</div>
                </div>
            </div>

            <!-- Patrimoine Hero -->
            <div class="patrimoine-hero card fade-in" id="patrimoineHero" style="display: none;">
                <div class="patrimoine-label">Patrimoine Total</div>
                <div class="patrimoine-total">
                    <span id="totalValue">0</span>
                    <span class="currency">EUR</span>
                </div>
                <div class="patrimoine-invested">
                    Investi: <span id="totalInvested">0 EUR</span>
                </div>
                <div class="patrimoine-gain positive" id="totalGain">
                    +0 EUR (+0.00%)
                </div>
                <div class="patrimoine-metrics">
                    <div class="metric-box">
                        <div class="label">Performance</div>
                        <div class="value" id="perfPercent">0%</div>
                    </div>
                    <div class="metric-box">
                        <div class="label">Mois de suivi</div>
                        <div class="value" id="trackingMonths">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="label">Versements</div>
                        <div class="value" id="nbVersements">0</div>
                    </div>
                </div>
            </div>

            <!-- ==================== MODULE GAMIFICATION ==================== -->
            <!-- Profil Investisseur -->
            <div class="profile-card fade-in" id="profileCard">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">ðŸŒ±</div>
                    <div class="profile-info">
                        <div class="profile-level" id="profileLevel">NIVEAU 1</div>
                        <div class="profile-title" id="profileTitle">Debutant</div>
                        <div class="xp-bar-container">
                            <div class="xp-bar-fill" id="xpBarFill" style="width: 0%;"></div>
                        </div>
                        <div class="xp-text" id="xpText">0 / 100 XP</div>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="stat-value" id="statContributions">0</div>
                        <div class="stat-label">Versements</div>
                    </div>
                    <div class="profile-stat">
                        <div class="stat-value" id="statSnapshots">0</div>
                        <div class="stat-label">Snapshots</div>
                    </div>
                    <div class="profile-stat">
                        <div class="stat-value" id="statBadges">0/20</div>
                        <div class="stat-label">Badges</div>
                    </div>
                </div>
            </div>

            <!-- Streaks -->
            <div class="streaks-container fade-in" id="streaksContainer">
                <div class="streak-card">
                    <div class="streak-icon">ðŸ”¥</div>
                    <div class="streak-value" id="dcaStreakValue">0</div>
                    <div class="streak-label">Streak DCA</div>
                    <div class="streak-best" id="dcaStreakBest">Record: 0</div>
                </div>
                <div class="streak-card">
                    <div class="streak-icon">ðŸ“¸</div>
                    <div class="streak-value" id="snapStreakValue">0</div>
                    <div class="streak-label">Streak Snapshots</div>
                    <div class="streak-best" id="snapStreakBest">Record: 0</div>
                </div>
            </div>

            <!-- Badges -->
            <div class="badges-section fade-in" id="badgesSection">
                <div class="badges-title">
                    <span>ðŸ†</span> Collection de Badges
                </div>
                <div class="badges-grid" id="badgesGrid">
                    <!-- Badges gÃ©nÃ©rÃ©s dynamiquement -->
                </div>
            </div>

            <!-- Level Up Modal -->
            <div class="levelup-overlay" id="levelupOverlay" onclick="closeLevelUp()">
                <div class="levelup-content" onclick="event.stopPropagation()">
                    <div class="levelup-icon" id="levelupIcon">ðŸŽ‰</div>
                    <div class="levelup-title">NIVEAU SUPERIEUR!</div>
                    <div class="levelup-level" id="levelupLevel">Niveau 2 - Apprenti</div>
                    <button class="levelup-close" onclick="closeLevelUp()">Continuer</button>
                </div>
            </div>

            <!-- Contexte Macro -->
            <div class="card fade-in" id="macroSection" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Contexte Macroeconomique</div>
                    <button class="btn btn-sm btn-secondary" onclick="refreshMacro()">Actualiser</button>
                </div>
                <div class="holdings-grid" style="grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));">
                    <div class="holding-card">
                        <div class="holding-stat">
                            <div class="label">Fear & Greed</div>
                            <div class="value" id="macroFearGreed">--</div>
                            <div class="sub" id="macroFGLabel">--</div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-stat">
                            <div class="label">BTC Dominance</div>
                            <div class="value" id="macroBTCDom">--%</div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-stat">
                            <div class="label">Crypto MCap</div>
                            <div class="value" id="macroCryptoMcap">--</div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-stat">
                            <div class="label">BTC 24h</div>
                            <div class="value" id="macroBTC24h">--%</div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-stat">
                            <div class="label">ETH 24h</div>
                            <div class="value" id="macroETH24h">--%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MÃ©triques Pro -->
            <div class="metrics-pro-section" id="metricsProSection" style="display: none;">
                <div class="metrics-pro-header">
                    <div class="metrics-pro-title">
                        <span>ðŸ“Š</span> MÃ©triques de Performance Professionnelles
                    </div>
                    <span class="live-indicator">Track Record</span>
                </div>
                <div class="metrics-pro-grid">
                    <div class="metric-pro-card">
                        <div class="metric-label">TWR <button class="tooltip-trigger" onclick="showTooltip('twr')">â“˜</button></div>
                        <div class="metric-value" id="metricTWR">+0.00%</div>
                        <div class="metric-hint">Performance pure</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">MWR / TRI <button class="tooltip-trigger" onclick="showTooltip('mwr')">â“˜</button></div>
                        <div class="metric-value" id="metricMWR">+0.00%</div>
                        <div class="metric-hint">Rendement investisseur</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">Sharpe <button class="tooltip-trigger" onclick="showTooltip('sharpe')">â“˜</button></div>
                        <div class="metric-value" id="metricSharpe">0.00</div>
                        <div class="metric-hint">Rendement/Risque</div>
                        <div class="metric-rating" id="sharpeRating">--</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">Sortino <button class="tooltip-trigger" onclick="showTooltip('sortino')">â“˜</button></div>
                        <div class="metric-value" id="metricSortino">0.00</div>
                        <div class="metric-hint">Rendement/Downside</div>
                        <div class="metric-rating" id="sortinoRating">--</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">Max Drawdown <button class="tooltip-trigger" onclick="showTooltip('maxdrawdown')">â“˜</button></div>
                        <div class="metric-value negative" id="metricMaxDD">-0.00%</div>
                        <div class="metric-hint">Pire baisse</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">VolatilitÃ© <button class="tooltip-trigger" onclick="showTooltip('volatility')">â“˜</button></div>
                        <div class="metric-value" id="metricVolatility">0.00%</div>
                        <div class="metric-hint">AnnualisÃ©e</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">Calmar <button class="tooltip-trigger" onclick="showTooltip('calmar')">â“˜</button></div>
                        <div class="metric-value" id="metricCalmar">0.00</div>
                        <div class="metric-hint">Return/MaxDD</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">Win Rate <button class="tooltip-trigger" onclick="showTooltip('winrate')">â“˜</button></div>
                        <div class="metric-value" id="metricWinRate">0%</div>
                        <div class="metric-hint">% Mois positifs</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">Alpha <button class="tooltip-trigger" onclick="showTooltip('alpha')">â“˜</button></div>
                        <div class="metric-value" id="metricAlpha">--</div>
                        <div class="metric-hint">Surperformance</div>
                        <div class="metric-rating" id="alphaRating">--</div>
                    </div>
                    <div class="metric-pro-card">
                        <div class="metric-label">Beta <button class="tooltip-trigger" onclick="showTooltip('beta')">â“˜</button></div>
                        <div class="metric-value" id="metricBeta">--</div>
                        <div class="metric-hint">Sensibilite marche</div>
                        <div class="metric-rating" id="betaRating">--</div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="icon">ðŸ“Š</div>
                <div class="title">Commencez votre suivi</div>
                <div class="desc">Ajoutez votre premier versement ci-dessus pour commencer a suivre votre patrimoine en temps reel.</div>
            </div>

            <!-- Asset Grid -->
            <div class="asset-grid" id="assetGrid" style="display: none;">
                <div class="asset-card livret">
                    <div class="asset-header">
                        <div class="asset-name">Livret A</div>
                        <div class="asset-alloc" id="livretAlloc">0%</div>
                    </div>
                    <div class="asset-value" id="livretValue">0 EUR</div>
                    <div class="asset-invested" id="livretInvested">Investi: 0 EUR</div>
                    <div class="asset-gain positive" id="livretGain">+0 EUR</div>
                    <div class="asset-bar">
                        <div class="asset-bar-fill" id="livretBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="asset-card pea">
                    <div class="asset-header">
                        <div class="asset-name">PEA - S&P 500</div>
                        <div class="asset-alloc" id="peaAlloc">0%</div>
                    </div>
                    <div class="asset-value" id="peaValue">0 EUR</div>
                    <div class="asset-invested" id="peaInvested">Investi: 0 EUR</div>
                    <div class="asset-gain positive" id="peaGain">+0 EUR</div>
                    <div class="asset-bar">
                        <div class="asset-bar-fill" id="peaBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="asset-card crypto">
                    <div class="asset-header">
                        <div class="asset-name">Crypto</div>
                        <div class="asset-alloc" id="cryptoAlloc">0%</div>
                    </div>
                    <div class="asset-value" id="cryptoValue">0 EUR</div>
                    <div class="asset-invested" id="cryptoInvested">Investi: 0 EUR</div>
                    <div class="asset-gain positive" id="cryptoGain">+0 EUR</div>
                    <div class="asset-bar">
                        <div class="asset-bar-fill" id="cryptoBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Holdings Detail -->
            <div class="card" id="holdingsCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Detail des Positions</div>
                    <span class="live-indicator">Temps reel</span>
                </div>
                <div class="holdings-grid">
                    <div class="holding-card">
                        <div class="holding-header">
                            <div class="holding-icon livret">L</div>
                            <div class="holding-info">
                                <div class="holding-name">Livret A</div>
                                <div class="holding-ticker">Epargne securisee</div>
                            </div>
                            <div class="holding-value">
                                <div class="holding-amount" id="holdLivretValue">0 EUR</div>
                                <div class="holding-change up" id="holdLivretChange">+3%/an</div>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="label">Investi</div>
                                <div class="value" id="holdLivretInv">0 EUR</div>
                            </div>
                            <div class="holding-stat">
                                <div class="label">Interets</div>
                                <div class="value" id="holdLivretInt">0 EUR</div>
                            </div>
                        </div>
                    </div>

                    <div class="holding-card">
                        <div class="holding-header">
                            <div class="holding-icon sp500">S</div>
                            <div class="holding-info">
                                <div class="holding-name">ETF S&P 500</div>
                                <div class="holding-ticker">BNP Easy - Trade Republic</div>
                            </div>
                            <div class="holding-value">
                                <div class="holding-amount" id="holdSpValue">0 EUR</div>
                                <div class="holding-change up" id="holdSpChange">--</div>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="label">Parts</div>
                                <div class="value" id="holdSpQty">0</div>
                            </div>
                            <div class="holding-stat">
                                <div class="label">PRU</div>
                                <div class="value" id="holdSpPru">-- EUR</div>
                            </div>
                        </div>
                    </div>

                    <div class="holding-card">
                        <div class="holding-header">
                            <div class="holding-icon btc">B</div>
                            <div class="holding-info">
                                <div class="holding-name">Bitcoin</div>
                                <div class="holding-ticker">BTC - Binance</div>
                            </div>
                            <div class="holding-value">
                                <div class="holding-amount" id="holdBtcValue">0 EUR</div>
                                <div class="holding-change up" id="holdBtcChange">--</div>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="label">Quantite</div>
                                <div class="value" id="holdBtcQty">0 BTC</div>
                            </div>
                            <div class="holding-stat">
                                <div class="label">PRU</div>
                                <div class="value" id="holdBtcPru">-- EUR</div>
                            </div>
                        </div>
                    </div>

                    <div class="holding-card">
                        <div class="holding-header">
                            <div class="holding-icon eth">E</div>
                            <div class="holding-info">
                                <div class="holding-name">Ethereum</div>
                                <div class="holding-ticker">ETH - Binance</div>
                            </div>
                            <div class="holding-value">
                                <div class="holding-amount" id="holdEthValue">0 EUR</div>
                                <div class="holding-change up" id="holdEthChange">--</div>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="label">Quantite</div>
                                <div class="value" id="holdEthQty">0 ETH</div>
                            </div>
                            <div class="holding-stat">
                                <div class="label">PRU</div>
                                <div class="value" id="holdEthPru">-- EUR</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid-2" id="chartsSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Evolution du Patrimoine</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Allocation Actuelle</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TRANSACTIONS ==================== -->
        <div class="panel" id="panel-transactions">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Historique des Versements</div>
                    <button class="btn btn-secondary btn-sm" onclick="exportCSV()">Exporter CSV</button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Livret A</th>
                                <th>PEA</th>
                                <th>BTC</th>
                                <th>ETH</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <tr>
                                <td colspan="7" class="muted" style="text-align: center;">Aucune transaction</td>
                            </tr>
                        </tbody>
                        <tfoot id="transactionsFoot" style="display: none;">
                            <tr style="background: var(--bg-secondary);">
                                <td><strong>TOTAL</strong></td>
                                <td id="footLivret">--</td>
                                <td id="footPea">--</td>
                                <td id="footBtc">--</td>
                                <td id="footEth">--</td>
                                <td id="footTotal">--</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Holdings Acquired -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Actifs Acquis (Cumul)</div>
                </div>
                <div class="holdings-grid">
                    <div class="holding-card">
                        <div class="holding-header">
                            <div class="holding-icon btc">B</div>
                            <div class="holding-info">
                                <div class="holding-name">Bitcoin</div>
                                <div class="holding-ticker">Total accumule</div>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="label">Quantite</div>
                                <div class="value" id="totalBtcQty">0.00000 BTC</div>
                            </div>
                            <div class="holding-stat">
                                <div class="label">Investi</div>
                                <div class="value" id="totalBtcInv">0 EUR</div>
                            </div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-header">
                            <div class="holding-icon eth">E</div>
                            <div class="holding-info">
                                <div class="holding-name">Ethereum</div>
                                <div class="holding-ticker">Total accumule</div>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="label">Quantite</div>
                                <div class="value" id="totalEthQty">0.0000 ETH</div>
                            </div>
                            <div class="holding-stat">
                                <div class="label">Investi</div>
                                <div class="value" id="totalEthInv">0 EUR</div>
                            </div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-header">
                            <div class="holding-icon sp500">S</div>
                            <div class="holding-info">
                                <div class="holding-name">ETF S&P 500</div>
                                <div class="holding-ticker">Total accumule</div>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="label">Parts</div>
                                <div class="value" id="totalSpQty">0.000</div>
                            </div>
                            <div class="holding-stat">
                                <div class="label">Investi</div>
                                <div class="value" id="totalSpInv">0 EUR</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TRACK RECORD ==================== -->
        <div class="panel" id="panel-trackrecord">
            <!-- Track Record Hero -->
            <div class="card" style="background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0, 217, 255, 0.05) 100%); border-color: var(--info);">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem;">
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--info); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 0.5rem;">OLYMPUS CAPITAL - TRACK RECORD PERSONNEL</div>
                        <div style="font-size: 1.1rem; color: var(--text-white);">
                            <span id="trStartDate">--/--/----</span> â†’ <span id="trEndDate">--/--/----</span>
                            <span style="color: var(--text-muted); margin-left: 0.5rem;">(<span id="trMonths">0</span> mois)</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="exportPDF()">Exporter PDF</button>
                </div>
            </div>

            <!-- Tableau de synthÃ¨se -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Synthese Performance</div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Metrique</th>
                                <th>Valeur</th>
                                <th>Benchmark</th>
                                <th>Commentaire</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Performance cumulee</td>
                                <td id="trPerfCum" class="positive">+0.00%</td>
                                <td>S&P 500</td>
                                <td id="trAlphaCum">--</td>
                            </tr>
                            <tr>
                                <td>Performance annualisee</td>
                                <td id="trPerfAnn">+0.00%</td>
                                <td>~10%/an</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>Volatilite annualisee</td>
                                <td id="trVolatility">0.00%</td>
                                <td>~15%</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>Sharpe Ratio</td>
                                <td id="trSharpe">0.00</td>
                                <td>0.5-0.8</td>
                                <td id="trSharpeComment">--</td>
                            </tr>
                            <tr>
                                <td>Sortino Ratio</td>
                                <td id="trSortino">0.00</td>
                                <td>0.7-1.0</td>
                                <td id="trSortinoComment">--</td>
                            </tr>
                            <tr>
                                <td>Maximum Drawdown</td>
                                <td id="trMaxDD" class="negative">-0.00%</td>
                                <td>--</td>
                                <td>Pire baisse</td>
                            </tr>
                            <tr>
                                <td>% Mois positifs</td>
                                <td id="trWinRate">0%</td>
                                <td>55-60%</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>Meilleur mois</td>
                                <td id="trBestMonth" class="positive">+0.00%</td>
                                <td>--</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>Pire mois</td>
                                <td id="trWorstMonth" class="negative">-0.00%</td>
                                <td>--</td>
                                <td>--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Graphiques Track Record -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance Mensuelle</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trMonthlyPerfChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Historique Drawdown</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trDrawdownChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Benchmark vs S&P 500 -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Performance vs Benchmark (S&P 500)</div>
                    <div id="alphaDisplay" style="font-size: 0.85rem; color: var(--success);">Alpha: --</div>
                </div>
                <div class="chart-container">
                    <canvas id="benchmarkChart"></canvas>
                </div>
            </div>

            <!-- Objectif SMART -->
            <div class="card" style="border-color: var(--gold);">
                <div class="card-header">
                    <div class="card-title" style="color: var(--gold);">Objectif Formation CGP</div>
                    <div style="font-size: 0.75rem; color: var(--text-dim);">Echeance : Janvier 2027</div>
                </div>
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--text-white);">
                        <span id="objCurrent">0</span> <span style="color: var(--text-muted); font-size: 1rem;">/ 5 000 EUR</span>
                    </div>
                    <div style="margin: 1.5rem 0;">
                        <div style="height: 12px; background: var(--border); border-radius: 6px; overflow: hidden;">
                            <div id="objProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--gold), var(--warning)); width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);"><span id="objProgressPercent">0</span>% atteint</div>
                    </div>
                    <div class="holdings-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="holding-card">
                            <div class="holding-stat">
                                <div class="label">Mois restants</div>
                                <div class="value" id="objMonthsLeft">15</div>
                            </div>
                        </div>
                        <div class="holding-card">
                            <div class="holding-stat">
                                <div class="label">Versement/mois requis</div>
                                <div class="value" id="objMonthlyRequired">333 EUR</div>
                            </div>
                        </div>
                        <div class="holding-card">
                            <div class="holding-stat">
                                <div class="label">Statut</div>
                                <div class="value" id="objStatus" style="color: var(--success);">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============ MONTE CARLO ELITE ============ -->
            <div class="card mc-card">
                <div class="card-header">
                    <div class="card-title">
                        ðŸŽ² Monte Carlo GBM
                        <button class="tooltip-trigger" onclick="showTooltip('montecarlo')">â“˜</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="mcSimulations" class="form-input" style="width: auto; padding: 0.25rem 0.5rem;">
                            <option value="1000">1K sims</option>
                            <option value="5000">5K sims</option>
                            <option value="10000" selected>10K sims</option>
                            <option value="50000">50K sims</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="runAdvancedMonteCarlo()">
                            â–¶ Simuler
                        </button>
                    </div>
                </div>

                <!-- ParamÃ¨tres avancÃ©s -->
                <div class="mc-params-grid">
                    <div class="form-group">
                        <label class="form-label">Horizon (mois)</label>
                        <input type="number" class="form-input" id="mcHorizon" value="24" min="1" max="120">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Versement mensuel (â‚¬)</label>
                        <input type="number" class="form-input" id="mcContribution" value="800" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Niveau confiance (%)</label>
                        <input type="number" class="form-input" id="mcConfidence" value="95" min="80" max="99">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Drift ajustement (%)</label>
                        <input type="number" class="form-input" id="mcDrift" value="0" step="0.1">
                    </div>
                </div>

                <!-- Fan Chart -->
                <div class="mc-chart-container">
                    <canvas id="mcFanChart"></canvas>
                    <div id="mcChartLoading" class="mc-loading" style="display: none;">
                        <div class="mc-loading-spinner"></div>
                        <span>Simulation en cours...</span>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="mc-stats-grid" id="mcStatsGrid">
                    <div class="mc-stat">
                        <div class="mc-stat-label">MÃ©diane (P50)</div>
                        <div class="mc-stat-value" id="mcMedian">--</div>
                    </div>
                    <div class="mc-stat">
                        <div class="mc-stat-label">Optimiste (P90)</div>
                        <div class="mc-stat-value success" id="mcP90">--</div>
                    </div>
                    <div class="mc-stat">
                        <div class="mc-stat-label">Pessimiste (P10)</div>
                        <div class="mc-stat-value danger" id="mcP10">--</div>
                    </div>
                    <div class="mc-stat">
                        <div class="mc-stat-label">VaR 95%</div>
                        <div class="mc-stat-value" id="mcVaR">--</div>
                    </div>
                    <div class="mc-stat">
                        <div class="mc-stat-label">CVaR (ES)</div>
                        <div class="mc-stat-value" id="mcCVaR">--</div>
                    </div>
                    <div class="mc-stat">
                        <div class="mc-stat-label">Prob. Profit</div>
                        <div class="mc-stat-value" id="mcProbProfit">--</div>
                    </div>
                </div>

                <!-- Barres de probabilitÃ©s -->
                <div class="mc-probability-bars" id="mcProbBars">
                    <div class="prob-item">
                        <span class="prob-label">P(Perte > 50%)</span>
                        <div class="prob-bar-container">
                            <div class="prob-bar loss50" id="probLoss50" style="width: 0%"></div>
                        </div>
                        <span class="prob-value" id="probLoss50Val">--%</span>
                    </div>
                    <div class="prob-item">
                        <span class="prob-label">P(Perte > 20%)</span>
                        <div class="prob-bar-container">
                            <div class="prob-bar loss20" id="probLoss20" style="width: 0%"></div>
                        </div>
                        <span class="prob-value" id="probLoss20Val">--%</span>
                    </div>
                    <div class="prob-item">
                        <span class="prob-label">P(Gain > 20%)</span>
                        <div class="prob-bar-container">
                            <div class="prob-bar gain20" id="probGain20" style="width: 0%"></div>
                        </div>
                        <span class="prob-value" id="probGain20Val">--%</span>
                    </div>
                    <div class="prob-item">
                        <span class="prob-label">P(Gain > 50%)</span>
                        <div class="prob-bar-container">
                            <div class="prob-bar gain50" id="probGain50" style="width: 0%"></div>
                        </div>
                        <span class="prob-value" id="probGain50Val">--%</span>
                    </div>
                </div>
            </div>

            <!-- ============ STRESS TEST ============ -->
            <div class="card stress-card">
                <div class="card-header">
                    <div class="card-title">
                        âš¡ Stress Test - ScÃ©narios Historiques
                        <button class="tooltip-trigger" onclick="showTooltip('stresstest')">â“˜</button>
                    </div>
                </div>

                <div class="stress-scenarios">
                    <button class="stress-btn" onclick="runStressTest('crash2008')">
                        <span class="stress-icon">ðŸ“‰</span>
                        <span class="stress-name">Crash 2008</span>
                        <span class="stress-impact">-55%</span>
                    </button>
                    <button class="stress-btn" onclick="runStressTest('covid2020')">
                        <span class="stress-icon">ðŸ¦ </span>
                        <span class="stress-name">Covid 2020</span>
                        <span class="stress-impact">-34%</span>
                    </button>
                    <button class="stress-btn" onclick="runStressTest('cryptoWinter2022')">
                        <span class="stress-icon">â„ï¸</span>
                        <span class="stress-name">Crypto Winter</span>
                        <span class="stress-impact">-75%</span>
                    </button>
                    <button class="stress-btn" onclick="runStressTest('dotcom2000')">
                        <span class="stress-icon">ðŸ’»</span>
                        <span class="stress-name">Dotcom 2000</span>
                        <span class="stress-impact">-78%</span>
                    </button>
                    <button class="stress-btn" onclick="runStressTest('blackMonday1987')">
                        <span class="stress-icon">â¬›</span>
                        <span class="stress-name">Black Monday</span>
                        <span class="stress-impact">-22%</span>
                    </button>
                </div>

                <!-- RÃ©sultats Stress Test -->
                <div id="stressResults" class="stress-results" style="display: none;">
                    <div class="stress-result-header">
                        <span id="stressScenarioName">--</span>
                        <span id="stressScenarioDate" class="stress-date">--</span>
                    </div>
                    <div class="stress-result-grid">
                        <div class="stress-result-item">
                            <div class="stress-result-label">Valeur actuelle</div>
                            <div class="stress-result-value" id="stressCurrentValue">--</div>
                        </div>
                        <div class="stress-result-item">
                            <div class="stress-result-label">Impact simulÃ©</div>
                            <div class="stress-result-value danger" id="stressImpact">--</div>
                        </div>
                        <div class="stress-result-item">
                            <div class="stress-result-label">Valeur post-stress</div>
                            <div class="stress-result-value" id="stressPostValue">--</div>
                        </div>
                        <div class="stress-result-item">
                            <div class="stress-result-label">Perte absolue</div>
                            <div class="stress-result-value danger" id="stressLoss">--</div>
                        </div>
                    </div>
                    <div class="stress-detail" id="stressDetail"></div>
                </div>
            </div>

            <!-- ============ CALCULATEURS PRO ============ -->
            <div class="grid-2">
                <!-- Kelly Criterion -->
                <div class="card calc-card">
                    <div class="card-header">
                        <div class="card-title">
                            ðŸŽ¯ Kelly Criterion
                            <button class="tooltip-trigger" onclick="showTooltip('kelly')">â“˜</button>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="displayKelly()">Calculer</button>
                    </div>
                    <div class="calc-result" id="kellyResult">
                        <div class="calc-main-value">
                            <span class="calc-label">Allocation Optimale</span>
                            <span class="calc-value" id="kellyFraction">--%</span>
                        </div>
                        <div class="calc-sub-values">
                            <div class="calc-sub">
                                <span class="calc-sub-label">Half-Kelly (recommandÃ©)</span>
                                <span class="calc-sub-value" id="kellyHalf">--%</span>
                            </div>
                            <div class="calc-sub">
                                <span class="calc-sub-label">Win Rate historique</span>
                                <span class="calc-sub-value" id="kellyWinRate">--%</span>
                            </div>
                            <div class="calc-sub">
                                <span class="calc-sub-label">Ratio Gain/Perte</span>
                                <span class="calc-sub-value" id="kellyRatio">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info" style="margin-top: 0.5rem; font-size: 0.7rem;">
                        f* = (p Ã— b - q) / b oÃ¹ p = proba gain, q = proba perte, b = ratio gain/perte
                    </div>
                </div>

                <!-- VaR / CVaR -->
                <div class="card calc-card">
                    <div class="card-header">
                        <div class="card-title">
                            ðŸ“Š VaR & CVaR
                            <button class="tooltip-trigger" onclick="showTooltip('var')">â“˜</button>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="displayVaRCVaR()">Calculer</button>
                    </div>
                    <div class="calc-result" id="varResult">
                        <div class="calc-main-value">
                            <span class="calc-label">Value at Risk (95%)</span>
                            <span class="calc-value danger" id="varValue">--%</span>
                        </div>
                        <div class="calc-sub-values">
                            <div class="calc-sub">
                                <span class="calc-sub-label">VaR en euros</span>
                                <span class="calc-sub-value" id="varEuros">-- â‚¬</span>
                            </div>
                            <div class="calc-sub">
                                <span class="calc-sub-label">CVaR / Expected Shortfall</span>
                                <span class="calc-sub-value danger" id="cvarValue">--%</span>
                            </div>
                            <div class="calc-sub">
                                <span class="calc-sub-label">CVaR en euros</span>
                                <span class="calc-sub-value" id="cvarEuros">-- â‚¬</span>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning" style="margin-top: 0.5rem; font-size: 0.7rem;">
                        VaRâ‚‰â‚… = perte max attendue dans 95% des cas sur 1 mois
                    </div>
                </div>
            </div>

            <!-- ============ GOAL PLANNER ============ -->
            <div class="card goal-planner-card">
                <div class="card-header">
                    <div class="card-title">
                        ðŸŽ¯ Goal Planner - Rendement Requis
                        <button class="tooltip-trigger" onclick="showTooltip('goalplanner')">â“˜</button>
                    </div>
                </div>

                <div class="goal-form" style="padding: 1rem;">
                    <div class="form-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Objectif (â‚¬)</label>
                            <input type="number" id="goalTarget" class="form-input" value="50000" min="0" step="1000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Horizon (mois)</label>
                            <input type="number" id="goalHorizon" class="form-input" value="60" min="1" max="360">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Versement mensuel (â‚¬)</label>
                            <input type="number" id="goalContribution" class="form-input" value="800" min="0" step="50">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="runGoalPlanner()" style="width: 100%;">
                        ðŸ“Š Calculer le rendement requis
                    </button>
                </div>

                <div id="goalResults" class="goal-results" style="display: none; padding: 1rem;">
                    <!-- RÃ©sultats affichÃ©s dynamiquement -->
                </div>
            </div>
        </div>

        <!-- ==================== ANALYTICS ==================== -->
        <div class="panel" id="panel-analytics">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance Mensuelle</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Repartition Versements</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="contributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Statistiques de Performance</div>
                </div>
                <div class="holdings-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="holding-card">
                        <div class="holding-stat" style="padding: 1rem;">
                            <div class="label">Performance Totale</div>
                            <div class="value" style="font-size: 1.5rem;" id="statPerf">--%</div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-stat" style="padding: 1rem;">
                            <div class="label">Performance Annualisee</div>
                            <div class="value" style="font-size: 1.5rem;" id="statPerfAnnual">--%</div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-stat" style="padding: 1rem;">
                            <div class="label">Meilleur Actif</div>
                            <div class="value" style="font-size: 1.5rem;" id="statBestAsset">--</div>
                        </div>
                    </div>
                    <div class="holding-card">
                        <div class="holding-stat" style="padding: 1rem;">
                            <div class="label">Gain Total</div>
                            <div class="value" style="font-size: 1.5rem;" id="statTotalGain">-- EUR</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matrice de CorrÃ©lation -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ðŸ”— Matrice de Correlation</div>
                    <button class="btn btn-sm btn-secondary" onclick="renderCorrelationMatrix()">Actualiser</button>
                </div>
                <div id="correlationMatrix" style="padding: 1rem;">
                    <p style="color: var(--text-dim); text-align: center;">Cliquez sur "Actualiser" pour calculer les correlations</p>
                </div>
            </div>
        </div>

        <!-- ==================== SETTINGS ==================== -->
        <div class="panel" id="panel-settings">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Configuration</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget Mensuel (EUR)</label>
                        <input type="number" class="form-input" id="configBudget" value="800">
                        <div class="form-hint">Montant prevu chaque mois</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Livret A (%)</label>
                            <input type="number" class="form-input" id="configLivret" value="300">
                        </div>
                        <div class="form-group">
                            <label class="form-label">PEA (%)</label>
                            <input type="number" class="form-input" id="configPea" value="350">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">BTC (EUR)</label>
                            <input type="number" class="form-input" id="configBtc" value="105">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ETH (EUR)</label>
                            <input type="number" class="form-input" id="configEth" value="45">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveConfig()" style="margin-top: 1rem;">Sauvegarder</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Donnees</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exporter</label>
                        <button class="btn btn-secondary" onclick="exportJSON()">Telecharger JSON</button>
                        <div class="form-hint">Sauvegarde complete de vos donnees</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Importer</label>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importJSON(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Charger JSON</button>
                        <div class="form-hint">Restaurer depuis une sauvegarde</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reinitialiser</label>
                        <button class="btn btn-danger" onclick="resetData()">Effacer toutes les donnees</button>
                        <div class="form-hint">Action irreversible</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Prix ETF S&P 500 (Manuel)</div>
                </div>
                <div class="alert alert-info">
                    L'ETF BNP Easy S&P 500 n'a pas d'API gratuite. Entrez le prix actuel manuellement depuis Trade Republic.
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prix actuel (EUR)</label>
                        <input type="number" class="form-input" id="manualSpPrice" step="0.01">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="updateSpPrice()">Mettre a jour</button>
                    </div>
                </div>
            </div>

            <!-- Snapshots -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Snapshots Marche</div>
                    <button class="btn btn-primary btn-sm" onclick="captureSnapshot()">Capturer maintenant</button>
                </div>
                <div class="alert alert-info">
                    Les snapshots capturent la valeur de votre portefeuille a un instant T. Recommande: 1 par semaine.
                </div>
                <div style="margin-bottom: 1rem;">
                    Dernier snapshot: <strong id="lastSnapshotDate">Jamais</strong>
                </div>
                <div class="table-container" id="snapshotsTable" style="max-height: 300px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Total</th>
                                <th>BTC</th>
                                <th>ETH</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snapshotsTableBody">
                            <tr><td colspan="5" class="muted" style="text-align: center;">Aucun snapshot</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== RACCOURCIS CLAVIER ==================== -->
        <div class="panel" id="panel-shortcuts">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">âŒ¨ï¸ Raccourcis Clavier</div>
                </div>
                <p style="color: var(--text-dim); margin-bottom: 1.5rem; padding: 0 1rem;">
                    Utilisez ces raccourcis pour naviguer rapidement dans le tracker. Les raccourcis ne fonctionnent pas lorsque vous etes dans un champ de saisie.
                </p>

                <div class="shortcuts-section">
                    <h4 style="color: var(--text-secondary); margin-bottom: 1rem; padding: 0 1rem; font-size: 0.9rem;">ðŸ“ Navigation</h4>
                    <div class="shortcuts-grid-panel">
                        <div class="shortcut-card">
                            <kbd>1</kbd>
                            <span>Dashboard</span>
                        </div>
                        <div class="shortcut-card">
                            <kbd>2</kbd>
                            <span>Track Record</span>
                        </div>
                        <div class="shortcut-card">
                            <kbd>3</kbd>
                            <span>Transactions</span>
                        </div>
                        <div class="shortcut-card">
                            <kbd>4</kbd>
                            <span>Analytics</span>
                        </div>
                        <div class="shortcut-card">
                            <kbd>5</kbd>
                            <span>Parametres</span>
                        </div>
                        <div class="shortcut-card">
                            <kbd>6</kbd>
                            <span>Raccourcis</span>
                        </div>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h4 style="color: var(--text-secondary); margin-bottom: 1rem; padding: 0 1rem; font-size: 0.9rem;">âš¡ Actions Rapides</h4>
                    <div class="shortcuts-grid-panel">
                        <div class="shortcut-card">
                            <kbd>N</kbd>
                            <span>Nouveau versement</span>
                            <small>Focus sur le champ Livret A</small>
                        </div>
                        <div class="shortcut-card">
                            <kbd>S</kbd>
                            <span>Capturer snapshot</span>
                            <small>Sauvegarde l'etat actuel</small>
                        </div>
                        <div class="shortcut-card">
                            <kbd>R</kbd>
                            <span>Rafraichir prix</span>
                            <small>Met a jour BTC/ETH</small>
                        </div>
                        <div class="shortcut-card">
                            <kbd>I</kbd>
                            <span>Actualiser indicateurs</span>
                            <small>Fear & Greed, RSI, MA...</small>
                        </div>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h4 style="color: var(--text-secondary); margin-bottom: 1rem; padding: 0 1rem; font-size: 0.9rem;">ðŸ“Š Outils Avances</h4>
                    <div class="shortcuts-grid-panel">
                        <div class="shortcut-card">
                            <kbd>M</kbd>
                            <span>Monte Carlo</span>
                            <small>Lance la simulation GBM</small>
                        </div>
                        <div class="shortcut-card">
                            <kbd>G</kbd>
                            <span>Goal Planner</span>
                            <small>Calcul rendement requis</small>
                        </div>
                        <div class="shortcut-card">
                            <kbd>E</kbd>
                            <span>Exporter JSON</span>
                            <small>Sauvegarde complete</small>
                        </div>
                        <div class="shortcut-card">
                            <kbd>P</kbd>
                            <span>Exporter PDF</span>
                            <small>Rapport professionnel</small>
                        </div>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h4 style="color: var(--text-secondary); margin-bottom: 1rem; padding: 0 1rem; font-size: 0.9rem;">ðŸ”§ Utilitaires</h4>
                    <div class="shortcuts-grid-panel">
                        <div class="shortcut-card">
                            <kbd>?</kbd>
                            <span>Raccourcis</span>
                            <small>Affiche ce panneau (= touche 6)</small>
                        </div>
                        <div class="shortcut-card">
                            <kbd>Esc</kbd>
                            <span>Fermer tout</span>
                            <small>Ferme modales et tooltips</small>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info" style="margin: 1.5rem 1rem;">
                    <strong>ðŸ’¡ Astuce :</strong> Les raccourcis sont desactives quand vous tapez dans un champ de formulaire. Cliquez en dehors du champ pour les reactiver.
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div style="margin-bottom: 0.5rem;">
            <strong>Tracker Investissement</strong> v5.0 | Olympus Capital
        </div>
        <div style="font-size: 0.65rem; color: var(--text-muted); margin-bottom: 0.5rem;">
            Donnees crypto: CoinGecko API | Intelligence: Alternative.me | Donnees sauvegardees localement
        </div>
        <div style="font-size: 0.65rem; color: var(--text-muted);">
            Appuyez sur <kbd style="background: var(--bg-secondary); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.65rem;">?</kbd> pour les raccourcis clavier
            - <kbd style="background: var(--bg-secondary); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.65rem;">B</kbd> pour les backups
        </div>
    </footer>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCvMgjd-xfjh08ZUs_3LFK4zmu1ecs-Zc8",
            authDomain: "tracker-invest.firebaseapp.com",
            databaseURL: "https://tracker-invest-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tracker-invest",
            storageBucket: "tracker-invest.firebasestorage.app",
            messagingSenderId: "285324981356",
            appId: "1:285324981356:web:cc9473aa392faf8563d449"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ID fixe pour Antoine (sync automatique sur tous les appareils)
        const odaUserId = 'user_1767041205687_0p4l7kb6c';
        console.log('ðŸ›ï¸ Olympus Tracker - User ID:', odaUserId);

        // Flag pour eviter les boucles de sync
        let isSyncing = false;

        // ============================================
        // DATA STRUCTURE
        // ============================================
        const DEFAULT_DATA = {
            version: "5.0",
            config: {
                monthlyBudget: 800,
                defaultLivret: 300,
                defaultPea: 350,
                defaultBtc: 105,
                defaultEth: 45,
                riskFreeRate: 3,
                targetAllocation: { livret: 55, pea: 30, crypto: 15 }
            },
            transactions: [],
            snapshots: [],
            prices: {
                btc: { current: 0, change24h: 0 },
                eth: { current: 0, change24h: 0 },
                sp500: { current: 28.50 }
            },
            holdings: { livret: 0, btcQty: 0, ethQty: 0, spShares: 0 },
            invested: { livret: 0, pea: 0, btc: 0, eth: 0 },
            marketIntelligence: {
                lastUpdate: null,
                fearGreed: { value: 50, label: 'Neutral' },
                btc: { prices: [], ma50: null, ma200: null, rsi14: null, trend: 'neutral' },
                eth: { prices: [], ma50: null, ma200: null, rsi14: null, trend: 'neutral' },
                timingScore: 50,
                recommendation: 'DCA_NORMAL'
            },
            gamification: {
                xp: 0, level: 1, title: 'Debutant', badges: [],
                streaks: { currentDCA: 0, longestDCA: 0, currentSnapshot: 0, longestSnapshot: 0 },
                stats: { totalContributions: 0, totalSnapshots: 0, monthsInMarket: 0, survivedDrawdowns: [], boughtInExtremeFear: false, highTimingBuys: 0 },
                lastDCADate: null, lastSnapshotDate: null
            }
        };

        let DATA = loadData();
        let CHARTS = {};

        function loadData() {
            // Charger depuis localStorage d'abord (mode offline / demarrage rapide)
            const saved = localStorage.getItem('trackerDataV2');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    return migrateData(parsed);
                } catch (e) {
                    console.error('Erreur parsing localStorage:', e);
                    return JSON.parse(JSON.stringify(DEFAULT_DATA));
                }
            }
            return JSON.parse(JSON.stringify(DEFAULT_DATA));
        }

        // Initialiser la synchronisation Firebase apres chargement initial
        function initFirebaseSync() {
            const userRef = database.ref('users/' + odaUserId + '/trackerData');

            // Ecouter les changements en temps reel depuis Firebase
            userRef.on('value', (snapshot) => {
                if (isSyncing) return; // Eviter boucle infinie

                const cloudData = snapshot.val();
                if (cloudData) {
                    const localTimestamp = DATA.lastModified || 0;
                    const cloudTimestamp = cloudData.lastModified || 0;

                    if (cloudTimestamp > localTimestamp) {
                        // Cloud plus recent -> utiliser cloud
                        console.log('â˜ï¸ Donnees cloud plus recentes, synchronisation...');
                        isSyncing = true;

                        DATA = migrateData(cloudData);
                        localStorage.setItem('trackerDataV2', JSON.stringify(DATA));

                        // Mettre a jour l'interface
                        updateUI();
                        updateSyncIndicator('synced');
                        showNotification('Donnees synchronisees depuis le cloud', 'success');

                        setTimeout(() => { isSyncing = false; }, 1000);
                    } else if (localTimestamp > cloudTimestamp) {
                        // Local plus recent -> pousser vers cloud
                        console.log('ðŸ’¾ Donnees locales plus recentes, envoi vers cloud...');
                        saveToCloud();
                    }
                } else {
                    // Pas de donnees cloud, pousser les locales
                    console.log('ðŸ†• Premiere sync, envoi des donnees locales...');
                    saveToCloud();
                }
            }, (error) => {
                console.error('âŒ Erreur Firebase:', error);
                updateSyncIndicator('offline');
            });
        }

        function migrateData(oldData) {
            const migrated = JSON.parse(JSON.stringify(DEFAULT_DATA));

            // Conserver les donnÃ©es existantes
            if (oldData.config) migrated.config = { ...migrated.config, ...oldData.config };
            if (oldData.transactions) migrated.transactions = oldData.transactions;
            if (oldData.snapshots) migrated.snapshots = oldData.snapshots;
            if (oldData.prices) migrated.prices = { ...migrated.prices, ...oldData.prices };
            if (oldData.holdings) migrated.holdings = { ...migrated.holdings, ...oldData.holdings };
            if (oldData.invested) migrated.invested = { ...migrated.invested, ...oldData.invested };

            // Conserver les donnÃ©es intelligence si existantes
            if (oldData.marketIntelligence) {
                migrated.marketIntelligence = { ...migrated.marketIntelligence, ...oldData.marketIntelligence };
            }

            // Conserver les donnÃ©es gamification si existantes
            if (oldData.gamification) {
                migrated.gamification = { ...migrated.gamification, ...oldData.gamification };
                if (oldData.gamification.streaks) {
                    migrated.gamification.streaks = { ...migrated.gamification.streaks, ...oldData.gamification.streaks };
                }
                if (oldData.gamification.stats) {
                    migrated.gamification.stats = { ...migrated.gamification.stats, ...oldData.gamification.stats };
                }
            }

            migrated.version = "5.0";
            console.log('Donnees migrees vers v5.0:', migrated);
            return migrated;
        }

        function saveData() {
            try {
                // Ajouter timestamp de modification
                DATA.lastModified = Date.now();

                // Sauvegarder localement (toujours, pour mode offline)
                localStorage.setItem('trackerDataV2', JSON.stringify(DATA));
                console.log('ðŸ’¾ Donnees sauvegardees localement');

                // Sauvegarder dans Firebase
                saveToCloud();
            } catch (error) {
                console.error('âŒ Erreur sauvegarde:', error);
                showNotification('Erreur de sauvegarde', 'error');
            }
        }

        function saveToCloud() {
            if (!navigator.onLine) {
                updateSyncIndicator('offline');
                console.log('ðŸ“´ Mode hors-ligne, sauvegarde locale uniquement');
                return;
            }

            if (isSyncing) return;

            updateSyncIndicator('syncing');
            isSyncing = true;

            try {
                const userRef = database.ref('users/' + odaUserId + '/trackerData');
                userRef.set(DATA)
                    .then(() => {
                        console.log('â˜ï¸ Cloud sync OK');
                        updateSyncIndicator('synced');
                        setTimeout(() => { isSyncing = false; }, 500);
                    })
                    .catch((err) => {
                        console.error('âŒ Cloud sync failed:', err);
                        updateSyncIndicator('offline');
                        isSyncing = false;
                    });
            } catch (error) {
                console.error('âŒ Erreur saveToCloud:', error);
                updateSyncIndicator('offline');
                isSyncing = false;
            }
        }

        // ============================================
        // SYNC INDICATOR & NETWORK EVENTS
        // ============================================
        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;

            indicator.classList.remove('synced', 'syncing', 'offline');
            indicator.classList.add('visible', status);

            const text = indicator.querySelector('.sync-text');
            switch(status) {
                case 'synced':
                    text.textContent = 'â˜ï¸ Synchronise';
                    // Masquer apres 3 secondes
                    setTimeout(() => {
                        indicator.classList.remove('visible');
                    }, 3000);
                    break;
                case 'syncing':
                    text.textContent = 'ðŸ”„ Synchronisation...';
                    break;
                case 'offline':
                    text.textContent = 'ðŸ“´ Mode hors-ligne';
                    // Garder visible en mode offline
                    break;
            }
        }

        // Detecter connexion/deconnexion reseau
        window.addEventListener('online', () => {
            console.log('ðŸŒ Connexion retablie');
            updateSyncIndicator('syncing');
            saveToCloud();
        });

        window.addEventListener('offline', () => {
            console.log('ðŸ“´ Connexion perdue');
            updateSyncIndicator('offline');
        });

        // Sync avant fermeture de page
        window.addEventListener('beforeunload', () => {
            if (navigator.onLine) {
                // Sync synchrone avant fermeture
                const userRef = database.ref('users/' + odaUserId + '/trackerData');
                // Note: set() est async, mais on tente quand meme
                userRef.set(DATA);
            }
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialiser la synchronisation Firebase
            initFirebaseSync();

            // Afficher statut initial
            if (navigator.onLine) {
                updateSyncIndicator('syncing');
            } else {
                updateSyncIndicator('offline');
            }
            // Set default date
            document.getElementById('quickDate').value = new Date().toISOString().split('T')[0];

            // Load config into quick form
            document.getElementById('quickLivret').value = DATA.config.defaultLivret;
            document.getElementById('quickPea').value = DATA.config.defaultPea;
            document.getElementById('quickBtc').value = DATA.config.defaultBtc;
            document.getElementById('quickEth').value = DATA.config.defaultEth;

            // Load settings
            document.getElementById('configBudget').value = DATA.config.monthlyBudget;
            document.getElementById('configLivret').value = DATA.config.defaultLivret;
            document.getElementById('configPea').value = DATA.config.defaultPea;
            document.getElementById('configBtc').value = DATA.config.defaultBtc;
            document.getElementById('configEth').value = DATA.config.defaultEth;
            document.getElementById('manualSpPrice').value = DATA.prices.sp500.current;

            // Fetch prices
            await refreshPrices();
            refreshMacro();
            refreshMarketIntelligence();

            // Update preview on input change
            ['quickLivret', 'quickPea', 'quickBtc', 'quickEth'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });

            // Initial UI update
            updateUI();
            initCharts();
            updateSnapshotsDisplay();
            updateGamificationDisplay();
            checkBadges();
        });

        // ============================================
        // PRICE FETCHING
        // ============================================
        async function refreshPrices() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');

            try {
                // Fetch crypto prices from CoinGecko
                const response = await fetch(
                    'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=eur&include_24hr_change=true'
                );

                if (response.ok) {
                    const data = await response.json();

                    DATA.prices.btc = {
                        current: data.bitcoin.eur,
                        change24h: data.bitcoin.eur_24h_change
                    };

                    DATA.prices.eth = {
                        current: data.ethereum.eur,
                        change24h: data.ethereum.eur_24h_change
                    };

                    saveData();
                }
            } catch (error) {
                console.error('Erreur API:', error);
            }

            btn.classList.remove('loading');
            updatePricesDisplay();
            updatePreview();
            updateUI();
        }

        function updatePricesDisplay() {
            const btc = DATA.prices.btc;
            const eth = DATA.prices.eth;
            const sp = DATA.prices.sp500;

            // Header badges
            document.getElementById('headerBtc').textContent = formatCompact(btc.current);
            document.getElementById('headerEth').textContent = formatCompact(eth.current);
            document.getElementById('headerSp500').textContent = sp.current.toFixed(2) + 'â‚¬';

            const btcChange = document.getElementById('headerBtcChange');
            const ethChange = document.getElementById('headerEthChange');

            btcChange.textContent = formatChange(btc.change24h);
            btcChange.className = 'change ' + (btc.change24h >= 0 ? 'up' : 'down');

            ethChange.textContent = formatChange(eth.change24h);
            ethChange.className = 'change ' + (eth.change24h >= 0 ? 'up' : 'down');
        }

        // ============================================
        // VERSEMENT / TRANSACTION
        // ============================================
        function addVersement() {
            const date = document.getElementById('quickDate').value;
            const livret = parseFloat(document.getElementById('quickLivret').value) || 0;
            const pea = parseFloat(document.getElementById('quickPea').value) || 0;
            const btcEur = parseFloat(document.getElementById('quickBtc').value) || 0;
            const ethEur = parseFloat(document.getElementById('quickEth').value) || 0;

            if (!date) {
                alert('Veuillez selectionner une date');
                return;
            }

            const btcPrice = DATA.prices.btc.current;
            const ethPrice = DATA.prices.eth.current;
            const spPrice = DATA.prices.sp500.current;

            if (btcPrice === 0 || ethPrice === 0) {
                alert('Les prix crypto ne sont pas charges. Cliquez sur Actualiser.');
                return;
            }

            // Calculate quantities purchased
            const btcQty = btcEur / btcPrice;
            const ethQty = ethEur / ethPrice;
            const spShares = pea / spPrice;

            const transaction = {
                id: Date.now().toString(),
                date: date,
                livret: livret,
                pea: pea,
                btc: { eur: btcEur, qty: btcQty, price: btcPrice },
                eth: { eur: ethEur, qty: ethQty, price: ethPrice },
                sp500: { eur: pea, shares: spShares, price: spPrice },
                total: livret + pea + btcEur + ethEur
            };

            // Add to transactions
            DATA.transactions.push(transaction);
            DATA.transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Update holdings
            DATA.holdings.livret += livret;
            DATA.holdings.btcQty += btcQty;
            DATA.holdings.ethQty += ethQty;
            DATA.holdings.spShares += spShares;

            // Update invested totals
            DATA.invested.livret += livret;
            DATA.invested.pea += pea;
            DATA.invested.btc += btcEur;
            DATA.invested.eth += ethEur;

            saveData();

            // === GAMIFICATION ===
            // Mettre Ã  jour les stats
            DATA.gamification.stats.totalContributions++;

            // XP pour le versement
            awardXP(XP_REWARDS.VERSEMENT, 'Versement effectue');

            // Bonus si versement complet (4 actifs)
            if (livret > 0 && pea > 0 && btcEur > 0 && ethEur > 0) {
                awardXP(XP_REWARDS.VERSEMENT_COMPLET, 'Versement diversifie');
            }

            // VÃ©rifier si achat en Extreme Fear
            const fearValue = DATA.marketIntelligence.fearGreed.value;
            if (fearValue <= 25 && (btcEur > 0 || ethEur > 0)) {
                if (!DATA.gamification.stats.boughtInExtremeFear) {
                    DATA.gamification.stats.boughtInExtremeFear = true;
                    awardXP(XP_REWARDS.FEAR_BUYER, 'Achat en Extreme Fear!');
                }
            }

            // VÃ©rifier si timing score > 70
            const timingScore = DATA.marketIntelligence.timingScore;
            if (timingScore >= 70 && (btcEur > 0 || ethEur > 0)) {
                DATA.gamification.stats.highTimingBuys = (DATA.gamification.stats.highTimingBuys || 0) + 1;
            }

            // Mettre Ã  jour les streaks
            updateStreaks('dca');

            // VÃ©rifier les badges
            checkBadges();

            // Mettre Ã  jour l'affichage gamification
            updateGamificationDisplay();
            // === FIN GAMIFICATION ===

            updateUI();
            updateCharts();

            // Reset date to today
            document.getElementById('quickDate').value = new Date().toISOString().split('T')[0];

            // Show success
            alert('Versement ajoute avec succes !');
        }

        function deleteTransaction(id) {
            if (!confirm('Supprimer ce versement ?')) return;

            const tx = DATA.transactions.find(t => t.id === id);
            if (!tx) return;

            // Remove from holdings
            DATA.holdings.livret -= tx.livret;
            DATA.holdings.btcQty -= tx.btc.qty;
            DATA.holdings.ethQty -= tx.eth.qty;
            DATA.holdings.spShares -= tx.sp500.shares;

            // Remove from invested
            DATA.invested.livret -= tx.livret;
            DATA.invested.pea -= tx.pea;
            DATA.invested.btc -= tx.btc.eur;
            DATA.invested.eth -= tx.eth.eur;

            // Remove transaction
            DATA.transactions = DATA.transactions.filter(t => t.id !== id);

            saveData();
            updateUI();
            updateCharts();
        }

        // ============================================
        // CALCULATIONS
        // ============================================
        function calculatePortfolio() {
            const btcPrice = DATA.prices.btc.current;
            const ethPrice = DATA.prices.eth.current;
            const spPrice = DATA.prices.sp500.current;

            // Current values
            const livretValue = DATA.holdings.livret * 1.03; // +3% annual interest approximation
            const btcValue = DATA.holdings.btcQty * btcPrice;
            const ethValue = DATA.holdings.ethQty * ethPrice;
            const peaValue = DATA.holdings.spShares * spPrice;
            const cryptoValue = btcValue + ethValue;
            const totalValue = livretValue + peaValue + cryptoValue;

            // Invested
            const totalInvested = DATA.invested.livret + DATA.invested.pea + DATA.invested.btc + DATA.invested.eth;

            // Gains
            const livretGain = livretValue - DATA.invested.livret;
            const peaGain = peaValue - DATA.invested.pea;
            const btcGain = btcValue - DATA.invested.btc;
            const ethGain = ethValue - DATA.invested.eth;
            const cryptoGain = cryptoValue - (DATA.invested.btc + DATA.invested.eth);
            const totalGain = totalValue - totalInvested;

            // PRU
            const btcPru = DATA.holdings.btcQty > 0 ? DATA.invested.btc / DATA.holdings.btcQty : 0;
            const ethPru = DATA.holdings.ethQty > 0 ? DATA.invested.eth / DATA.holdings.ethQty : 0;
            const spPru = DATA.holdings.spShares > 0 ? DATA.invested.pea / DATA.holdings.spShares : 0;

            // Performance %
            const totalPerf = totalInvested > 0 ? (totalGain / totalInvested) * 100 : 0;
            const btcPerf = DATA.invested.btc > 0 ? (btcGain / DATA.invested.btc) * 100 : 0;
            const ethPerf = DATA.invested.eth > 0 ? (ethGain / DATA.invested.eth) * 100 : 0;
            const peaPerf = DATA.invested.pea > 0 ? (peaGain / DATA.invested.pea) * 100 : 0;

            return {
                values: { livret: livretValue, pea: peaValue, btc: btcValue, eth: ethValue, crypto: cryptoValue, total: totalValue },
                invested: { livret: DATA.invested.livret, pea: DATA.invested.pea, btc: DATA.invested.btc, eth: DATA.invested.eth, total: totalInvested },
                gains: { livret: livretGain, pea: peaGain, btc: btcGain, eth: ethGain, crypto: cryptoGain, total: totalGain },
                holdings: { btcQty: DATA.holdings.btcQty, ethQty: DATA.holdings.ethQty, spShares: DATA.holdings.spShares },
                pru: { btc: btcPru, eth: ethPru, sp: spPru },
                perf: { total: totalPerf, btc: btcPerf, eth: ethPerf, pea: peaPerf }
            };
        }

        // ============================================
        // MÃ‰TRIQUES PROFESSIONNELLES
        // ============================================

        /**
         * GÃ©nÃ¨re les snapshots mensuels Ã  partir des transactions
         * Un snapshot par mois, basÃ© sur la valeur Ã  la fin du mois
         */
        function generateMonthlySnapshots() {
            if (DATA.transactions.length === 0) return [];

            const snapshots = [];
            const sortedTx = [...DATA.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Regrouper les transactions par mois
            const monthlyData = {};
            let cumLivret = 0, cumBtcQty = 0, cumEthQty = 0, cumSpShares = 0;
            let cumInvestedLivret = 0, cumInvestedPea = 0, cumInvestedBtc = 0, cumInvestedEth = 0;

            sortedTx.forEach(tx => {
                const month = tx.date.substring(0, 7); // YYYY-MM

                cumLivret += tx.livret;
                cumBtcQty += tx.btc.qty;
                cumEthQty += tx.eth.qty;
                cumSpShares += tx.sp500.shares;

                cumInvestedLivret += tx.livret;
                cumInvestedPea += tx.pea;
                cumInvestedBtc += tx.btc.eur;
                cumInvestedEth += tx.eth.eur;

                monthlyData[month] = {
                    date: tx.date,
                    holdings: { livret: cumLivret, btcQty: cumBtcQty, ethQty: cumEthQty, spShares: cumSpShares },
                    invested: { livret: cumInvestedLivret, pea: cumInvestedPea, btc: cumInvestedBtc, eth: cumInvestedEth },
                    prices: { btc: tx.btc.price, eth: tx.eth.price, sp500: tx.sp500.price },
                    cashFlow: tx.total
                };
            });

            // CrÃ©er les snapshots avec valeurs calculÃ©es
            Object.keys(monthlyData).sort().forEach(month => {
                const data = monthlyData[month];
                const livretValue = data.holdings.livret * 1.03;
                const btcValue = data.holdings.btcQty * data.prices.btc;
                const ethValue = data.holdings.ethQty * data.prices.eth;
                const peaValue = data.holdings.spShares * data.prices.sp500;
                const total = livretValue + btcValue + ethValue + peaValue;
                const totalInvested = data.invested.livret + data.invested.pea + data.invested.btc + data.invested.eth;

                snapshots.push({
                    month: month,
                    date: data.date,
                    total: total,
                    invested: totalInvested,
                    cashFlow: data.cashFlow,
                    prices: data.prices
                });
            });

            // Ajouter snapshot actuel avec prix courants
            if (snapshots.length > 0) {
                const portfolio = calculatePortfolio();
                const currentMonth = new Date().toISOString().substring(0, 7);
                const lastMonth = snapshots[snapshots.length - 1].month;

                if (currentMonth !== lastMonth) {
                    snapshots.push({
                        month: currentMonth,
                        date: new Date().toISOString().split('T')[0],
                        total: portfolio.values.total,
                        invested: portfolio.invested.total,
                        cashFlow: 0,
                        prices: { btc: DATA.prices.btc.current, eth: DATA.prices.eth.current, sp500: DATA.prices.sp500.current }
                    });
                } else {
                    // Mettre Ã  jour le dernier snapshot avec les prix actuels
                    snapshots[snapshots.length - 1].total = portfolio.values.total;
                }
            }

            return snapshots;
        }

        /**
         * Calcule les rendements mensuels
         */
        function calculateMonthlyReturns(snapshots) {
            if (snapshots.length < 2) return [];

            const returns = [];
            for (let i = 1; i < snapshots.length; i++) {
                const startValue = snapshots[i-1].total;
                const endValue = snapshots[i].total;
                const cashFlow = snapshots[i].cashFlow || 0;

                // Rendement ajustÃ© des flux (mÃ©thode Dietz modifiÃ©e simplifiÃ©e)
                const adjustedStart = startValue + (cashFlow / 2);
                const periodReturn = adjustedStart > 0 ? ((endValue - startValue - cashFlow) / adjustedStart) * 100 : 0;

                returns.push({
                    month: snapshots[i].month,
                    return: periodReturn
                });
            }

            return returns;
        }

        /**
         * TWR - Time-Weighted Return
         * Ã‰limine l'impact du timing des versements
         */
        function calculateTWR(snapshots) {
            if (snapshots.length < 2) return 0;

            let twr = 1;

            for (let i = 1; i < snapshots.length; i++) {
                const startValue = snapshots[i-1].total;
                const endValue = snapshots[i].total;
                const cashFlow = snapshots[i].cashFlow || 0;

                // Rendement de la pÃ©riode (flux supposÃ© en milieu de pÃ©riode)
                const adjustedStart = startValue + (cashFlow / 2);
                if (adjustedStart > 0) {
                    const periodReturn = (endValue - startValue - cashFlow) / adjustedStart;
                    twr *= (1 + periodReturn);
                }
            }

            return (twr - 1) * 100;
        }

        /**
         * MWR / IRR - Money-Weighted Return (Taux de RentabilitÃ© Interne)
         * MÃ©thode Newton-Raphson
         */
        function calculateMWR(transactions, currentValue) {
            if (transactions.length === 0) return 0;

            const sortedTx = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            const startDate = new Date(sortedTx[0].date);

            // Construire les flux de trÃ©sorerie
            const flows = sortedTx.map(tx => ({
                years: (new Date(tx.date) - startDate) / (365.25 * 24 * 60 * 60 * 1000),
                amount: -tx.total // Investissement = flux nÃ©gatif
            }));

            // Ajouter la valeur finale
            flows.push({
                years: (new Date() - startDate) / (365.25 * 24 * 60 * 60 * 1000),
                amount: currentValue
            });

            // Newton-Raphson pour trouver le TRI
            let rate = 0.1; // Estimation initiale 10%

            for (let iter = 0; iter < 100; iter++) {
                let npv = 0;
                let npvDerivative = 0;

                flows.forEach(f => {
                    const discountFactor = Math.pow(1 + rate, f.years);
                    npv += f.amount / discountFactor;
                    npvDerivative -= f.years * f.amount / Math.pow(1 + rate, f.years + 1);
                });

                if (Math.abs(npvDerivative) < 0.0001) break;

                const newRate = rate - npv / npvDerivative;
                if (Math.abs(newRate - rate) < 0.0001) break;

                rate = Math.max(-0.99, Math.min(10, newRate)); // Limiter entre -99% et 1000%
            }

            return rate * 100;
        }

        /**
         * VolatilitÃ© annualisÃ©e
         */
        function calculateVolatility(monthlyReturns) {
            if (monthlyReturns.length < 2) return 0;

            const returns = monthlyReturns.map(r => r.return);
            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            const squaredDiffs = returns.map(r => Math.pow(r - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / (returns.length - 1);
            const stdDev = Math.sqrt(variance);

            // Annualiser (âˆš12 pour des rendements mensuels)
            return stdDev * Math.sqrt(12);
        }

        /**
         * Sharpe Ratio
         * (Rp - Rf) / Ïƒp
         */
        function calculateSharpe(annualizedReturn, volatility, riskFreeRate) {
            if (volatility === 0) return 0;
            return (annualizedReturn - riskFreeRate) / volatility;
        }

        /**
         * Sortino Ratio
         * Comme Sharpe mais ne pÃ©nalise que la volatilitÃ© nÃ©gative
         */
        function calculateSortino(annualizedReturn, monthlyReturns, riskFreeRate) {
            if (monthlyReturns.length < 2) return 0;

            const monthlyRf = riskFreeRate / 12;
            const returns = monthlyReturns.map(r => r.return);
            const negativeReturns = returns.filter(r => r < monthlyRf);

            if (negativeReturns.length === 0) return 99.99; // Aucun mois nÃ©gatif = excellent

            const squaredNegative = negativeReturns.map(r => Math.pow(r - monthlyRf, 2));
            const downsideVariance = squaredNegative.reduce((a, b) => a + b, 0) / negativeReturns.length;
            const downsideDeviation = Math.sqrt(downsideVariance) * Math.sqrt(12);

            if (downsideDeviation === 0) return 99.99;
            return (annualizedReturn - riskFreeRate) / downsideDeviation;
        }

        /**
         * Maximum Drawdown
         * Pire baisse depuis un plus haut
         */
        function calculateMaxDrawdown(snapshots) {
            if (snapshots.length < 2) return 0;

            const values = snapshots.map(s => s.total);
            let maxDrawdown = 0;
            let peak = values[0];

            for (const value of values) {
                if (value > peak) {
                    peak = value;
                }
                const drawdown = (peak - value) / peak * 100;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            }

            return maxDrawdown;
        }

        /**
         * Calmar Ratio
         * Rendement annualisÃ© / Max Drawdown
         */
        function calculateCalmar(annualizedReturn, maxDrawdown) {
            if (maxDrawdown === 0) return 99.99;
            return annualizedReturn / maxDrawdown;
        }

        /**
         * Win Rate - Pourcentage de mois positifs
         */
        function calculateWinRate(monthlyReturns) {
            if (monthlyReturns.length === 0) return 0;

            const positiveMonths = monthlyReturns.filter(r => r.return > 0).length;
            return (positiveMonths / monthlyReturns.length) * 100;
        }

        /**
         * Annualise un rendement cumulÃ©
         */
        function annualizeReturn(cumulativeReturn, months) {
            if (months <= 0) return 0;
            const years = months / 12;
            if (years < 1) return cumulativeReturn; // Pas d'annualisation si moins d'un an
            return (Math.pow(1 + cumulativeReturn / 100, 1 / years) - 1) * 100;
        }

        /**
         * Calcule toutes les mÃ©triques professionnelles
         */
        function calculateAllMetrics() {
            const snapshots = generateMonthlySnapshots();
            const monthlyReturns = calculateMonthlyReturns(snapshots);
            const portfolio = calculatePortfolio();
            const riskFreeRate = DATA.config.riskFreeRate || 3;

            // TWR
            const twr = calculateTWR(snapshots);

            // MWR
            const mwr = calculateMWR(DATA.transactions, portfolio.values.total);

            // Annualiser le rendement
            const months = snapshots.length > 0 ? snapshots.length : 1;
            const annualizedReturn = annualizeReturn(portfolio.perf.total, months);

            // VolatilitÃ©
            const volatility = calculateVolatility(monthlyReturns);

            // Sharpe
            const sharpe = calculateSharpe(annualizedReturn, volatility, riskFreeRate);

            // Sortino
            const sortino = calculateSortino(annualizedReturn, monthlyReturns, riskFreeRate);

            // Max Drawdown
            const maxDD = calculateMaxDrawdown(snapshots);

            // Calmar
            const calmar = calculateCalmar(annualizedReturn, maxDD);

            // Win Rate
            const winRate = calculateWinRate(monthlyReturns);

            // Meilleur/Pire mois
            let bestMonth = 0, worstMonth = 0;
            if (monthlyReturns.length > 0) {
                bestMonth = Math.max(...monthlyReturns.map(r => r.return));
                worstMonth = Math.min(...monthlyReturns.map(r => r.return));
            }

            return {
                twr,
                mwr,
                annualizedReturn,
                volatility,
                sharpe,
                sortino,
                maxDD,
                calmar,
                winRate,
                bestMonth,
                worstMonth,
                monthlyReturns,
                snapshots
            };
        }

        /**
         * Met Ã  jour l'affichage des mÃ©triques pro
         */
        function updateMetricsPro() {
            const hasData = DATA.transactions.length > 0;
            document.getElementById('metricsProSection').style.display = hasData ? 'block' : 'none';

            if (!hasData) return;

            const metrics = calculateAllMetrics();

            // TWR
            const twrEl = document.getElementById('metricTWR');
            twrEl.textContent = formatChange(metrics.twr);
            twrEl.className = 'metric-value ' + (metrics.twr >= 0 ? 'positive' : 'negative');

            // MWR
            const mwrEl = document.getElementById('metricMWR');
            mwrEl.textContent = formatChange(metrics.mwr);
            mwrEl.className = 'metric-value ' + (metrics.mwr >= 0 ? 'positive' : 'negative');

            // Sharpe
            document.getElementById('metricSharpe').textContent = metrics.sharpe.toFixed(2);
            const sharpeRating = document.getElementById('sharpeRating');
            if (metrics.sharpe >= 2) {
                sharpeRating.textContent = 'Excellent';
                sharpeRating.className = 'metric-rating excellent';
            } else if (metrics.sharpe >= 1) {
                sharpeRating.textContent = 'Bon';
                sharpeRating.className = 'metric-rating good';
            } else if (metrics.sharpe >= 0.5) {
                sharpeRating.textContent = 'Acceptable';
                sharpeRating.className = 'metric-rating average';
            } else {
                sharpeRating.textContent = 'Faible';
                sharpeRating.className = 'metric-rating poor';
            }

            // Sortino
            document.getElementById('metricSortino').textContent = metrics.sortino > 10 ? '>10' : metrics.sortino.toFixed(2);
            const sortinoRating = document.getElementById('sortinoRating');
            if (metrics.sortino >= 2) {
                sortinoRating.textContent = 'Excellent';
                sortinoRating.className = 'metric-rating excellent';
            } else if (metrics.sortino >= 1) {
                sortinoRating.textContent = 'Bon';
                sortinoRating.className = 'metric-rating good';
            } else if (metrics.sortino >= 0.5) {
                sortinoRating.textContent = 'Acceptable';
                sortinoRating.className = 'metric-rating average';
            } else {
                sortinoRating.textContent = 'Faible';
                sortinoRating.className = 'metric-rating poor';
            }

            // Max Drawdown
            document.getElementById('metricMaxDD').textContent = '-' + metrics.maxDD.toFixed(2) + '%';

            // VolatilitÃ©
            document.getElementById('metricVolatility').textContent = metrics.volatility.toFixed(2) + '%';

            // Calmar
            document.getElementById('metricCalmar').textContent = metrics.calmar > 10 ? '>10' : metrics.calmar.toFixed(2);

            // Win Rate
            document.getElementById('metricWinRate').textContent = metrics.winRate.toFixed(0) + '%';

            // Alpha & Beta (mÃ©triques institutionnelles)
            const alphaBeta = calculateAlphaBeta();
            if (alphaBeta.alpha !== null) {
                const alphaEl = document.getElementById('metricAlpha');
                alphaEl.textContent = (alphaBeta.alpha >= 0 ? '+' : '') + alphaBeta.alpha.toFixed(2) + '%';
                alphaEl.className = 'metric-value ' + (alphaBeta.alpha >= 0 ? 'positive' : 'negative');

                const alphaRating = document.getElementById('alphaRating');
                alphaRating.textContent = alphaBeta.interpretation.alpha.label;
                alphaRating.className = 'metric-rating ' + alphaBeta.interpretation.alpha.class;

                const betaEl = document.getElementById('metricBeta');
                betaEl.textContent = alphaBeta.beta.toFixed(2);

                const betaRating = document.getElementById('betaRating');
                betaRating.textContent = alphaBeta.interpretation.beta.label;
                betaRating.className = 'metric-rating ' + alphaBeta.interpretation.beta.class;
            } else {
                document.getElementById('metricAlpha').textContent = '--';
                document.getElementById('alphaRating').textContent = alphaBeta.error || 'N/A';
                document.getElementById('metricBeta').textContent = '--';
                document.getElementById('betaRating').textContent = 'N/A';
            }
        }

        /**
         * Met Ã  jour la section Track Record
         */
        function updateTrackRecord() {
            if (DATA.transactions.length === 0) return;

            const metrics = calculateAllMetrics();
            const portfolio = calculatePortfolio();
            const sortedTx = [...DATA.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Dates
            const startDate = new Date(sortedTx[0].date);
            const endDate = new Date();
            const months = Math.max(1, Math.ceil((endDate - startDate) / (30.44 * 24 * 60 * 60 * 1000)));

            document.getElementById('trStartDate').textContent = startDate.toLocaleDateString('fr-FR');
            document.getElementById('trEndDate').textContent = endDate.toLocaleDateString('fr-FR');
            document.getElementById('trMonths').textContent = months;

            // Tableau synthÃ¨se
            document.getElementById('trPerfCum').textContent = formatChange(portfolio.perf.total);
            document.getElementById('trPerfCum').className = portfolio.perf.total >= 0 ? 'positive' : 'negative';

            document.getElementById('trPerfAnn').textContent = formatChange(metrics.annualizedReturn);
            document.getElementById('trVolatility').textContent = metrics.volatility.toFixed(2) + '%';
            document.getElementById('trSharpe').textContent = metrics.sharpe.toFixed(2);
            document.getElementById('trSortino').textContent = metrics.sortino > 10 ? '>10' : metrics.sortino.toFixed(2);
            document.getElementById('trMaxDD').textContent = '-' + metrics.maxDD.toFixed(2) + '%';
            document.getElementById('trWinRate').textContent = metrics.winRate.toFixed(0) + '%';
            document.getElementById('trBestMonth').textContent = formatChange(metrics.bestMonth);
            document.getElementById('trWorstMonth').textContent = formatChange(metrics.worstMonth);

            // Commentaires Sharpe/Sortino
            document.getElementById('trSharpeComment').textContent = metrics.sharpe >= 1 ? 'Bon' : metrics.sharpe >= 0.5 ? 'Acceptable' : 'A ameliorer';
            document.getElementById('trSortinoComment').textContent = metrics.sortino >= 1 ? 'Bon' : metrics.sortino >= 0.5 ? 'Acceptable' : 'A ameliorer';

            // Mettre Ã  jour les graphiques Track Record
            updateTrackRecordCharts(metrics);
        }

        /**
         * Met Ã  jour l'objectif SMART
         */
        function updateObjective() {
            const TARGET = 5000;
            const DEADLINE = new Date('2027-01-31');
            const START_DATE = new Date('2025-10-01');

            const portfolio = calculatePortfolio();
            const current = portfolio.invested.total;
            const progress = Math.min((current / TARGET) * 100, 100);

            // Mois restants
            const now = new Date();
            const monthsLeft = Math.max(0, Math.ceil((DEADLINE - now) / (30.44 * 24 * 60 * 60 * 1000)));

            // Montant requis par mois
            const remaining = Math.max(0, TARGET - current);
            const monthlyRequired = monthsLeft > 0 ? remaining / monthsLeft : 0;

            // Statut (en avance ou en retard)
            const monthsElapsed = Math.max(1, Math.ceil((now - START_DATE) / (30.44 * 24 * 60 * 60 * 1000)));
            const totalMonths = Math.ceil((DEADLINE - START_DATE) / (30.44 * 24 * 60 * 60 * 1000));
            const expectedProgress = (monthsElapsed / totalMonths) * TARGET;
            const status = current >= expectedProgress ? 'En avance' : 'En retard';

            document.getElementById('objCurrent').textContent = formatCurrency(current);
            document.getElementById('objProgressBar').style.width = progress + '%';
            document.getElementById('objProgressPercent').textContent = progress.toFixed(1);
            document.getElementById('objMonthsLeft').textContent = monthsLeft;
            document.getElementById('objMonthlyRequired').textContent = formatCurrency(monthlyRequired);

            const statusEl = document.getElementById('objStatus');
            statusEl.textContent = status;
            statusEl.style.color = status === 'En avance' ? 'var(--success)' : 'var(--warning)';
        }

        /**
         * Graphiques Track Record
         */
        let TR_CHARTS = {};

        function updateTrackRecordCharts(metrics) {
            // Performance mensuelle (barres)
            const ctx1 = document.getElementById('trMonthlyPerfChart');
            if (!ctx1) return;

            if (TR_CHARTS.monthly) TR_CHARTS.monthly.destroy();
            if (TR_CHARTS.drawdown) TR_CHARTS.drawdown.destroy();

            const monthlyReturns = metrics.monthlyReturns || [];

            TR_CHARTS.monthly = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: monthlyReturns.map(r => r.month),
                    datasets: [{
                        label: 'Rendement %',
                        data: monthlyReturns.map(r => r.return),
                        backgroundColor: monthlyReturns.map(r => r.return >= 0 ? 'rgba(0, 255, 65, 0.7)' : 'rgba(255, 68, 68, 0.7)'),
                        borderColor: monthlyReturns.map(r => r.return >= 0 ? '#00ff41' : '#ff4444'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Drawdown
            const ctx2 = document.getElementById('trDrawdownChart');
            const snapshots = metrics.snapshots || [];
            const drawdowns = [];
            let peak = snapshots.length > 0 ? snapshots[0].total : 0;

            snapshots.forEach(s => {
                if (s.total > peak) peak = s.total;
                const dd = peak > 0 ? -((peak - s.total) / peak * 100) : 0;
                drawdowns.push({ month: s.month, dd: dd });
            });

            TR_CHARTS.drawdown = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: drawdowns.map(d => d.month),
                    datasets: [{
                        label: 'Drawdown %',
                        data: drawdowns.map(d => d.dd),
                        borderColor: '#ff4444',
                        backgroundColor: 'rgba(255, 68, 68, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { max: 0, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Benchmark chart
            updateBenchmarkChart(metrics.snapshots);
        }

        /**
         * Graphique de comparaison vs S&P 500
         */
        function updateBenchmarkChart(snapshots) {
            const ctx = document.getElementById('benchmarkChart');
            if (!ctx || !snapshots || snapshots.length < 2) return;

            if (TR_CHARTS.benchmark) TR_CHARTS.benchmark.destroy();

            // Calculer performance normalisÃ©e (base 100)
            const firstPortfolio = snapshots[0].total;
            const firstSP = snapshots[0].prices.sp500;

            const portfolioData = snapshots.map(s => (s.total / firstPortfolio) * 100);
            const sp500Data = snapshots.map(s => (s.prices.sp500 / firstSP) * 100);

            // Calculer Alpha
            const lastPortfolio = snapshots[snapshots.length - 1].total;
            const lastSP = snapshots[snapshots.length - 1].prices.sp500;
            const portfolioReturn = ((lastPortfolio - firstPortfolio) / firstPortfolio) * 100;
            const sp500Return = ((lastSP - firstSP) / firstSP) * 100;
            const alpha = portfolioReturn - sp500Return;

            const alphaEl = document.getElementById('alphaDisplay');
            alphaEl.textContent = 'Alpha: ' + (alpha >= 0 ? '+' : '') + alpha.toFixed(2) + '%';
            alphaEl.style.color = alpha >= 0 ? 'var(--success)' : 'var(--danger)';

            TR_CHARTS.benchmark = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: snapshots.map(s => s.month),
                    datasets: [
                        {
                            label: 'Mon Portefeuille',
                            data: portfolioData,
                            borderColor: '#00ff41',
                            backgroundColor: 'rgba(0, 255, 65, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'S&P 500',
                            data: sp500Data,
                            borderColor: '#a855f7',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#fff', font: { family: "'JetBrains Mono'" } }
                        },
                        title: {
                            display: true,
                            text: 'Performance normalisee (base 100)',
                            color: 'rgba(255,255,255,0.5)',
                            font: { size: 11 }
                        }
                    },
                    scales: {
                        x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        // ============================================
        // ALERTES & RÃ‰Ã‰QUILIBRAGE
        // ============================================

        /**
         * VÃ©rifie et gÃ©nÃ¨re les alertes
         */
        function checkAlerts(portfolio) {
            const alerts = [];
            const targets = DATA.config.targetAllocation || { livret: 55, pea: 30, crypto: 15 };

            if (portfolio.values.total <= 0) return alerts;

            // Calcul allocation actuelle
            const allocation = {
                livret: (portfolio.values.livret / portfolio.values.total) * 100,
                pea: (portfolio.values.pea / portfolio.values.total) * 100,
                crypto: (portfolio.values.crypto / portfolio.values.total) * 100
            };

            // Alerte rÃ©Ã©quilibrage (Ã©cart > 5%)
            Object.keys(targets).forEach(asset => {
                const diff = allocation[asset] - targets[asset];
                if (Math.abs(diff) > 5) {
                    alerts.push({
                        type: 'rebalance',
                        severity: Math.abs(diff) > 10 ? 'high' : 'medium',
                        message: `${asset.toUpperCase()}: ${allocation[asset].toFixed(1)}% vs cible ${targets[asset]}%`,
                        action: diff > 0 ? 'Reduire la part' : 'Augmenter la part'
                    });
                }
            });

            // Alerte opportunitÃ© crypto
            if (DATA.prices.btc.change24h < -10 || DATA.prices.eth.change24h < -10) {
                alerts.push({
                    type: 'opportunity',
                    severity: 'info',
                    message: 'Crypto en forte baisse (-10%+)',
                    action: 'Opportunite achat ?'
                });
            }

            return alerts;
        }

        /**
         * Affiche les alertes
         */
        function renderAlerts() {
            const container = document.getElementById('alertsContainer');
            if (!container) return;

            if (DATA.transactions.length === 0) {
                container.innerHTML = '';
                return;
            }

            const portfolio = calculatePortfolio();
            const alerts = checkAlerts(portfolio);

            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }

            const icons = { rebalance: 'âš–ï¸', opportunity: 'ðŸ’¡', drawdown: 'ðŸ“‰' };

            container.innerHTML = alerts.map(alert => `
                <div class="alert-card ${alert.severity}">
                    <div class="alert-icon">${icons[alert.type] || 'âš ï¸'}</div>
                    <div class="alert-content">
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-action">${alert.action}</div>
                    </div>
                    <button class="alert-dismiss" onclick="this.parentElement.remove()">Ã—</button>
                </div>
            `).join('');
        }

        /**
         * Calcule la suggestion de rÃ©Ã©quilibrage
         */
        function calculateRebalanceSuggestion(nextContribution) {
            const portfolio = calculatePortfolio();
            const targets = DATA.config.targetAllocation || { livret: 55, pea: 30, crypto: 15 };

            if (portfolio.values.total <= 0) {
                // PremiÃ¨re contribution : utiliser les cibles directement
                return {
                    livret: Math.round(nextContribution * targets.livret / 100),
                    pea: Math.round(nextContribution * targets.pea / 100),
                    btc: Math.round(nextContribution * targets.crypto / 100 * 0.7),
                    eth: Math.round(nextContribution * targets.crypto / 100 * 0.3)
                };
            }

            const futureTotal = portfolio.values.total + nextContribution;

            // Allocation idÃ©ale aprÃ¨s versement
            const ideal = {
                livret: futureTotal * targets.livret / 100,
                pea: futureTotal * targets.pea / 100,
                crypto: futureTotal * targets.crypto / 100
            };

            // Combien verser pour atteindre l'idÃ©al
            const suggestion = {
                livret: Math.max(0, ideal.livret - portfolio.values.livret),
                pea: Math.max(0, ideal.pea - portfolio.values.pea),
                crypto: Math.max(0, ideal.crypto - portfolio.values.crypto)
            };

            // Normaliser pour que le total = nextContribution
            const suggestionTotal = suggestion.livret + suggestion.pea + suggestion.crypto;
            if (suggestionTotal > 0) {
                const ratio = nextContribution / suggestionTotal;
                suggestion.livret = Math.round(suggestion.livret * ratio);
                suggestion.pea = Math.round(suggestion.pea * ratio);
                suggestion.crypto = Math.round(suggestion.crypto * ratio);
            }

            return {
                livret: suggestion.livret,
                pea: suggestion.pea,
                btc: Math.round(suggestion.crypto * 0.7),
                eth: Math.round(suggestion.crypto * 0.3)
            };
        }

        /**
         * Met Ã  jour la suggestion affichÃ©e
         */
        function updateRebalanceSuggestion() {
            const livret = parseFloat(document.getElementById('quickLivret').value) || 0;
            const pea = parseFloat(document.getElementById('quickPea').value) || 0;
            const btc = parseFloat(document.getElementById('quickBtc').value) || 0;
            const eth = parseFloat(document.getElementById('quickEth').value) || 0;
            const total = livret + pea + btc + eth;

            const suggestion = calculateRebalanceSuggestion(total);
            const suggestionDiv = document.getElementById('rebalanceSuggestion');

            // VÃ©rifier si la rÃ©partition actuelle diffÃ¨re de la suggestion
            const isDifferent = Math.abs(livret - suggestion.livret) > 20 ||
                               Math.abs(pea - suggestion.pea) > 20 ||
                               Math.abs(btc - suggestion.btc) > 10 ||
                               Math.abs(eth - suggestion.eth) > 5;

            if (isDifferent && DATA.transactions.length > 0) {
                document.getElementById('suggestLivret').textContent = formatCurrency(suggestion.livret);
                document.getElementById('suggestPea').textContent = formatCurrency(suggestion.pea);
                document.getElementById('suggestBtc').textContent = formatCurrency(suggestion.btc);
                document.getElementById('suggestEth').textContent = formatCurrency(suggestion.eth);
                suggestionDiv.style.display = 'block';
            } else {
                suggestionDiv.style.display = 'none';
            }
        }

        /**
         * Applique la suggestion de rÃ©Ã©quilibrage
         */
        function applySuggestion() {
            const livret = parseFloat(document.getElementById('quickLivret').value) || 0;
            const pea = parseFloat(document.getElementById('quickPea').value) || 0;
            const btc = parseFloat(document.getElementById('quickBtc').value) || 0;
            const eth = parseFloat(document.getElementById('quickEth').value) || 0;
            const total = livret + pea + btc + eth;

            const suggestion = calculateRebalanceSuggestion(total);

            document.getElementById('quickLivret').value = suggestion.livret;
            document.getElementById('quickPea').value = suggestion.pea;
            document.getElementById('quickBtc').value = suggestion.btc;
            document.getElementById('quickEth').value = suggestion.eth;

            updatePreview();
            document.getElementById('rebalanceSuggestion').style.display = 'none';
        }

        // ============================================
        // SNAPSHOTS
        // ============================================

        /**
         * Capture un snapshot du portefeuille
         */
        function captureSnapshot() {
            if (DATA.transactions.length === 0) {
                alert('Ajoutez des transactions avant de capturer un snapshot.');
                return;
            }

            const portfolio = calculatePortfolio();

            const snapshot = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                values: {
                    livret: portfolio.values.livret,
                    pea: portfolio.values.pea,
                    btc: portfolio.values.btc,
                    eth: portfolio.values.eth,
                    total: portfolio.values.total
                },
                prices: {
                    btc: DATA.prices.btc.current,
                    eth: DATA.prices.eth.current,
                    sp500: DATA.prices.sp500.current
                },
                invested: portfolio.invested.total
            };

            if (!DATA.snapshots) DATA.snapshots = [];
            DATA.snapshots.push(snapshot);
            saveData();

            // === GAMIFICATION ===
            DATA.gamification.stats.totalSnapshots++;
            awardXP(XP_REWARDS.SNAPSHOT, 'Snapshot capture');
            updateStreaks('snapshot');
            checkBadges();
            updateGamificationDisplay();
            // === FIN GAMIFICATION ===

            updateSnapshotsDisplay();
            alert('Snapshot capture avec succes !');
        }

        /**
         * Supprime un snapshot
         */
        function deleteSnapshot(id) {
            if (!confirm('Supprimer ce snapshot ?')) return;
            DATA.snapshots = (DATA.snapshots || []).filter(s => s.id !== id);
            saveData();
            updateSnapshotsDisplay();
        }

        /**
         * Met Ã  jour l'affichage des snapshots
         */
        function updateSnapshotsDisplay() {
            const snapshots = DATA.snapshots || [];
            const tbody = document.getElementById('snapshotsTableBody');
            const lastDateEl = document.getElementById('lastSnapshotDate');

            if (snapshots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align: center;">Aucun snapshot</td></tr>';
                lastDateEl.textContent = 'Jamais';
                return;
            }

            // Dernier snapshot
            const lastSnapshot = snapshots[snapshots.length - 1];
            lastDateEl.textContent = formatDate(lastSnapshot.date);

            // Tableau
            tbody.innerHTML = snapshots.slice().reverse().map(s => `
                <tr>
                    <td>${formatDate(s.date)}</td>
                    <td>${formatCurrency(s.values.total)}</td>
                    <td>${formatCurrency(s.prices.btc)}</td>
                    <td>${formatCurrency(s.prices.eth)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteSnapshot('${s.id}')">&times;</button>
                    </td>
                </tr>
            `).join('');
        }

        // ============================================
        // EXPORT PDF
        // ============================================

        /**
         * Exporte un rapport PDF professionnel
         */
        // ============================================
        // DONNÃ‰ES MACRO
        // ============================================

        /**
         * RÃ©cupÃ¨re les donnÃ©es macroÃ©conomiques
         */
        // ============================================
        // PROJECTIONS MONTE CARLO
        // ============================================

        /**
         * GÃ©nÃ¨re un nombre alÃ©atoire suivant une distribution normale
         */
        function gaussianRandom(mean, std) {
            const u1 = Math.random();
            const u2 = Math.random();
            const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return mean + std * z;
        }

        /**
         * Simulation Monte Carlo
         */
        function runMonteCarloSimulation(initialValue, monthlyContribution, months, numSimulations = 1000) {
            const results = [];

            // ParamÃ¨tres basÃ©s sur un portefeuille mixte
            const meanReturn = 0.007; // ~8.4% annualisÃ©
            const volatility = 0.04;  // ~14% annualisÃ©

            for (let sim = 0; sim < numSimulations; sim++) {
                let value = initialValue;

                for (let month = 0; month < months; month++) {
                    value += monthlyContribution;
                    const randomReturn = gaussianRandom(meanReturn, volatility);
                    value *= (1 + randomReturn);
                }

                results.push(value);
            }

            results.sort((a, b) => a - b);

            return {
                pessimistic: results[Math.floor(numSimulations * 0.1)],
                median: results[Math.floor(numSimulations * 0.5)],
                optimistic: results[Math.floor(numSimulations * 0.9)],
                min: results[0],
                max: results[results.length - 1]
            };
        }

        /**
         * Lance les projections et affiche les rÃ©sultats
         */
        function runProjections() {
            const portfolio = calculatePortfolio();
            const currentValue = portfolio.values.total;
            const monthlyContribution = DATA.config.monthlyBudget || 800;

            const projections = runMonteCarloSimulation(currentValue, monthlyContribution, 15);

            document.getElementById('projPessimistic').textContent = formatCurrency(projections.pessimistic);
            document.getElementById('projMedian').textContent = formatCurrency(projections.median);
            document.getElementById('projOptimistic').textContent = formatCurrency(projections.optimistic);
        }

        async function refreshMacro() {
            try {
                // Fear & Greed Index
                const fgResponse = await fetch('https://api.alternative.me/fng/?limit=1');
                const fgData = await fgResponse.json();
                if (fgData.data && fgData.data[0]) {
                    const fg = fgData.data[0];
                    const fgEl = document.getElementById('macroFearGreed');
                    fgEl.textContent = fg.value;
                    document.getElementById('macroFGLabel').textContent = fg.value_classification;

                    if (fg.value < 25) fgEl.style.color = 'var(--danger)';
                    else if (fg.value < 50) fgEl.style.color = 'var(--warning)';
                    else fgEl.style.color = 'var(--success)';
                }

                // Global Crypto Data
                const globalResponse = await fetch('https://api.coingecko.com/api/v3/global');
                const globalData = await globalResponse.json();
                if (globalData.data) {
                    document.getElementById('macroBTCDom').textContent = globalData.data.market_cap_percentage.btc.toFixed(1) + '%';

                    const mcap = globalData.data.total_market_cap.eur;
                    if (mcap >= 1e12) {
                        document.getElementById('macroCryptoMcap').textContent = (mcap / 1e12).toFixed(2) + 'T';
                    } else {
                        document.getElementById('macroCryptoMcap').textContent = (mcap / 1e9).toFixed(0) + 'B';
                    }
                }

                // BTC/ETH 24h changes
                const btc24h = document.getElementById('macroBTC24h');
                const eth24h = document.getElementById('macroETH24h');

                btc24h.textContent = formatChange(DATA.prices.btc.change24h);
                btc24h.style.color = DATA.prices.btc.change24h >= 0 ? 'var(--success)' : 'var(--danger)';

                eth24h.textContent = formatChange(DATA.prices.eth.change24h);
                eth24h.style.color = DATA.prices.eth.change24h >= 0 ? 'var(--success)' : 'var(--danger)';

                document.getElementById('macroSection').style.display = 'block';

            } catch (error) {
                console.error('Erreur donnees macro:', error);
            }
        }

        // ============================================
        // MODULE INTELLIGENCE - APIs
        // ============================================

        /**
         * RÃ©cupÃ¨re l'historique des prix (CoinGecko)
         */
        async function fetchPriceHistory(coinId = 'bitcoin', days = 200) {
            try {
                const response = await fetch(
                    `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=eur&days=${days}&interval=daily`
                );
                const data = await response.json();
                if (data.prices) {
                    return data.prices.map(p => ({
                        timestamp: p[0],
                        date: new Date(p[0]).toISOString().split('T')[0],
                        price: p[1]
                    }));
                }
            } catch (error) {
                console.error('Erreur historique prix:', error);
            }
            return [];
        }

        /**
         * Calcule la moyenne mobile simple
         */
        function calculateSMA(prices, period) {
            if (prices.length < period) return null;
            const relevantPrices = prices.slice(-period);
            const sum = relevantPrices.reduce((acc, p) => acc + p.price, 0);
            return sum / period;
        }

        /**
         * Calcule le RSI (Relative Strength Index)
         */
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return null;
            const relevantPrices = prices.slice(-(period + 1));
            let gains = 0, losses = 0;
            for (let i = 1; i < relevantPrices.length; i++) {
                const change = relevantPrices[i].price - relevantPrices[i-1].price;
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return Math.round((100 - (100 / (1 + rs))) * 10) / 10;
        }

        /**
         * DÃ©tecte les croisements de moyennes mobiles
         */
        function detectMACross(prices) {
            if (prices.length < 201) return 'insufficient_data';
            const ma50Current = calculateSMA(prices, 50);
            const ma200Current = calculateSMA(prices, 200);
            const pricesMinus5 = prices.slice(0, -5);
            const ma50Previous = calculateSMA(pricesMinus5, 50);
            const ma200Previous = calculateSMA(pricesMinus5, 200);

            if (ma50Previous < ma200Previous && ma50Current > ma200Current) return 'golden_cross';
            if (ma50Previous > ma200Previous && ma50Current < ma200Current) return 'death_cross';
            if (ma50Current > ma200Current) return 'bullish';
            return 'bearish';
        }

        /**
         * Calcule le score de timing global (0-100)
         */
        function calculateTimingScore() {
            const intel = DATA.marketIntelligence;
            let score = 50;
            let factors = [];

            // Fear & Greed (inversÃ© : peur = bon moment)
            const fg = intel.fearGreed.value;
            if (fg < 25) { score += 15; factors.push({ name: 'Fear & Greed', impact: '+15', reason: 'Extreme Fear' }); }
            else if (fg < 45) { score += 8; factors.push({ name: 'Fear & Greed', impact: '+8', reason: 'Fear' }); }
            else if (fg > 75) { score -= 15; factors.push({ name: 'Fear & Greed', impact: '-15', reason: 'Extreme Greed' }); }
            else if (fg > 55) { score -= 5; factors.push({ name: 'Fear & Greed', impact: '-5', reason: 'Greed' }); }

            // Position vs MA200
            const btcPrice = DATA.prices.btc.current;
            const ma200 = intel.btc.ma200;
            if (ma200 && btcPrice > 0) {
                const deviation = ((btcPrice - ma200) / ma200) * 100;
                if (deviation < -20) { score += 20; factors.push({ name: 'Prix vs MA200', impact: '+20', reason: '>20% sous MA200' }); }
                else if (deviation < -10) { score += 12; factors.push({ name: 'Prix vs MA200', impact: '+12', reason: '10-20% sous MA200' }); }
                else if (deviation < 0) { score += 5; factors.push({ name: 'Prix vs MA200', impact: '+5', reason: 'Sous MA200' }); }
                else if (deviation > 30) { score -= 15; factors.push({ name: 'Prix vs MA200', impact: '-15', reason: '>30% sur MA200' }); }
                else if (deviation > 15) { score -= 8; factors.push({ name: 'Prix vs MA200', impact: '-8', reason: '15-30% sur MA200' }); }
            }

            // RSI
            const rsi = intel.btc.rsi14;
            if (rsi !== null) {
                if (rsi < 30) { score += 18; factors.push({ name: 'RSI', impact: '+18', reason: 'Survendu (' + rsi + ')' }); }
                else if (rsi < 40) { score += 8; factors.push({ name: 'RSI', impact: '+8', reason: 'Zone basse (' + rsi + ')' }); }
                else if (rsi > 70) { score -= 15; factors.push({ name: 'RSI', impact: '-15', reason: 'Surachete (' + rsi + ')' }); }
                else if (rsi > 60) { score -= 5; factors.push({ name: 'RSI', impact: '-5', reason: 'Zone haute (' + rsi + ')' }); }
            }

            // Tendance MA
            const trend = intel.btc.trend;
            if (trend === 'golden_cross') { score += 12; factors.push({ name: 'Tendance', impact: '+12', reason: 'Golden Cross' }); }
            else if (trend === 'death_cross') { score -= 10; factors.push({ name: 'Tendance', impact: '-10', reason: 'Death Cross' }); }
            else if (trend === 'bullish') { score += 5; factors.push({ name: 'Tendance', impact: '+5', reason: 'Haussiere' }); }

            score = Math.max(0, Math.min(100, Math.round(score)));
            return { score, factors, recommendation: getTimingRecommendation(score) };
        }

        function getTimingRecommendation(score) {
            if (score >= 75) return { action: 'RENFORCER', emoji: 'ðŸš€', message: 'Excellent moment pour renforcer', color: 'var(--success)' };
            if (score >= 55) return { action: 'DCA_NORMAL', emoji: 'âœ…', message: 'Bon moment - Continuez le DCA', color: 'var(--success)' };
            if (score >= 40) return { action: 'NEUTRE', emoji: 'âž¡ï¸', message: 'Moment neutre - DCA standard', color: 'var(--warning)' };
            if (score >= 25) return { action: 'PRUDENCE', emoji: 'âš ï¸', message: 'Prudence - Marche tendu', color: 'var(--warning)' };
            return { action: 'ATTENDRE', emoji: 'ðŸ›‘', message: 'Euphorie - Patience recommandee', color: 'var(--danger)' };
        }

        /**
         * Actualise toute l'intelligence marchÃ©
         */
        async function refreshMarketIntelligence() {
            console.log('Demarrage refresh intelligence...');

            try {
                // Fear & Greed Index (via CORS proxy ou directement)
                try {
                    const fgResponse = await fetch('https://api.alternative.me/fng/?limit=1');
                    if (fgResponse.ok) {
                        const fgData = await fgResponse.json();
                        if (fgData.data && fgData.data[0]) {
                            DATA.marketIntelligence.fearGreed = {
                                value: parseInt(fgData.data[0].value),
                                label: fgData.data[0].value_classification
                            };
                            console.log('Fear & Greed charge:', DATA.marketIntelligence.fearGreed);
                        }
                    }
                } catch (fgError) {
                    console.warn('Fear & Greed API non disponible, utilisation cache');
                }

                // Historique BTC
                try {
                    const btcHistory = await fetchPriceHistory('bitcoin', 200);
                    if (btcHistory.length > 0) {
                        DATA.marketIntelligence.btc.prices = btcHistory;
                        DATA.marketIntelligence.btc.ma50 = calculateSMA(btcHistory, 50);
                        DATA.marketIntelligence.btc.ma200 = calculateSMA(btcHistory, 200);
                        DATA.marketIntelligence.btc.rsi14 = calculateRSI(btcHistory, 14);
                        DATA.marketIntelligence.btc.trend = detectMACross(btcHistory);
                        console.log('Indicateurs BTC calcules:', {
                            ma50: DATA.marketIntelligence.btc.ma50,
                            ma200: DATA.marketIntelligence.btc.ma200,
                            rsi14: DATA.marketIntelligence.btc.rsi14,
                            trend: DATA.marketIntelligence.btc.trend
                        });
                    }
                } catch (histError) {
                    console.warn('Historique BTC non disponible:', histError);
                }

                // Score de timing
                const timing = calculateTimingScore();
                DATA.marketIntelligence.timingScore = timing.score;
                DATA.marketIntelligence.recommendation = timing.recommendation.action;
                DATA.marketIntelligence.lastUpdate = new Date().toISOString();

                updateTimingDisplay(timing);
                updateIndicatorsDisplay();
                saveData();
                console.log('Intelligence refresh complete, score:', timing.score);
            } catch (error) {
                console.error('Erreur refresh intelligence:', error);
                // Afficher quand mÃªme avec les valeurs par dÃ©faut
                const timing = calculateTimingScore();
                updateTimingDisplay(timing);
                updateIndicatorsDisplay();
            }
        }

        function updateTimingDisplay(timing) {
            const scoreEl = document.getElementById('timingScoreValue');
            const circleEl = document.getElementById('scoreCircleFill');
            if (!scoreEl || !circleEl) return;

            scoreEl.textContent = timing.score;
            const offset = 283 - (timing.score / 100) * 283;
            circleEl.style.strokeDashoffset = offset;
            circleEl.style.stroke = timing.score >= 60 ? 'var(--success)' : timing.score >= 40 ? 'var(--warning)' : 'var(--danger)';

            const reco = timing.recommendation;
            document.getElementById('recoEmoji').textContent = reco.emoji;
            document.getElementById('recoAction').textContent = reco.action;
            document.getElementById('recoAction').style.color = reco.color;
            document.getElementById('recoMessage').textContent = reco.message;

            const factorsEl = document.getElementById('timingFactors');
            if (factorsEl) {
                factorsEl.innerHTML = timing.factors.map(f => `
                    <div class="timing-factor">
                        <span class="factor-name">${f.name}</span>
                        <span class="factor-impact ${f.impact.startsWith('+') ? 'positive' : 'negative'}">${f.impact}</span>
                    </div>
                `).join('');
            }

            document.getElementById('timingLastUpdate').textContent = new Date().toLocaleString('fr-FR');
        }

        function updateIndicatorsDisplay() {
            const intel = DATA.marketIntelligence;

            // Fear & Greed
            const fgValEl = document.getElementById('fgValue');
            const fgLabelEl = document.getElementById('fgLabel');
            const fgBarEl = document.getElementById('fgBar');
            if (fgValEl) {
                fgValEl.textContent = intel.fearGreed.value;
                const fgClass = intel.fearGreed.value <= 25 ? 'fear' : intel.fearGreed.value >= 75 ? 'greed' : 'neutral';
                fgLabelEl.textContent = intel.fearGreed.label;
                fgLabelEl.className = 'indicator-label ' + fgClass;
                if (fgBarEl) {
                    fgBarEl.style.width = intel.fearGreed.value + '%';
                    fgBarEl.style.background = intel.fearGreed.value <= 25 ? 'var(--danger)' : intel.fearGreed.value >= 75 ? 'var(--success)' : 'var(--warning)';
                }
            }

            // RSI
            const rsi = intel.btc.rsi14;
            const rsiValEl = document.getElementById('rsiValue');
            const rsiLabelEl = document.getElementById('rsiLabel');
            const rsiBarEl = document.getElementById('rsiBar');
            if (rsiValEl && rsi !== null) {
                rsiValEl.textContent = rsi.toFixed(1);
                const rsiClass = rsi < 30 ? 'bullish' : rsi > 70 ? 'bearish' : 'neutral';
                rsiLabelEl.textContent = rsi < 30 ? 'Survendu' : rsi > 70 ? 'Surachete' : 'Neutre';
                rsiLabelEl.className = 'indicator-label ' + rsiClass;
                if (rsiBarEl) {
                    rsiBarEl.style.width = rsi + '%';
                    rsiBarEl.style.background = rsi < 30 ? 'var(--success)' : rsi > 70 ? 'var(--danger)' : 'var(--warning)';
                }
            }

            // MA50
            const price = DATA.prices.btc.current;
            const ma50ValEl = document.getElementById('ma50Value');
            const ma50LabelEl = document.getElementById('ma50Label');
            if (intel.btc.ma50 && price > 0 && ma50ValEl) {
                const dev50 = ((price - intel.btc.ma50) / intel.btc.ma50) * 100;
                ma50ValEl.textContent = (dev50 >= 0 ? '+' : '') + dev50.toFixed(1) + '%';
                ma50LabelEl.textContent = dev50 >= 0 ? 'Au-dessus' : 'En-dessous';
                ma50LabelEl.className = 'indicator-label ' + (dev50 >= 0 ? 'bullish' : 'bearish');
            }

            // MA200
            const ma200ValEl = document.getElementById('ma200Value');
            const ma200LabelEl = document.getElementById('ma200Label');
            if (intel.btc.ma200 && price > 0 && ma200ValEl) {
                const dev200 = ((price - intel.btc.ma200) / intel.btc.ma200) * 100;
                ma200ValEl.textContent = (dev200 >= 0 ? '+' : '') + dev200.toFixed(1) + '%';
                ma200LabelEl.textContent = dev200 >= 0 ? 'Au-dessus' : 'En-dessous';
                ma200LabelEl.className = 'indicator-label ' + (dev200 >= 0 ? 'bullish' : 'bearish');
            }

            // Tendance
            const trendLabels = { golden_cross: 'Golden Cross', death_cross: 'Death Cross', bullish: 'Haussiere', bearish: 'Baissiere', neutral: 'Neutre' };
            const trendIcons = { golden_cross: 'ðŸš€', death_cross: 'ðŸ’€', bullish: 'ðŸ“ˆ', bearish: 'ðŸ“‰', neutral: 'âž¡ï¸' };
            const trendValEl = document.getElementById('trendValue');
            const trendLabelEl = document.getElementById('trendLabel');
            if (trendValEl) {
                const trend = intel.btc.trend || 'neutral';
                trendValEl.textContent = trendIcons[trend] || 'âž¡ï¸';
                trendLabelEl.textContent = trendLabels[trend] || 'Neutre';
                const trendClass = (trend === 'bullish' || trend === 'golden_cross') ? 'bullish' : (trend === 'bearish' || trend === 'death_cross') ? 'bearish' : 'neutral';
                trendLabelEl.className = 'indicator-label ' + trendClass;
            }
        }

        // ============================================
        // MODULE GAMIFICATION
        // ============================================

        // SystÃ¨me de niveaux
        const LEVELS = [
            { level: 1, title: 'Debutant', xpRequired: 0, icon: 'ðŸŒ±' },
            { level: 2, title: 'Apprenti Investisseur', xpRequired: 100, icon: 'ðŸ“š' },
            { level: 3, title: 'Investisseur Confirme', xpRequired: 300, icon: 'ðŸ’¼' },
            { level: 4, title: 'Stratege', xpRequired: 600, icon: 'ðŸŽ¯' },
            { level: 5, title: 'Expert DCA', xpRequired: 1000, icon: 'ðŸ“ˆ' },
            { level: 6, title: 'Maitre du Timing', xpRequired: 1500, icon: 'â±ï¸' },
            { level: 7, title: 'Diamant Hands', xpRequired: 2200, icon: 'ðŸ’Ž' },
            { level: 8, title: 'Veteran des Marches', xpRequired: 3000, icon: 'ðŸŽ–ï¸' },
            { level: 9, title: 'Sage Financier', xpRequired: 4000, icon: 'ðŸ§™' },
            { level: 10, title: 'Titan de l\'Investissement', xpRequired: 5500, icon: 'âš¡' },
            { level: 11, title: 'Legende Olympienne', xpRequired: 7500, icon: 'ðŸ›ï¸' },
            { level: 12, title: 'Olympus Founder', xpRequired: 10000, icon: 'ðŸ‘‘' }
        ];

        // RÃ©compenses XP
        const XP_REWARDS = {
            VERSEMENT: 25,              // Chaque versement
            VERSEMENT_COMPLET: 10,      // Versement sur 4 actifs
            SNAPSHOT: 15,               // Chaque snapshot
            STREAK_DCA_WEEK: 20,        // DCA maintenu sur 1 semaine
            STREAK_DCA_MONTH: 50,       // DCA maintenu sur 1 mois
            STREAK_SNAPSHOT_WEEK: 15,   // Snapshots rÃ©guliers
            FEAR_BUYER: 100,            // Achat en Extreme Fear
            DRAWDOWN_SURVIVOR: 75,      // Survie Ã  un drawdown -20%
            FIRST_1000: 50,             // Premier 1000â‚¬
            FIRST_10000: 100,           // Premier 10000â‚¬
            FIRST_YEAR: 200,            // 1 an de suivi
            DIVERSIFIED: 30             // 4 actifs dans le portfolio
        };

        // DÃ©finition des badges
        const BADGES = [
            { id: 'first_step', name: 'Premier Pas', icon: 'ðŸ‘£', desc: 'Premier versement effectue', condition: (stats) => stats.totalContributions >= 1 },
            { id: 'regular', name: 'Regulier', icon: 'ðŸ“…', desc: '3 versements consecutifs', condition: (stats) => stats.totalContributions >= 3 },
            { id: 'disciplined', name: 'Discipline', icon: 'ðŸŽ¯', desc: '6 mois de DCA', condition: (stats) => stats.totalContributions >= 6 },
            { id: 'veteran', name: 'Veteran', icon: 'ðŸŽ–ï¸', desc: '12 mois de DCA', condition: (stats) => stats.totalContributions >= 12 },
            { id: 'marathon', name: 'Marathonien', icon: 'ðŸƒ', desc: '24 mois de DCA', condition: (stats) => stats.totalContributions >= 24 },
            { id: 'fear_buyer', name: 'Acheteur de Peur', icon: 'ðŸ˜±', desc: 'Achat en Extreme Fear', condition: (stats) => stats.boughtInExtremeFear },
            { id: 'diamond_hands', name: 'Mains de Diamant', icon: 'ðŸ’Ž', desc: 'Survie a un drawdown -20%', condition: (stats) => stats.survivedDrawdowns.length > 0 },
            { id: 'diversified', name: 'Diversifie', icon: 'ðŸŽ¨', desc: 'Investir sur 4 actifs', condition: () => {
                const h = DATA.holdings;
                return h.livret > 0 && h.spShares > 0 && h.btcQty > 0 && h.ethQty > 0;
            }},
            { id: 'snapshot_fan', name: 'Fan des Snapshots', icon: 'ðŸ“¸', desc: '10 snapshots captures', condition: (stats) => stats.totalSnapshots >= 10 },
            { id: 'archivist', name: 'Archiviste', icon: 'ðŸ“š', desc: '50 snapshots captures', condition: (stats) => stats.totalSnapshots >= 50 },
            { id: 'k1', name: 'Club des 1K', icon: 'ðŸ’µ', desc: 'Atteindre 1 000â‚¬ de patrimoine', condition: () => {
                const p = calculatePortfolio();
                return p.values.total >= 1000;
            }},
            { id: 'k10', name: 'Club des 10K', icon: 'ðŸ’°', desc: 'Atteindre 10 000â‚¬ de patrimoine', condition: () => {
                const p = calculatePortfolio();
                return p.values.total >= 10000;
            }},
            { id: 'k50', name: 'Club des 50K', icon: 'ðŸ†', desc: 'Atteindre 50 000â‚¬ de patrimoine', condition: () => {
                const p = calculatePortfolio();
                return p.values.total >= 50000;
            }},
            { id: 'k100', name: 'Club des 100K', icon: 'ðŸ‘‘', desc: 'Atteindre 100 000â‚¬ de patrimoine', condition: () => {
                const p = calculatePortfolio();
                return p.values.total >= 100000;
            }},
            { id: 'positive_year', name: 'Annee Positive', icon: 'ðŸ“ˆ', desc: '1 an avec gain positif', condition: () => {
                const m = calculateAllMetrics();
                return m.monthlyReturns.length >= 12 && m.totalReturn > 0;
            }},
            { id: 'sharpe_star', name: 'Etoile du Sharpe', icon: 'â­', desc: 'Sharpe Ratio > 1', condition: () => {
                const m = calculateAllMetrics();
                return m.sharpe > 1;
            }},
            { id: 'low_dd', name: 'Gestion du Risque', icon: 'ðŸ›¡ï¸', desc: 'Max Drawdown < 10%', condition: () => {
                const m = calculateAllMetrics();
                return m.maxDD < 10 && DATA.transactions.length >= 6;
            }},
            { id: 'streak_master', name: 'Maitre des Streaks', icon: 'ðŸ”¥', desc: 'Streak DCA de 12 mois', condition: (stats) => stats.longestDCA >= 12 },
            { id: 'timing_expert', name: 'Expert Timing', icon: 'â°', desc: '5 achats avec score > 70', condition: (stats) => stats.highTimingBuys >= 5 },
            { id: 'olympian', name: 'Olympien', icon: 'ðŸ›ï¸', desc: 'Atteindre le niveau 10', condition: () => DATA.gamification.level >= 10 }
        ];

        // Calculer le niveau actuel
        function calculateLevel(xp) {
            let currentLevel = LEVELS[0];
            for (const level of LEVELS) {
                if (xp >= level.xpRequired) {
                    currentLevel = level;
                } else {
                    break;
                }
            }
            return currentLevel;
        }

        // Obtenir le prochain niveau
        function getNextLevel(currentLevel) {
            const idx = LEVELS.findIndex(l => l.level === currentLevel);
            return idx < LEVELS.length - 1 ? LEVELS[idx + 1] : null;
        }

        // Attribuer des XP avec animation
        function awardXP(amount, reason = '') {
            const oldXP = DATA.gamification.xp;
            const oldLevel = calculateLevel(oldXP);

            DATA.gamification.xp += amount;
            const newLevel = calculateLevel(DATA.gamification.xp);

            // Mettre Ã  jour le niveau
            DATA.gamification.level = newLevel.level;
            DATA.gamification.title = newLevel.title;

            // Sauvegarder
            saveData();

            // Animation XP popup
            showXPPopup(amount, reason);

            // Level up?
            if (newLevel.level > oldLevel.level) {
                setTimeout(() => showLevelUp(newLevel), 1500);
            }

            // Mettre Ã  jour l'affichage
            updateGamificationDisplay();
        }

        // Afficher popup XP
        function showXPPopup(amount, reason) {
            const popup = document.createElement('div');
            popup.className = 'xp-popup';
            popup.innerHTML = `+${amount} XP` + (reason ? `<br><small>${reason}</small>` : '');
            document.body.appendChild(popup);

            setTimeout(() => popup.remove(), 1500);
        }

        // Afficher modal Level Up
        function showLevelUp(level) {
            const overlay = document.getElementById('levelupOverlay');
            if (!overlay) return;

            document.getElementById('levelupIcon').textContent = level.icon;
            document.getElementById('levelupLevel').textContent = `Niveau ${level.level} - ${level.title}`;
            overlay.classList.add('active');
        }

        // Fermer modal Level Up
        function closeLevelUp() {
            const overlay = document.getElementById('levelupOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // VÃ©rifier et dÃ©bloquer les badges
        function checkBadges() {
            const stats = {
                totalContributions: DATA.gamification.stats.totalContributions,
                totalSnapshots: DATA.gamification.stats.totalSnapshots,
                boughtInExtremeFear: DATA.gamification.stats.boughtInExtremeFear,
                survivedDrawdowns: DATA.gamification.stats.survivedDrawdowns,
                longestDCA: DATA.gamification.streaks.longestDCA,
                highTimingBuys: DATA.gamification.stats.highTimingBuys || 0
            };

            let newBadges = [];

            for (const badge of BADGES) {
                if (!DATA.gamification.badges.includes(badge.id)) {
                    try {
                        if (badge.condition(stats)) {
                            DATA.gamification.badges.push(badge.id);
                            newBadges.push(badge);
                        }
                    } catch (e) {
                        // Condition non satisfaite ou erreur
                    }
                }
            }

            if (newBadges.length > 0) {
                saveData();
                // Afficher notification pour chaque nouveau badge
                newBadges.forEach((badge, i) => {
                    setTimeout(() => {
                        showBadgeNotification(badge);
                    }, i * 2000);
                });
            }

            return newBadges;
        }

        // Notification de nouveau badge
        function showBadgeNotification(badge) {
            const popup = document.createElement('div');
            popup.className = 'xp-popup';
            popup.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            popup.innerHTML = `${badge.icon}<br><strong>Badge Debloque!</strong><br><small>${badge.name}</small>`;
            document.body.appendChild(popup);

            setTimeout(() => popup.remove(), 2000);
        }

        // Mettre Ã  jour les streaks
        function updateStreaks(type) {
            const today = new Date().toISOString().split('T')[0];

            if (type === 'dca') {
                const lastDate = DATA.gamification.lastDCADate;
                if (lastDate) {
                    const daysDiff = Math.floor((new Date(today) - new Date(lastDate)) / (1000 * 60 * 60 * 24));
                    if (daysDiff <= 35) { // ~1 mois de tolerance
                        DATA.gamification.streaks.currentDCA++;
                    } else {
                        DATA.gamification.streaks.currentDCA = 1;
                    }
                } else {
                    DATA.gamification.streaks.currentDCA = 1;
                }
                DATA.gamification.lastDCADate = today;

                // Record?
                if (DATA.gamification.streaks.currentDCA > DATA.gamification.streaks.longestDCA) {
                    DATA.gamification.streaks.longestDCA = DATA.gamification.streaks.currentDCA;
                }

                // XP bonus pour streaks
                if (DATA.gamification.streaks.currentDCA === 4) {
                    awardXP(XP_REWARDS.STREAK_DCA_WEEK, 'Streak 1 mois!');
                }
            }

            if (type === 'snapshot') {
                const lastDate = DATA.gamification.lastSnapshotDate;
                if (lastDate) {
                    const daysDiff = Math.floor((new Date(today) - new Date(lastDate)) / (1000 * 60 * 60 * 24));
                    if (daysDiff <= 8) { // ~1 semaine de tolerance
                        DATA.gamification.streaks.currentSnapshot++;
                    } else {
                        DATA.gamification.streaks.currentSnapshot = 1;
                    }
                } else {
                    DATA.gamification.streaks.currentSnapshot = 1;
                }
                DATA.gamification.lastSnapshotDate = today;

                if (DATA.gamification.streaks.currentSnapshot > DATA.gamification.streaks.longestSnapshot) {
                    DATA.gamification.streaks.longestSnapshot = DATA.gamification.streaks.currentSnapshot;
                }
            }

            saveData();
        }

        // Mettre Ã  jour l'affichage gamification
        function updateGamificationDisplay() {
            const gam = DATA.gamification;
            const currentLevel = calculateLevel(gam.xp);
            const nextLevel = getNextLevel(currentLevel.level);

            // Avatar et niveau
            const avatarEl = document.getElementById('profileAvatar');
            if (avatarEl) avatarEl.textContent = currentLevel.icon;

            const levelEl = document.getElementById('profileLevel');
            if (levelEl) levelEl.textContent = `NIVEAU ${currentLevel.level}`;

            const titleEl = document.getElementById('profileTitle');
            if (titleEl) titleEl.textContent = currentLevel.title;

            // Barre XP
            if (nextLevel) {
                const xpInLevel = gam.xp - currentLevel.xpRequired;
                const xpNeeded = nextLevel.xpRequired - currentLevel.xpRequired;
                const progress = (xpInLevel / xpNeeded) * 100;

                const barEl = document.getElementById('xpBarFill');
                if (barEl) barEl.style.width = progress + '%';

                const textEl = document.getElementById('xpText');
                if (textEl) textEl.textContent = `${gam.xp} / ${nextLevel.xpRequired} XP`;
            } else {
                // Max level
                const barEl = document.getElementById('xpBarFill');
                if (barEl) barEl.style.width = '100%';

                const textEl = document.getElementById('xpText');
                if (textEl) textEl.textContent = `${gam.xp} XP - NIVEAU MAX`;
            }

            // Stats
            const contribEl = document.getElementById('statContributions');
            if (contribEl) contribEl.textContent = gam.stats.totalContributions;

            const snapsEl = document.getElementById('statSnapshots');
            if (snapsEl) snapsEl.textContent = gam.stats.totalSnapshots;

            const badgesEl = document.getElementById('statBadges');
            if (badgesEl) badgesEl.textContent = gam.badges.length + '/' + BADGES.length;

            // Streaks
            const dcaStreakEl = document.getElementById('dcaStreakValue');
            if (dcaStreakEl) dcaStreakEl.textContent = gam.streaks.currentDCA;

            const dcaBestEl = document.getElementById('dcaStreakBest');
            if (dcaBestEl) dcaBestEl.textContent = 'Record: ' + gam.streaks.longestDCA;

            const snapStreakEl = document.getElementById('snapStreakValue');
            if (snapStreakEl) snapStreakEl.textContent = gam.streaks.currentSnapshot;

            const snapBestEl = document.getElementById('snapStreakBest');
            if (snapBestEl) snapBestEl.textContent = 'Record: ' + gam.streaks.longestSnapshot;

            // Badges grid
            renderBadges();
        }

        // Afficher les badges
        function renderBadges() {
            const container = document.getElementById('badgesGrid');
            if (!container) return;

            const unlockedCount = DATA.gamification.badges.length;
            const totalCount = BADGES.length;

            container.innerHTML = BADGES.map(badge => {
                const unlocked = DATA.gamification.badges.includes(badge.id);
                return `
                    <div class="badge-item ${unlocked ? 'unlocked' : 'locked'}" title="${badge.desc}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-desc">${badge.desc}</div>
                        <div class="badge-status">${unlocked ? 'âœ“ Obtenu' : 'A debloquer'}</div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // SYSTÃˆME DE TOOLTIPS PÃ‰DAGOGIQUES
        // ============================================

        const TOOLTIPS_DATA = {
            // MÃ‰TRIQUES DE PERFORMANCE
            twr: {
                name: "TWR (Time-Weighted Return)",
                emoji: "ðŸ“ˆ",
                definition: "Rendement qui elimine l'impact du timing des versements. Mesure la performance 'pure' de votre strategie d'investissement.",
                formula: "TWR = [(1+Râ‚) Ã— (1+Râ‚‚) Ã— ... Ã— (1+Rn)] - 1",
                formulaLegend: ["Ri = Rendement de chaque sous-periode entre les flux"],
                interpretation: [
                    { range: "< 0%", label: "Perte", class: "bad" },
                    { range: "0-5%", label: "Faible", class: "ok" },
                    { range: "5-10%", label: "Correct", class: "good" },
                    { range: "> 10%", label: "Excellent", class: "excellent" }
                ],
                example: "Si votre portefeuille passe de 1000â‚¬ a 1100â‚¬ (+10%), puis vous ajoutez 500â‚¬, puis il passe a 1700â‚¬ (+6.25%), le TWR = (1.10 Ã— 1.0625) - 1 = 16.88%",
                proTip: "Le TWR est utilise par les fonds professionnels car il permet de comparer les performances independamment des flux de capitaux."
            },
            mwr: {
                name: "MWR (Money-Weighted Return)",
                emoji: "ðŸ’°",
                definition: "Taux de Rentabilite Interne (TRI). Prend en compte le timing et le montant de VOS versements. C'est VOTRE rendement reel.",
                formula: "Resoudre : Î£(Flux_t / (1+r)^t) = 0",
                formulaLegend: ["Flux_t = Montant au temps t", "r = Taux recherche"],
                interpretation: [
                    { range: "< Livret A (3%)", label: "Sous-performance", class: "bad" },
                    { range: "3-7%", label: "Correct", class: "ok" },
                    { range: "7-12%", label: "Bon", class: "good" },
                    { range: "> 12%", label: "Excellent", class: "excellent" }
                ],
                example: "Si vous investissez 100â‚¬ en janvier et 100â‚¬ en juin, et finissez avec 220â‚¬ en decembre, le MWR calcule le taux qui equilibre ces flux.",
                proTip: "MWR > TWR signifie que vous avez investi plus quand le marche etait bas (bon timing). MWR < TWR signifie l'inverse."
            },
            sharpe: {
                name: "Sharpe Ratio",
                emoji: "ðŸ“Š",
                definition: "Mesure le rendement excedentaire obtenu par unite de risque prise. Invente par William Sharpe (Prix Nobel 1990).",
                formula: "Sharpe = (Rp - Rf) / Ïƒp",
                formulaLegend: ["Rp = Rendement annualise", "Rf = Taux sans risque (3%)", "Ïƒp = Volatilite annualisee"],
                interpretation: [
                    { range: "< 0.5", label: "Faible", class: "bad" },
                    { range: "0.5 - 1.0", label: "Acceptable", class: "ok" },
                    { range: "1.0 - 2.0", label: "Bon", class: "good" },
                    { range: "> 2.0", label: "Excellent (rare)", class: "excellent" }
                ],
                example: "Rendement 12%, Rf 3%, Volatilite 15% â†’ Sharpe = (12-3)/15 = 0.60",
                proTip: "Le Sharpe du S&P 500 historique est d'environ 0.4-0.5. Un Sharpe > 1 est difficile a maintenir sur le long terme."
            },
            sortino: {
                name: "Sortino Ratio",
                emoji: "ðŸŽ¯",
                definition: "Comme le Sharpe, mais ne penalise que la volatilite NEGATIVE. Les hausses ne sont pas considerees comme du 'risque'.",
                formula: "Sortino = (Rp - Rf) / Ïƒd",
                formulaLegend: ["Ïƒd = Downside deviation (ecart-type des rendements negatifs uniquement)"],
                interpretation: [
                    { range: "< 1.0", label: "Faible", class: "bad" },
                    { range: "1.0 - 2.0", label: "Bon", class: "good" },
                    { range: "> 2.0", label: "Excellent", class: "excellent" }
                ],
                example: "Si vous avez beaucoup de hausses mais peu de baisses, votre Sortino sera bien meilleur que votre Sharpe.",
                proTip: "Sortino > Sharpe indique que votre volatilite vient surtout des hausses (positif). Sortino < Sharpe indique l'inverse."
            },
            maxDrawdown: {
                name: "Maximum Drawdown",
                emoji: "ðŸ“‰",
                definition: "La pire baisse entre un plus haut et un plus bas. Mesure combien vous auriez pu perdre au pire moment.",
                formula: "MDD = (Peak - Trough) / Peak Ã— 100",
                formulaLegend: ["Peak = Plus haut historique", "Trough = Plus bas suivant ce peak"],
                interpretation: [
                    { range: "< 10%", label: "Conservateur", class: "excellent" },
                    { range: "10-20%", label: "Modere", class: "good" },
                    { range: "20-30%", label: "Agressif", class: "ok" },
                    { range: "> 30%", label: "Tres risque", class: "bad" }
                ],
                example: "Si votre portefeuille atteint 10 000â‚¬ puis descend a 7 500â‚¬ avant de remonter, MDD = (10000-7500)/10000 = 25%",
                proTip: "Le S&P 500 a eu des drawdowns de -50% (2008) et -34% (COVID 2020). Votre tolerance au drawdown definit votre allocation."
            },
            calmar: {
                name: "Calmar Ratio",
                emoji: "âš–ï¸",
                definition: "Rendement annualise divise par le Maximum Drawdown. Mesure combien de rendement vous obtenez par unite de risque de perte maximale.",
                formula: "Calmar = Rendement Annualise / |Max Drawdown|",
                formulaLegend: [],
                interpretation: [
                    { range: "< 0.5", label: "Faible", class: "bad" },
                    { range: "0.5 - 1.0", label: "Acceptable", class: "ok" },
                    { range: "1.0 - 2.0", label: "Bon", class: "good" },
                    { range: "> 2.0", label: "Excellent", class: "excellent" }
                ],
                example: "Rendement 15%/an, Max DD 20% â†’ Calmar = 15/20 = 0.75",
                proTip: "Un Calmar de 1.0 signifie que votre rendement annuel 'compense' votre pire drawdown en 1 an."
            },
            // INDICATEURS TECHNIQUES
            fearGreed: {
                name: "Fear & Greed Index",
                emoji: "ðŸ˜±",
                definition: "Indice de sentiment du marche crypto base sur plusieurs facteurs : volatilite, volume, reseaux sociaux, dominance BTC, tendances.",
                formula: "Agregation de 6 facteurs ponderes (Alternative.me)",
                formulaLegend: ["Volatilite (25%)", "Momentum/Volume (25%)", "Social Media (15%)", "Sondages (15%)", "Dominance BTC (10%)", "Tendances Google (10%)"],
                interpretation: [
                    { range: "0-24", label: "Extreme Fear", class: "excellent", note: "Opportunite d'achat historique" },
                    { range: "25-44", label: "Fear", class: "good", note: "Bon moment pour DCA" },
                    { range: "45-55", label: "Neutral", class: "ok", note: "Marche indecis" },
                    { range: "56-74", label: "Greed", class: "ok", note: "Prudence recommandee" },
                    { range: "75-100", label: "Extreme Greed", class: "bad", note: "Risque de correction eleve" }
                ],
                example: "Actuellement a 20 (Extreme Fear) = Le marche est en panique. Historiquement, c'est souvent un bon moment pour acheter.",
                proTip: "'Be fearful when others are greedy, and greedy when others are fearful' - Warren Buffett"
            },
            rsi: {
                name: "RSI (Relative Strength Index)",
                emoji: "ðŸ“¶",
                definition: "Oscillateur de momentum qui mesure la vitesse et l'amplitude des mouvements de prix recents. Cree par J. Welles Wilder (1978).",
                formula: "RSI = 100 - [100 / (1 + RS)]",
                formulaLegend: ["RS = Moyenne des hausses / Moyenne des baisses sur 14 periodes"],
                interpretation: [
                    { range: "< 30", label: "Survendu", class: "excellent", note: "Signal d'achat potentiel" },
                    { range: "30-50", label: "Zone basse", class: "good" },
                    { range: "50-70", label: "Zone haute", class: "ok" },
                    { range: "> 70", label: "Surachete", class: "bad", note: "Signal de vente potentiel" }
                ],
                example: "RSI a 38.8 = Zone basse mais pas survendu. Le prix a baisse recemment mais pas de maniere excessive.",
                proTip: "Le RSI fonctionne mieux en range qu'en tendance forte. En bull market, le RSI peut rester au-dessus de 70 longtemps."
            },
            ma50: {
                name: "Moyenne Mobile 50 jours",
                emoji: "ðŸ“ˆ",
                definition: "Prix moyen des 50 derniers jours. Indicateur de tendance court/moyen terme. Utilise pour identifier les supports/resistances dynamiques.",
                formula: "MA50 = Î£(Prix des 50 derniers jours) / 50",
                formulaLegend: [],
                interpretation: [
                    { range: "Prix > MA50", label: "Tendance haussiere CT", class: "good" },
                    { range: "Prix < MA50", label: "Tendance baissiere CT", class: "bad" },
                    { range: "Prix â‰ˆ MA50", label: "Zone de decision", class: "ok" }
                ],
                example: "BTC a -5.4% sous la MA50 = Le prix est legerement sous sa moyenne 50 jours, signal de faiblesse a court terme.",
                proTip: "La MA50 sert souvent de support en tendance haussiere et de resistance en tendance baissiere."
            },
            ma200: {
                name: "Moyenne Mobile 200 jours",
                emoji: "ðŸ“Š",
                definition: "Prix moyen des 200 derniers jours (~1 an de trading). L'indicateur de tendance long terme LE plus suivi par les institutionnels.",
                formula: "MA200 = Î£(Prix des 200 derniers jours) / 200",
                formulaLegend: [],
                interpretation: [
                    { range: "Prix > MA200", label: "Bull Market", class: "excellent" },
                    { range: "Prix < MA200", label: "Bear Market", class: "bad" },
                    { range: "Prix â‰ˆ MA200", label: "Zone critique", class: "ok" }
                ],
                example: "BTC a -19.5% sous la MA200 = Nous sommes en Bear Market. Le prix devrait reconquerir ce niveau pour confirmer un retournement.",
                proTip: "Historiquement, acheter quand le prix est >20% sous la MA200 a ete profitable a long terme (mais patience requise)."
            },
            // MÃ‰TRIQUES DE RISQUE AVANCÃ‰ES
            var95: {
                name: "Value at Risk (VaR 95%)",
                emoji: "âš ï¸",
                definition: "Perte maximale attendue avec 95% de confiance sur une periode donnee. Standard de l'industrie pour mesurer le risque.",
                formula: "VaR95 = Î¼ - 1.645 Ã— Ïƒ (methode parametrique)",
                formulaLegend: ["Î¼ = Rendement moyen", "Ïƒ = Volatilite", "1.645 = Quantile 95% loi normale"],
                interpretation: [
                    { range: "< 5%", label: "Risque faible", class: "excellent" },
                    { range: "5-10%", label: "Risque modere", class: "good" },
                    { range: "10-20%", label: "Risque eleve", class: "ok" },
                    { range: "> 20%", label: "Risque tres eleve", class: "bad" }
                ],
                example: "VaR 95% mensuel de 8% signifie : 'Il y a 95% de chances que je ne perde pas plus de 8% ce mois-ci'",
                proTip: "Le VaR ne dit rien sur COMBIEN vous perdez dans les 5% de cas extremes. C'est pourquoi on utilise aussi le CVaR."
            },
            cvar: {
                name: "CVaR / Expected Shortfall",
                emoji: "ðŸ”¥",
                definition: "Perte moyenne dans les pires cas (au-dela du VaR). Repond a la question 'Si ca tourne vraiment mal, combien je perds en moyenne ?'",
                formula: "CVaR95 = E[Perte | Perte > VaR95]",
                formulaLegend: ["Esperance conditionnelle des pertes depassant le VaR"],
                interpretation: [
                    { range: "< 10%", label: "Queue fine", class: "good" },
                    { range: "10-20%", label: "Risque de queue modere", class: "ok" },
                    { range: "> 20%", label: "Fat tails", class: "bad" }
                ],
                example: "VaR 95% = 8%, CVaR 95% = 12% signifie : 'Dans les 5% de pires cas, je perds en moyenne 12%'.",
                proTip: "CVaR est prefere au VaR par les regulateurs (Bale III) car il capture le risque des evenements extremes."
            },
            kelly: {
                name: "Kelly Criterion",
                emoji: "ðŸŽ°",
                definition: "Fraction optimale du capital a investir pour maximiser la croissance long terme, inventee par John Kelly (Bell Labs, 1956).",
                formula: "f* = (p Ã— b - q) / b",
                formulaLegend: ["p = Probabilite de gain", "q = 1-p = Probabilite de perte", "b = Ratio gain/perte moyen"],
                interpretation: [
                    { range: "< 10%", label: "Position conservatrice", class: "good" },
                    { range: "10-25%", label: "Position optimale", class: "excellent" },
                    { range: "25-50%", label: "Position agressive", class: "ok" },
                    { range: "> 50%", label: "Trop risque", class: "bad" }
                ],
                example: "Si vous gagnez 60% du temps (p=0.6) et que vos gains moyens = 2Ã— vos pertes (b=2), Kelly = (0.6Ã—2 - 0.4)/2 = 40%",
                proTip: "En pratique, on utilise souvent 'Half Kelly' (f*/2) pour reduire la volatilite. Les pros depassent rarement 25% sur une position."
            },
            monteCarlo: {
                name: "Simulation Monte Carlo",
                emoji: "ðŸŽ²",
                definition: "Methode statistique simulant des milliers de scenarios possibles pour estimer la distribution des resultats futurs.",
                formula: "GBM: dS = Î¼S dt + ÏƒS dW",
                formulaLegend: ["S = Prix actif", "Î¼ = Drift (rendement attendu)", "Ïƒ = Volatilite", "dW = Mouvement Brownien"],
                interpretation: [
                    { range: "Percentile 10%", label: "Scenario pessimiste", class: "bad" },
                    { range: "Percentile 50%", label: "Scenario median", class: "ok" },
                    { range: "Percentile 90%", label: "Scenario optimiste", class: "excellent" }
                ],
                example: "10 000 simulations montrent que dans 90% des cas, vous aurez entre 50 000â‚¬ et 200 000â‚¬ dans 10 ans.",
                proTip: "Monte Carlo utilise un modele GBM (Geometric Brownian Motion) avec correlations entre actifs pour plus de realisme."
            },
            volatility: {
                name: "VolatilitÃ© AnnualisÃ©e",
                emoji: "ðŸ“‰",
                definition: "Mesure de la dispersion des rendements autour de leur moyenne. Represente le 'risque' au sens financier classique.",
                formula: "Ïƒ_annual = Ïƒ_monthly Ã— âˆš12",
                formulaLegend: ["Ïƒ_monthly = Ecart-type des rendements mensuels", "âˆš12 = Facteur d'annualisation"],
                interpretation: [
                    { range: "< 10%", label: "Faible volatilite", class: "excellent" },
                    { range: "10-20%", label: "Volatilite moderee", class: "good" },
                    { range: "20-40%", label: "Volatilite elevee", class: "ok" },
                    { range: "> 40%", label: "Tres volatile", class: "bad" }
                ],
                example: "Le S&P 500 a une volatilite historique d'environ 15-20%. Bitcoin: 60-80%.",
                proTip: "La volatilite n'est pas directionnelle : elle mesure les variations, pas si le prix monte ou descend."
            },
            winrate: {
                name: "Win Rate",
                emoji: "ðŸ†",
                definition: "Pourcentage de periodes (mois) cloturees en positif. Indicateur de la consistance de votre strategie.",
                formula: "Win Rate = (Mois positifs / Total mois) Ã— 100%",
                formulaLegend: [],
                interpretation: [
                    { range: "< 40%", label: "Faible consistance", class: "bad" },
                    { range: "40-50%", label: "Moyen", class: "ok" },
                    { range: "50-60%", label: "Bon", class: "good" },
                    { range: "> 60%", label: "Excellent", class: "excellent" }
                ],
                example: "Win Rate de 58% signifie que 58% de vos mois ont ete profitables.",
                proTip: "Un Win Rate de 40% peut etre suffisant si vos gains moyens sont bien superieurs a vos pertes moyennes (cf. Kelly)."
            },
            stresstest: {
                name: "Stress Test",
                emoji: "âš¡",
                definition: "Simulation de l'impact de scenarios de crise historiques sur votre portefeuille actuel.",
                formula: "Impact = Î£(Wi Ã— Choci)",
                formulaLegend: ["Wi = Poids de l'actif i", "Choci = Choc du scenario sur l'actif i"],
                interpretation: [
                    { range: "Perte < 20%", label: "Resilient", class: "good" },
                    { range: "Perte 20-40%", label: "Impact modere", class: "ok" },
                    { range: "Perte > 40%", label: "Tres expose", class: "bad" }
                ],
                example: "Crash 2008: Actions -55%, Crypto -80%, Obligations +5%. L'impact depend de votre allocation.",
                proTip: "Les scenarios historiques peuvent sous-estimer les crises futures. Utilisez pour identifier les expositions, pas pour predire."
            },
            var: {
                name: "Value at Risk (VaR)",
                emoji: "âš ï¸",
                definition: "Perte maximale attendue avec un niveau de confiance donne sur une periode specifique.",
                formula: "VaR95 = Î¼ - 1.645 Ã— Ïƒ",
                formulaLegend: ["Î¼ = Rendement moyen", "Ïƒ = Volatilite", "1.645 = Quantile 95% loi normale"],
                interpretation: [
                    { range: "< 5%", label: "Risque faible", class: "excellent" },
                    { range: "5-10%", label: "Risque modere", class: "good" },
                    { range: "10-20%", label: "Risque eleve", class: "ok" },
                    { range: "> 20%", label: "Risque tres eleve", class: "bad" }
                ],
                example: "VaR 95% = 8% signifie : 95% de chances de ne pas perdre plus de 8% sur la periode.",
                proTip: "Le VaR ne capture pas les 'tail risks'. Completez toujours avec CVaR pour les scenarios extremes."
            },
            maxdrawdown: {
                name: "Maximum Drawdown",
                emoji: "ðŸ“‰",
                definition: "La pire baisse entre un plus haut et un plus bas. Mesure combien vous auriez pu perdre au pire moment.",
                formula: "MDD = (Peak - Trough) / Peak Ã— 100",
                formulaLegend: ["Peak = Plus haut historique", "Trough = Plus bas suivant ce peak"],
                interpretation: [
                    { range: "< 10%", label: "Conservateur", class: "excellent" },
                    { range: "10-20%", label: "Modere", class: "good" },
                    { range: "20-30%", label: "Agressif", class: "ok" },
                    { range: "> 30%", label: "Tres risque", class: "bad" }
                ],
                example: "Si votre portefeuille atteint 10 000â‚¬ puis descend a 7 500â‚¬ avant de remonter, MDD = (10000-7500)/10000 = 25%",
                proTip: "Le S&P 500 a eu des drawdowns de -50% (2008) et -34% (COVID 2020). Votre tolerance au drawdown definit votre allocation."
            },
            tendance: {
                name: "Tendance (Golden/Death Cross)",
                emoji: "ðŸ§­",
                definition: "Signal base sur le croisement des moyennes mobiles 50 et 200 jours. Indicateur majeur de changement de tendance long terme.",
                formula: "Golden Cross: MA50 > MA200 | Death Cross: MA50 < MA200",
                formulaLegend: ["MA50 = Moyenne mobile 50 jours", "MA200 = Moyenne mobile 200 jours"],
                interpretation: [
                    { range: "Golden Cross", label: "Bull Market", class: "excellent", note: "MA50 croise MA200 a la hausse" },
                    { range: "Tendance haussiere", label: "Positif", class: "good", note: "MA50 au-dessus de MA200" },
                    { range: "Tendance baissiere", label: "Negatif", class: "ok", note: "MA50 en-dessous de MA200" },
                    { range: "Death Cross", label: "Bear Market", class: "bad", note: "MA50 croise MA200 a la baisse" }
                ],
                example: "En mars 2020, le BTC a forme un Death Cross juste avant le crash COVID. En aout 2020, le Golden Cross a signale le debut du bull run.",
                proTip: "Les Golden/Death Cross ont un retard inherent (indicateur suiveur). Utilisez-les pour confirmer les tendances, pas pour les anticiper."
            },
            goalplanner: {
                name: "Goal Planner",
                emoji: "ðŸŽ¯",
                definition: "Outil de planification financiere qui calcule le rendement annuel necessaire pour atteindre un objectif patrimonial donne.",
                formula: "FV = PV(1+r)^n + PMT Ã— [(1+r)^n - 1] / r",
                formulaLegend: ["FV = Valeur Future (objectif)", "PV = Valeur Presente (patrimoine actuel)", "PMT = Versement periodique", "r = Taux de rendement", "n = Nombre de periodes"],
                interpretation: [
                    { range: "< 5%", label: "Tres realiste", class: "excellent", note: "Rendement conservateur" },
                    { range: "5-8%", label: "Realiste", class: "good", note: "Performance actions classique" },
                    { range: "8-12%", label: "Ambitieux", class: "ok", note: "Necessite bonne performance" },
                    { range: "12-20%", label: "Difficile", class: "warning", note: "Risque eleve requis" },
                    { range: "> 20%", label: "Irrealiste", class: "bad", note: "Revoir objectif ou horizon" }
                ],
                example: "Pour atteindre 100 000â‚¬ en 5 ans avec 10 000â‚¬ actuels et 500â‚¬/mois, il faut environ 8% de rendement annuel.",
                proTip: "L'horizon temporel est votre meilleur allie. Doubler l'horizon peut diviser par deux le rendement requis. Preferez ajuster la duree plutot que le risque."
            },
            alpha: {
                name: "Alpha (Jensen's Alpha)",
                emoji: "ðŸ“Š",
                definition: "Mesure la surperformance ou sous-performance du portefeuille par rapport au rendement attendu selon le CAPM. Un alpha positif signifie que vous faites mieux que prevu.",
                formula: "Alpha = Rp - [Rf + Î² Ã— (Rm - Rf)]",
                formulaLegend: ["Rp = Rendement du portefeuille", "Rf = Taux sans risque", "Î² = Beta", "Rm = Rendement du marche"],
                interpretation: [
                    { range: "> +5%", label: "Excellent", class: "excellent", note: "Surperformance significative" },
                    { range: "+2% a +5%", label: "Bon", class: "good", note: "Vous battez le marche" },
                    { range: "-2% a +2%", label: "Neutre", class: "ok", note: "Performance alignee" },
                    { range: "< -2%", label: "Negatif", class: "bad", note: "Sous-performance" }
                ],
                example: "Si le marche fait +10%, le taux sans risque est 3%, votre beta est 1.2, et vous faites +15%, alors Alpha = 15 - [3 + 1.2Ã—(10-3)] = +3.6%",
                proTip: "L'alpha est tres difficile a maintenir positif sur le long terme. La plupart des fonds actifs ont un alpha negatif apres frais."
            },
            beta: {
                name: "Beta (Î²)",
                emoji: "ðŸ“ˆ",
                definition: "Mesure la sensibilite du portefeuille aux mouvements du marche. Un beta de 1 signifie que le portefeuille suit exactement le marche.",
                formula: "Beta = Cov(Rp, Rm) / Var(Rm)",
                formulaLegend: ["Cov = Covariance entre portefeuille et marche", "Var = Variance du marche"],
                interpretation: [
                    { range: "< 0.5", label: "Defensif", class: "excellent", note: "Tres peu volatile" },
                    { range: "0.5 - 0.8", label: "Conservateur", class: "good", note: "Moins volatile" },
                    { range: "0.8 - 1.2", label: "Neutre", class: "ok", note: "Suit le marche" },
                    { range: "1.2 - 1.5", label: "Agressif", class: "warning", note: "Plus volatile" },
                    { range: "> 1.5", label: "Tres agressif", class: "bad", note: "Beaucoup plus volatile" }
                ],
                example: "Si le marche baisse de 10% et votre portefeuille baisse de 15%, votre beta est environ 1.5. Si votre portefeuille ne baisse que de 5%, votre beta est environ 0.5.",
                proTip: "Avec de la crypto, votre beta sera naturellement eleve. Ce n'est pas mauvais si vous avez un horizon long terme et une tolerance au risque adaptee."
            }
        };

        function showTooltip(metricId) {
            const data = TOOLTIPS_DATA[metricId];
            if (!data) {
                console.warn('Tooltip non trouve:', metricId);
                return;
            }

            // Fermer les autres tooltips
            document.querySelectorAll('.tooltip-panel.active').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tooltip-overlay.active').forEach(el => el.classList.remove('active'));

            // CrÃ©er ou mettre Ã  jour le panel
            let panel = document.getElementById(`tooltip-${metricId}`);
            let overlay = document.getElementById('tooltip-overlay');

            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'tooltip-overlay';
                overlay.className = 'tooltip-overlay';
                overlay.onclick = () => closeAllTooltips();
                document.body.appendChild(overlay);
            }

            if (!panel) {
                panel = createTooltipPanel(metricId, data);
                document.body.appendChild(panel);
            }

            overlay.classList.add('active');
            panel.classList.add('active');
        }

        function createTooltipPanel(id, data) {
            const panel = document.createElement('div');
            panel.id = `tooltip-${id}`;
            panel.className = 'tooltip-panel';

            panel.innerHTML = `
                <div class="tooltip-header">
                    <span class="tooltip-emoji">${data.emoji}</span>
                    <h4>${data.name}</h4>
                    <button class="tooltip-close" onclick="closeTooltip('${id}')">Ã—</button>
                </div>

                <div class="tooltip-section">
                    <div class="tooltip-label">ðŸ“– Definition</div>
                    <p>${data.definition}</p>
                </div>

                <div class="tooltip-section">
                    <div class="tooltip-label">ðŸ”¢ Formule</div>
                    <div class="formula-box">
                        <code>${data.formula}</code>
                        ${data.formulaLegend.length > 0 ? `
                            <div class="formula-legend">
                                ${data.formulaLegend.map(l => `<span>â€¢ ${l}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="tooltip-section">
                    <div class="tooltip-label">ðŸ“Š Interpretation</div>
                    <div class="interpretation-scale">
                        ${data.interpretation.map(i => `
                            <div class="scale-item ${i.class}">
                                <span class="range">${i.range}</span>
                                <span class="label">${i.label}</span>
                                ${i.note ? `<span class="note">${i.note}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="tooltip-section">
                    <div class="tooltip-label">ðŸ’¡ Exemple</div>
                    <div class="example-box">${data.example}</div>
                </div>

                <div class="tooltip-section pro-tip">
                    <div class="tooltip-label">ðŸŽ“ Pro Tip</div>
                    <p>${data.proTip}</p>
                </div>
            `;

            return panel;
        }

        function closeTooltip(id) {
            const panel = document.getElementById(`tooltip-${id}`);
            const overlay = document.getElementById('tooltip-overlay');
            if (panel) panel.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }

        function closeAllTooltips() {
            document.querySelectorAll('.tooltip-panel.active').forEach(el => el.classList.remove('active'));
            const overlay = document.getElementById('tooltip-overlay');
            if (overlay) overlay.classList.remove('active');
        }

        // ============================================
        // CALCULATEURS PROFESSIONNELS
        // ============================================

        /**
         * Calcule Kelly Criterion
         */
        function calculateKelly() {
            const snapshots = DATA.snapshots || [];

            if (snapshots.length < 3) {
                return { fraction: null, message: "Min 3 snapshots requis" };
            }

            const returns = [];
            for (let i = 1; i < snapshots.length; i++) {
                const ret = (snapshots[i].values.total - snapshots[i-1].values.total) / snapshots[i-1].values.total;
                returns.push(ret);
            }

            const wins = returns.filter(r => r > 0);
            const losses = returns.filter(r => r <= 0);

            const winRate = wins.length / returns.length;
            const avgWin = wins.length > 0 ? wins.reduce((a,b) => a+b, 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((a,b) => a+b, 0) / losses.length) : 0.01;

            const b = avgWin / avgLoss;
            const p = winRate;
            const q = 1 - p;

            const kellyFraction = (p * b - q) / b;
            const halfKelly = kellyFraction / 2;

            return {
                fraction: Math.max(0, Math.min(1, kellyFraction)),
                halfKelly: Math.max(0, Math.min(0.5, halfKelly)),
                winRate: winRate * 100,
                avgWin: avgWin * 100,
                avgLoss: avgLoss * 100,
                ratio: b
            };
        }

        /**
         * Calcule VaR et CVaR
         */
        function calculateVaRCVaR(confidenceLevel = 0.95) {
            const portfolio = calculatePortfolio();
            const snapshots = DATA.snapshots || [];

            if (snapshots.length < 5) {
                return null;
            }

            const returns = [];
            for (let i = 1; i < snapshots.length; i++) {
                returns.push((snapshots[i].values.total - snapshots[i-1].values.total) / snapshots[i-1].values.total);
            }

            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / (returns.length - 1);
            const stdDev = Math.sqrt(variance);

            const zScores = { 0.90: 1.282, 0.95: 1.645, 0.99: 2.326 };
            const zScore = zScores[confidenceLevel] || 1.645;

            const var_pct = mean - zScore * stdDev;
            const var_eur = portfolio.values.total * Math.abs(var_pct);

            const pdf_z = Math.exp(-0.5 * zScore * zScore) / Math.sqrt(2 * Math.PI);
            const cvar_pct = mean - stdDev * pdf_z / (1 - confidenceLevel);
            const cvar_eur = portfolio.values.total * Math.abs(cvar_pct);

            return {
                confidence: confidenceLevel * 100,
                var: { percent: var_pct * 100, euros: var_eur },
                cvar: { percent: cvar_pct * 100, euros: cvar_eur },
                stats: { mean: mean * 100, stdDev: stdDev * 100, observations: returns.length }
            };
        }

        // ============================================
        // STRESS TEST
        // ============================================

        const STRESS_SCENARIOS = {
            crash2008: {
                name: "Crise 2008 (Lehman)",
                duration: 18,
                impacts: { pea: -0.57, btc: 0, eth: 0 },
                description: "Crise des subprimes, faillite Lehman Brothers"
            },
            covid2020: {
                name: "COVID-19 (Mars 2020)",
                duration: 1.5,
                impacts: { pea: -0.34, btc: -0.50, eth: -0.55 },
                description: "Crash eclair, recuperation rapide"
            },
            cryptoWinter2022: {
                name: "Crypto Winter 2022",
                duration: 12,
                impacts: { pea: -0.19, btc: -0.77, eth: -0.82 },
                description: "Luna/UST, FTX, taux Fed"
            },
            dotcom2000: {
                name: "Bulle Internet 2000",
                duration: 30,
                impacts: { pea: -0.49, btc: 0, eth: 0 },
                description: "Eclatement de la bulle tech"
            },
            blackMonday1987: {
                name: "Black Monday 1987",
                duration: 0.1,
                impacts: { pea: -0.22, btc: 0, eth: 0 },
                description: "-22% en une seule journee"
            }
        };

        function runStressTest(scenarioId) {
            const scenario = STRESS_SCENARIOS[scenarioId];
            if (!scenario) return null;

            const portfolio = calculatePortfolio();

            const impactedValues = {
                livret: portfolio.values.livret,
                pea: portfolio.values.pea * (1 + scenario.impacts.pea),
                btc: portfolio.values.btc * (1 + (scenario.impacts.btc || 0)),
                eth: portfolio.values.eth * (1 + (scenario.impacts.eth || 0))
            };

            const impactedTotal = Object.values(impactedValues).reduce((a, b) => a + b, 0);
            const loss = portfolio.values.total - impactedTotal;
            const lossPct = (loss / portfolio.values.total) * 100;

            const result = {
                scenario: scenario.name,
                description: scenario.description,
                duration: scenario.duration,
                before: portfolio.values.total,
                after: impactedTotal,
                loss: loss,
                lossPct: lossPct,
                breakdown: {
                    livret: { before: portfolio.values.livret, after: impactedValues.livret, impact: 0 },
                    pea: { before: portfolio.values.pea, after: impactedValues.pea, impact: scenario.impacts.pea * 100 },
                    btc: { before: portfolio.values.btc, after: impactedValues.btc, impact: (scenario.impacts.btc || 0) * 100 },
                    eth: { before: portfolio.values.eth, after: impactedValues.eth, impact: (scenario.impacts.eth || 0) * 100 }
                }
            };

            // Afficher les rÃ©sultats
            displayStressTestResults(result);
            return result;
        }

        function displayStressTestResults(result) {
            const setEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            // Afficher la section rÃ©sultats
            const resultsSection = document.getElementById('stressResults');
            if (resultsSection) resultsSection.style.display = 'block';

            // Remplir les valeurs
            setEl('stressScenarioName', result.scenario);
            setEl('stressScenarioDate', result.description);
            setEl('stressCurrentValue', formatCurrency(result.before));
            setEl('stressImpact', '-' + result.lossPct.toFixed(1) + '%');
            setEl('stressPostValue', formatCurrency(result.after));
            setEl('stressLoss', '-' + formatCurrency(result.loss));

            // DÃ©tail par actif
            const detailEl = document.getElementById('stressDetail');
            if (detailEl) {
                detailEl.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 1rem;">
                        <div class="stress-asset-item">
                            <span class="asset-name">Livret A</span>
                            <span class="asset-impact" style="color: var(--success);">0%</span>
                        </div>
                        <div class="stress-asset-item">
                            <span class="asset-name">PEA</span>
                            <span class="asset-impact" style="color: var(--danger);">${result.breakdown.pea.impact.toFixed(0)}%</span>
                        </div>
                        <div class="stress-asset-item">
                            <span class="asset-name">BTC</span>
                            <span class="asset-impact" style="color: var(--danger);">${result.breakdown.btc.impact.toFixed(0)}%</span>
                        </div>
                        <div class="stress-asset-item">
                            <span class="asset-name">ETH</span>
                            <span class="asset-impact" style="color: var(--danger);">${result.breakdown.eth.impact.toFixed(0)}%</span>
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // MONTE CARLO GBM
        // ============================================

        class MonteCarloGBM {
            constructor(config = {}) {
                this.numSimulations = config.numSimulations || 10000;
                this.params = {
                    returns: { livret: 0.03, pea: 0.08, btc: 0.30, eth: 0.35 },
                    volatilities: { livret: 0.00, pea: 0.16, btc: 0.60, eth: 0.75 },
                    correlations: { 'pea-btc': 0.3, 'pea-eth': 0.35, 'btc-eth': 0.85 }
                };
            }

            normalRandom() {
                const u1 = Math.random();
                const u2 = Math.random();
                return Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            }

            choleskyDecomposition(A) {
                const n = A.length;
                const L = Array(n).fill(null).map(() => Array(n).fill(0));
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j <= i; j++) {
                        let sum = 0;
                        for (let k = 0; k < j; k++) sum += L[i][k] * L[j][k];
                        L[i][j] = (i === j) ? Math.sqrt(Math.max(0, A[i][i] - sum)) : (A[i][j] - sum) / (L[j][j] || 1);
                    }
                }
                return L;
            }

            generateCorrelatedReturns() {
                const corr = [
                    [1.00, 0.30, 0.35],
                    [0.30, 1.00, 0.85],
                    [0.35, 0.85, 1.00]
                ];
                const L = this.choleskyDecomposition(corr);
                const z = [this.normalRandom(), this.normalRandom(), this.normalRandom()];
                return [
                    L[0][0] * z[0],
                    L[1][0] * z[0] + L[1][1] * z[1],
                    L[2][0] * z[0] + L[2][1] * z[1] + L[2][2] * z[2]
                ];
            }

            simulatePortfolio(initialValues, monthlyContributions, months) {
                const results = [];
                const weeklySteps = Math.floor(months * 4.33);
                this.initialInvestment = Object.values(initialValues).reduce((a,b) => a+b, 0) +
                    Object.values(monthlyContributions).reduce((a,b) => a+b, 0) * months;

                for (let sim = 0; sim < this.numSimulations; sim++) {
                    let portfolio = { ...initialValues };
                    let totalValue = Object.values(portfolio).reduce((a, b) => a + b, 0);
                    const path = [totalValue];

                    for (let week = 0; week < weeklySteps; week++) {
                        if (week % 4 === 0) {
                            portfolio.livret += monthlyContributions.livret || 0;
                            portfolio.pea += monthlyContributions.pea || 0;
                            portfolio.btc += monthlyContributions.btc || 0;
                            portfolio.eth += monthlyContributions.eth || 0;
                        }

                        const correlatedReturns = this.generateCorrelatedReturns();
                        const dt = 1 / 52;

                        portfolio.livret *= Math.exp(this.params.returns.livret * dt);

                        const peaDrift = (this.params.returns.pea - 0.5 * Math.pow(this.params.volatilities.pea, 2)) * dt;
                        const peaDiffusion = this.params.volatilities.pea * Math.sqrt(dt) * correlatedReturns[0];
                        portfolio.pea *= Math.exp(peaDrift + peaDiffusion);

                        const btcDrift = (this.params.returns.btc - 0.5 * Math.pow(this.params.volatilities.btc, 2)) * dt;
                        const btcDiffusion = this.params.volatilities.btc * Math.sqrt(dt) * correlatedReturns[1];
                        portfolio.btc *= Math.exp(btcDrift + btcDiffusion);

                        const ethDrift = (this.params.returns.eth - 0.5 * Math.pow(this.params.volatilities.eth, 2)) * dt;
                        const ethDiffusion = this.params.volatilities.eth * Math.sqrt(dt) * correlatedReturns[2];
                        portfolio.eth *= Math.exp(ethDrift + ethDiffusion);

                        totalValue = portfolio.livret + portfolio.pea + portfolio.btc + portfolio.eth;
                        path.push(totalValue);
                    }

                    results.push({ finalValue: totalValue, path: path });
                }

                return this.analyzeResults(results);
            }

            analyzeResults(results) {
                const finalValues = results.map(r => r.finalValue).sort((a, b) => a - b);
                const n = finalValues.length;
                const mean = finalValues.reduce((a, b) => a + b, 0) / n;
                const variance = finalValues.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / n;

                return {
                    mean: mean,
                    median: finalValues[Math.floor(n / 2)],
                    stdDev: Math.sqrt(variance),
                    percentiles: {
                        p5: finalValues[Math.floor(n * 0.05)],
                        p10: finalValues[Math.floor(n * 0.10)],
                        p25: finalValues[Math.floor(n * 0.25)],
                        p50: finalValues[Math.floor(n * 0.50)],
                        p75: finalValues[Math.floor(n * 0.75)],
                        p90: finalValues[Math.floor(n * 0.90)],
                        p95: finalValues[Math.floor(n * 0.95)]
                    },
                    probabilities: {
                        profit: finalValues.filter(v => v > this.initialInvestment).length / n * 100,
                        double: finalValues.filter(v => v > this.initialInvestment * 2).length / n * 100,
                        loss20: finalValues.filter(v => v < this.initialInvestment * 0.8).length / n * 100,
                        loss50: finalValues.filter(v => v < this.initialInvestment * 0.5).length / n * 100,
                        gain20: finalValues.filter(v => v > this.initialInvestment * 1.2).length / n * 100,
                        gain50: finalValues.filter(v => v > this.initialInvestment * 1.5).length / n * 100
                    },
                    samplePaths: results.slice(0, 50).map(r => r.path)
                };
            }
        }

        let mcChart = null;

        function runAdvancedMonteCarlo() {
            const portfolio = calculatePortfolio();
            if (portfolio.values.total === 0) {
                alert('Ajoutez des versements avant de lancer Monte Carlo');
                return;
            }

            // Afficher le loading
            const loadingEl = document.getElementById('mcChartLoading');
            if (loadingEl) loadingEl.style.display = 'flex';

            const numSims = parseInt(document.getElementById('mcSimulations')?.value || 10000);
            const months = parseInt(document.getElementById('mcHorizon')?.value || 24);
            const contribution = parseFloat(document.getElementById('mcContribution')?.value || 800);
            const driftAdjust = parseFloat(document.getElementById('mcDrift')?.value || 0) / 100;

            const mc = new MonteCarloGBM({ numSimulations: numSims });

            // Ajuster le drift si spÃ©cifiÃ©
            if (driftAdjust !== 0) {
                mc.params.returns.pea += driftAdjust;
                mc.params.returns.btc += driftAdjust;
                mc.params.returns.eth += driftAdjust;
            }

            const initialValues = {
                livret: portfolio.values.livret,
                pea: portfolio.values.pea,
                btc: portfolio.values.btc,
                eth: portfolio.values.eth
            };

            // Calculer la rÃ©partition du versement mensuel selon les proportions actuelles
            const totalContrib = contribution;
            const totalPortfolio = portfolio.values.total || 1;
            const monthlyContrib = {
                livret: totalContrib * (portfolio.values.livret / totalPortfolio) || DATA.config.defaultLivret,
                pea: totalContrib * (portfolio.values.pea / totalPortfolio) || DATA.config.defaultPea,
                btc: totalContrib * (portfolio.values.btc / totalPortfolio) || DATA.config.defaultBtc,
                eth: totalContrib * (portfolio.values.eth / totalPortfolio) || DATA.config.defaultEth
            };

            console.log('Lancement Monte Carlo avec', numSims, 'simulations sur', months, 'mois...');

            // Utiliser setTimeout pour permettre l'affichage du loading
            setTimeout(() => {
                const results = mc.simulatePortfolio(initialValues, monthlyContrib, months);
                console.log('Monte Carlo termine:', results);

                if (loadingEl) loadingEl.style.display = 'none';
                displayMonteCarloResults(results, months);
            }, 50);
        }

        function displayMonteCarloResults(results, months) {
            // Mettre Ã  jour les stats
            const setEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setEl('mcMedian', formatCurrency(results.median));
            setEl('mcP90', formatCurrency(results.percentiles.p90));
            setEl('mcP10', formatCurrency(results.percentiles.p10));
            setEl('mcProbProfit', results.probabilities.profit.toFixed(1) + '%');

            // Calculer les probabilitÃ©s de gains
            const probGain20 = results.probabilities.gain20 || (100 - results.probabilities.loss20);
            const probGain50 = results.probabilities.gain50 || results.probabilities.double;

            // Barres de probabilitÃ©s
            const setProbBar = (id, valueId, value) => {
                const barEl = document.getElementById(id);
                const valEl = document.getElementById(valueId);
                if (barEl) {
                    barEl.style.width = Math.min(value, 100) + '%';
                }
                if (valEl) {
                    valEl.textContent = value.toFixed(1) + '%';
                }
            };

            setProbBar('probLoss50', 'probLoss50Val', results.probabilities.loss50);
            setProbBar('probLoss20', 'probLoss20Val', results.probabilities.loss20);
            setProbBar('probGain20', 'probGain20Val', probGain20);
            setProbBar('probGain50', 'probGain50Val', probGain50);

            // Graphique Fan Chart
            const ctx = document.getElementById('mcFanChart');
            if (!ctx) return;

            if (mcChart) mcChart.destroy();

            const labels = Array.from({ length: results.samplePaths[0]?.length || 0 }, (_, i) => i);

            mcChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        ...results.samplePaths.slice(0, 30).map((path, i) => ({
                            data: path,
                            borderColor: `rgba(0, 217, 255, ${0.1})`,
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: false
                        })),
                        {
                            label: 'Median',
                            data: results.samplePaths[Math.floor(results.samplePaths.length / 2)],
                            borderColor: '#00ff41',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Projection sur ${months} mois (${results.samplePaths.length} scenarios)`,
                            color: '#fff'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'Semaines', color: '#888' },
                            ticks: { color: '#666' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'Valeur (â‚¬)', color: '#888' },
                            ticks: {
                                color: '#666',
                                callback: v => (v/1000).toFixed(0) + 'k'
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        // ============================================
        // DISPLAY VaR/CVaR
        // ============================================

        function displayVaRCVaR() {
            const result = calculateVaRCVaR(0.95);

            const setEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setEl('varValue', result.var.percent.toFixed(2) + '%');
            setEl('varEuros', formatCurrency(result.var.euros));
            setEl('cvarValue', result.cvar.percent.toFixed(2) + '%');
            setEl('cvarEuros', formatCurrency(result.cvar.euros));

            // Aussi mettre Ã  jour dans Monte Carlo si prÃ©sent
            setEl('mcVaR', result.var.percent.toFixed(1) + '%');
            setEl('mcCVaR', result.cvar.percent.toFixed(1) + '%');
        }

        // ============================================
        // DISPLAY KELLY
        // ============================================

        function displayKelly() {
            const result = calculateKelly();

            const setEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setEl('kellyFraction', (result.fraction * 100).toFixed(1) + '%');
            setEl('kellyHalf', (result.halfKelly * 100).toFixed(1) + '%');
            setEl('kellyWinRate', (result.winRate * 100).toFixed(1) + '%');
            setEl('kellyRatio', result.ratio.toFixed(2));
        }

        // ============================================
        // GOAL PLANNER - RENDEMENT REQUIS
        // ============================================

        /**
         * Calcule le rendement annuel requis pour atteindre un objectif
         * Utilise la mÃ©thode de Newton-Raphson pour rÃ©soudre l'Ã©quation
         * FV = PV(1+r)^n + PMT Ã— [(1+r)^n - 1] / r
         */
        function calculateRequiredReturn(targetValue, monthlyContribution, months) {
            const portfolio = calculatePortfolio();
            const currentValue = portfolio.values.total;

            // Si l'objectif est dÃ©jÃ  atteint
            if (currentValue >= targetValue) {
                return {
                    annualReturn: 0,
                    monthlyReturn: 0,
                    feasibility: 'achieved',
                    message: 'Objectif deja atteint ! ðŸŽ‰',
                    details: { currentValue, targetValue, monthlyContribution, months, totalContributions: monthlyContribution * months, requiredGrowth: 0 }
                };
            }

            // Si possible avec Ã©pargne seule (r = 0)
            const futureWithoutReturn = currentValue + monthlyContribution * months;
            if (futureWithoutReturn >= targetValue) {
                return {
                    annualReturn: 0,
                    monthlyReturn: 0,
                    feasibility: 'easy',
                    message: 'âœ… Atteignable avec l\'epargne seule, sans rendement',
                    details: { currentValue, targetValue, monthlyContribution, months, totalContributions: monthlyContribution * months, requiredGrowth: 0 }
                };
            }

            // Newton-Raphson pour trouver r
            let r = 0.08 / 12; // Guess initial : 8% annuel
            const maxIterations = 100;
            const tolerance = 0.000001;

            for (let i = 0; i < maxIterations; i++) {
                const n = months;
                const factor = Math.pow(1 + r, n);

                // f(r) = PV(1+r)^n + PMT[(1+r)^n - 1]/r - Target
                let fv;
                if (Math.abs(r) < 0.0001) {
                    fv = currentValue + monthlyContribution * n;
                } else {
                    fv = currentValue * factor + monthlyContribution * (factor - 1) / r;
                }
                const f = fv - targetValue;

                // f'(r) - dÃ©rivÃ©e
                let df;
                if (Math.abs(r) < 0.0001) {
                    df = currentValue * n + monthlyContribution * n * (n - 1) / 2;
                } else {
                    df = currentValue * n * Math.pow(1 + r, n - 1) +
                        monthlyContribution * (n * Math.pow(1 + r, n - 1) / r - (factor - 1) / (r * r));
                }

                if (Math.abs(df) < tolerance) break;

                const newR = r - f / df;

                if (Math.abs(newR - r) < tolerance) {
                    r = newR;
                    break;
                }
                r = newR;

                // Ã‰viter les valeurs absurdes
                if (r < -0.5 || r > 1) {
                    r = 0.08 / 12;
                    break;
                }
            }

            const annualReturn = (Math.pow(1 + r, 12) - 1) * 100;
            const totalContributions = monthlyContribution * months;

            return {
                annualReturn: annualReturn,
                monthlyReturn: r * 100,
                feasibility: getFeasibilityLevel(annualReturn),
                message: getFeasibilityMessage(annualReturn),
                details: {
                    currentValue,
                    targetValue,
                    monthlyContribution,
                    months,
                    totalContributions,
                    requiredGrowth: targetValue - currentValue - totalContributions
                }
            };
        }

        function getFeasibilityLevel(annualReturn) {
            if (annualReturn <= 0) return 'easy';
            if (annualReturn < 5) return 'easy';
            if (annualReturn < 8) return 'realistic';
            if (annualReturn < 12) return 'challenging';
            if (annualReturn < 20) return 'difficult';
            return 'unrealistic';
        }

        function getFeasibilityMessage(annualReturn) {
            if (annualReturn <= 0) return 'âœ… Atteignable avec epargne seule';
            if (annualReturn < 5) return 'âœ… Tres realiste - Rendement conservateur suffisant';
            if (annualReturn < 8) return 'âœ… Realiste - Performance marche actions classique';
            if (annualReturn < 12) return 'âš ï¸ Ambitieux - Necessite une bonne performance';
            if (annualReturn < 20) return 'âš ï¸ Difficile - Prise de risque elevee requise';
            return 'âŒ Tres ambitieux - Revoir objectif ou horizon';
        }

        function runGoalPlanner() {
            const target = parseFloat(document.getElementById('goalTarget').value) || 50000;
            const horizon = parseInt(document.getElementById('goalHorizon').value) || 60;
            const contribution = parseFloat(document.getElementById('goalContribution').value) || 800;

            const result = calculateRequiredReturn(target, contribution, horizon);

            const resultsDiv = document.getElementById('goalResults');
            resultsDiv.style.display = 'block';

            const feasibilityColors = {
                'achieved': 'var(--success)',
                'easy': 'var(--success)',
                'realistic': 'var(--info)',
                'challenging': 'var(--warning)',
                'difficult': 'var(--orange, #ff8c00)',
                'unrealistic': 'var(--danger)'
            };

            const color = feasibilityColors[result.feasibility] || 'var(--text-primary)';

            resultsDiv.innerHTML = `
                <div class="goal-result-main" style="text-align: center; padding: 1.5rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">
                        Rendement annuel requis
                    </div>
                    <div style="font-size: 2.5rem; font-weight: 700; color: ${color};">
                        ${result.annualReturn.toFixed(1)}%
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">
                        soit ${result.monthlyReturn.toFixed(2)}% / mois
                    </div>
                </div>

                <div class="goal-feasibility" style="padding: 1rem; background: ${color}22; border: 1px solid ${color}; border-radius: var(--radius-md); margin-bottom: 1rem;">
                    <div style="color: ${color}; font-weight: 600; text-align: center;">
                        ${result.message}
                    </div>
                </div>

                <div class="goal-details" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: var(--bg-card); border-radius: var(--radius-md);">
                        <div style="font-size: 0.7rem; color: var(--text-dim);">PATRIMOINE ACTUEL</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-white);">${formatCurrency(result.details.currentValue)}</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: var(--bg-card); border-radius: var(--radius-md);">
                        <div style="font-size: 0.7rem; color: var(--text-dim);">OBJECTIF</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-secondary);">${formatCurrency(result.details.targetValue)}</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: var(--bg-card); border-radius: var(--radius-md);">
                        <div style="font-size: 0.7rem; color: var(--text-dim);">TOTAL VERSEMENTS</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-white);">${formatCurrency(result.details.totalContributions)}</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: var(--bg-card); border-radius: var(--radius-md);">
                        <div style="font-size: 0.7rem; color: var(--text-dim);">CROISSANCE REQUISE</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: ${result.details.requiredGrowth > 0 ? 'var(--success)' : 'var(--text-white)'};">${formatCurrency(result.details.requiredGrowth)}</div>
                    </div>
                </div>

                <div class="goal-comparison" style="background: var(--bg-card); padding: 1rem; border-radius: var(--radius-md);">
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.75rem;">Comparaison avec rendements historiques :</div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${renderReturnComparison(result.annualReturn, 'Livret A', 3, 'var(--info)')}
                        ${renderReturnComparison(result.annualReturn, 'S&P 500 (historique)', 8, '#9b59b6')}
                        ${renderReturnComparison(result.annualReturn, 'Votre objectif', result.annualReturn, 'var(--text-primary)')}
                        ${renderReturnComparison(result.annualReturn, 'BTC (historique)', 30, 'var(--btc)')}
                    </div>
                </div>
            `;
        }

        function renderReturnComparison(target, name, value, color) {
            const maxVal = Math.max(target, 30, value);
            const width = Math.min(100, (value / maxVal) * 100);
            const isTarget = name.includes('objectif');

            return `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 130px; font-size: 0.75rem; color: ${isTarget ? 'var(--text-white)' : 'var(--text-dim)'}; ${isTarget ? 'font-weight: 600;' : ''}">${name}</div>
                    <div style="flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${width}%; height: 100%; background: ${color}; border-radius: 4px;"></div>
                    </div>
                    <div style="width: 50px; text-align: right; font-size: 0.8rem; color: ${isTarget ? 'var(--text-white)' : 'var(--text-dim)'}; ${isTarget ? 'font-weight: 600;' : ''}">${value.toFixed(1)}%</div>
                </div>
            `;
        }

        // ============================================
        // ALPHA & BETA - MÃ‰TRIQUES INSTITUTIONNELLES
        // ============================================

        /**
         * Calcule Alpha et Beta du portefeuille vs benchmark (approximation S&P 500)
         * Beta = Cov(Rp, Rm) / Var(Rm)
         * Alpha = Rp - [Rf + Beta Ã— (Rm - Rf)]
         */
        function calculateAlphaBeta() {
            const snapshots = DATA.snapshots || [];

            if (snapshots.length < 6) {
                return { alpha: null, beta: null, error: 'Minimum 6 snapshots requis' };
            }

            // Rendements du portefeuille
            const portfolioReturns = [];
            for (let i = 1; i < snapshots.length; i++) {
                const prevTotal = snapshots[i-1].values?.total || 0;
                const currTotal = snapshots[i].values?.total || 0;
                if (prevTotal > 0) {
                    portfolioReturns.push((currTotal - prevTotal) / prevTotal);
                }
            }

            // Rendements approximÃ©s du marchÃ© (basÃ© sur PEA comme proxy S&P 500)
            const marketReturns = [];
            for (let i = 1; i < snapshots.length; i++) {
                const prevPea = snapshots[i-1].values?.pea || 0;
                const currPea = snapshots[i].values?.pea || 0;
                if (prevPea > 0) {
                    // Utiliser le PEA comme proxy, ajustÃ©
                    marketReturns.push((currPea - prevPea) / prevPea * 0.9);
                } else {
                    marketReturns.push(0.005); // Rendement marchÃ© moyen mensuel par dÃ©faut
                }
            }

            if (portfolioReturns.length < 3 || portfolioReturns.length !== marketReturns.length) {
                return { alpha: null, beta: null, error: 'Donnees insuffisantes' };
            }

            // Moyennes
            const avgPortfolio = portfolioReturns.reduce((a, b) => a + b, 0) / portfolioReturns.length;
            const avgMarket = marketReturns.reduce((a, b) => a + b, 0) / marketReturns.length;

            // Covariance et Variance
            let covariance = 0;
            let varianceMarket = 0;
            let variancePortfolio = 0;

            for (let i = 0; i < portfolioReturns.length; i++) {
                covariance += (portfolioReturns[i] - avgPortfolio) * (marketReturns[i] - avgMarket);
                varianceMarket += Math.pow(marketReturns[i] - avgMarket, 2);
                variancePortfolio += Math.pow(portfolioReturns[i] - avgPortfolio, 2);
            }

            covariance /= portfolioReturns.length;
            varianceMarket /= portfolioReturns.length;
            variancePortfolio /= portfolioReturns.length;

            // Beta
            const beta = varianceMarket > 0.0001 ? covariance / varianceMarket : 1;

            // Alpha (annualisÃ©)
            const riskFreeRate = (DATA.config?.riskFreeRate || 3) / 100;
            const monthlyRf = riskFreeRate / 12;
            const annualizedPortfolio = (Math.pow(1 + avgPortfolio, 12) - 1) * 100;
            const annualizedMarket = (Math.pow(1 + avgMarket, 12) - 1) * 100;

            const expectedReturn = riskFreeRate * 100 + beta * (annualizedMarket - riskFreeRate * 100);
            const alpha = annualizedPortfolio - expectedReturn;

            // CorrÃ©lation
            const stdPortfolio = Math.sqrt(variancePortfolio);
            const stdMarket = Math.sqrt(varianceMarket);
            const correlation = (stdPortfolio > 0 && stdMarket > 0) ? covariance / (stdPortfolio * stdMarket) : 0;

            return {
                alpha: alpha,
                beta: beta,
                correlation: correlation,
                interpretation: {
                    beta: getBetaInterpretation(beta),
                    alpha: getAlphaInterpretation(alpha)
                }
            };
        }

        function getBetaInterpretation(beta) {
            if (beta < 0.5) return { label: 'Defensif', class: 'excellent', desc: 'Moins volatile que le marche' };
            if (beta < 0.8) return { label: 'Conservateur', class: 'good', desc: 'Legerement moins volatile' };
            if (beta < 1.2) return { label: 'Neutre', class: 'ok', desc: 'Suit le marche' };
            if (beta < 1.5) return { label: 'Agressif', class: 'warning', desc: 'Plus volatile que le marche' };
            return { label: 'Tres agressif', class: 'bad', desc: 'Beaucoup plus volatile' };
        }

        function getAlphaInterpretation(alpha) {
            if (alpha > 5) return { label: 'Excellent', class: 'excellent', desc: 'Surperformance significative' };
            if (alpha > 2) return { label: 'Bon', class: 'good', desc: 'Surperformance' };
            if (alpha > -2) return { label: 'Neutre', class: 'ok', desc: 'Performance alignee' };
            if (alpha > -5) return { label: 'Sous-perf', class: 'warning', desc: 'Legere sous-performance' };
            return { label: 'Probleme', class: 'bad', desc: 'Sous-performance significative' };
        }

        // ============================================
        // MATRICE DE CORRÃ‰LATION
        // ============================================

        function calculateCorrelationMatrix() {
            const snapshots = DATA.snapshots || [];

            if (snapshots.length < 5) {
                return null;
            }

            const assets = ['livret', 'pea', 'btc', 'eth'];
            const returns = {};

            assets.forEach(asset => {
                returns[asset] = [];
                for (let i = 1; i < snapshots.length; i++) {
                    const prev = snapshots[i-1].values?.[asset] || 0;
                    const curr = snapshots[i].values?.[asset] || 0;
                    if (prev > 0) {
                        returns[asset].push((curr - prev) / prev);
                    } else {
                        returns[asset].push(0);
                    }
                }
            });

            // Matrice de corrÃ©lation
            const matrix = [];

            assets.forEach(asset1 => {
                const row = [];
                assets.forEach(asset2 => {
                    if (asset1 === asset2) {
                        row.push(1);
                    } else if (asset1 === 'livret' || asset2 === 'livret') {
                        row.push(0);
                    } else {
                        row.push(calculateCorrelation(returns[asset1], returns[asset2]));
                    }
                });
                matrix.push(row);
            });

            return { assets, matrix };
        }

        function calculateCorrelation(x, y) {
            if (x.length !== y.length || x.length < 2) return 0;

            const n = x.length;
            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;

            let numerator = 0;
            let denomX = 0;
            let denomY = 0;

            for (let i = 0; i < n; i++) {
                const dx = x[i] - meanX;
                const dy = y[i] - meanY;
                numerator += dx * dy;
                denomX += dx * dx;
                denomY += dy * dy;
            }

            const denominator = Math.sqrt(denomX) * Math.sqrt(denomY);
            return denominator > 0 ? numerator / denominator : 0;
        }

        function renderCorrelationMatrix() {
            const container = document.getElementById('correlationMatrix');
            if (!container) return;

            const data = calculateCorrelationMatrix();
            if (!data) {
                container.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 2rem;">Minimum 5 snapshots requis</p>';
                return;
            }

            const { assets, matrix } = data;
            const labels = { livret: 'Livret A', pea: 'PEA', btc: 'BTC', eth: 'ETH' };

            let html = '<div style="display: grid; grid-template-columns: auto repeat(4, 1fr); gap: 4px;">';

            // Header
            html += '<div></div>';
            assets.forEach(asset => {
                html += `<div style="text-align: center; font-size: 0.7rem; color: var(--text-dim); padding: 0.5rem;">${labels[asset]}</div>`;
            });

            // Lignes
            assets.forEach((asset1, i) => {
                html += `<div style="font-size: 0.7rem; color: var(--text-dim); padding: 0.5rem; text-align: right;">${labels[asset1]}</div>`;

                assets.forEach((asset2, j) => {
                    const corr = matrix[i][j];
                    const color = getCorrelationColor(corr);
                    html += `
                        <div style="
                            background: ${color};
                            padding: 0.75rem;
                            text-align: center;
                            border-radius: 4px;
                            font-weight: 600;
                            color: ${Math.abs(corr) > 0.5 ? '#000' : 'var(--text-white)'};
                            font-size: 0.8rem;
                        " title="${labels[asset1]} â†” ${labels[asset2]}: ${corr.toFixed(2)}">
                            ${corr.toFixed(2)}
                        </div>
                    `;
                });
            });

            html += '</div>';
            html += `
                <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; font-size: 0.7rem; color: var(--text-dim);">
                    <span>ðŸ”´ -1 (inverse)</span>
                    <span>âšª 0 (independant)</span>
                    <span>ðŸŸ¢ +1 (correle)</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function getCorrelationColor(corr) {
            if (corr >= 0.7) return 'rgba(0, 255, 65, 0.8)';
            if (corr >= 0.4) return 'rgba(0, 255, 65, 0.5)';
            if (corr >= 0.1) return 'rgba(0, 255, 65, 0.2)';
            if (corr >= -0.1) return 'rgba(100, 100, 100, 0.3)';
            if (corr >= -0.4) return 'rgba(255, 68, 68, 0.2)';
            if (corr >= -0.7) return 'rgba(255, 68, 68, 0.5)';
            return 'rgba(255, 68, 68, 0.8)';
        }

        function exportPDF() {
            if (DATA.transactions.length === 0) {
                alert('Ajoutez des transactions avant d\'exporter.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const portfolio = calculatePortfolio();
            const metrics = calculateAllMetrics();

            // En-tÃªte
            doc.setFillColor(10, 14, 23);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(0, 255, 65);
            doc.setFontSize(22);
            doc.text('OLYMPUS CAPITAL', 105, 15, { align: 'center' });
            doc.setFontSize(11);
            doc.setTextColor(0, 217, 255);
            doc.text('Rapport de Performance - Track Record Personnel', 105, 25, { align: 'center' });

            // Date
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(9);
            doc.text('Genere le ' + new Date().toLocaleDateString('fr-FR'), 105, 45, { align: 'center' });

            // Patrimoine
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.text('Patrimoine Total', 20, 60);
            doc.setFontSize(20);
            doc.text(formatCurrency(portfolio.values.total), 20, 70);

            doc.setFontSize(10);
            doc.text('Investi: ' + formatCurrency(portfolio.invested.total), 120, 62);
            doc.text('Gain: ' + formatCurrency(portfolio.gains.total), 120, 70);
            doc.text('Performance: ' + formatChange(portfolio.perf.total), 120, 78);

            // MÃ©triques Pro
            doc.setFontSize(12);
            doc.text('Metriques de Performance', 20, 95);

            const metricsTable = [
                ['TWR (Time-Weighted)', formatChange(metrics.twr)],
                ['MWR / TRI', formatChange(metrics.mwr)],
                ['Sharpe Ratio', metrics.sharpe.toFixed(2)],
                ['Sortino Ratio', metrics.sortino > 10 ? '>10' : metrics.sortino.toFixed(2)],
                ['Maximum Drawdown', '-' + metrics.maxDD.toFixed(2) + '%'],
                ['Volatilite Annualisee', metrics.volatility.toFixed(2) + '%'],
                ['Win Rate (Mois+)', metrics.winRate.toFixed(0) + '%'],
                ['Calmar Ratio', metrics.calmar > 10 ? '>10' : metrics.calmar.toFixed(2)]
            ];

            doc.autoTable({
                startY: 100,
                head: [['Metrique', 'Valeur']],
                body: metricsTable,
                theme: 'striped',
                headStyles: { fillColor: [0, 217, 255], textColor: [0, 0, 0] },
                styles: { fontSize: 9 },
                margin: { left: 20, right: 105 }
            });

            // Allocation
            doc.setFontSize(12);
            doc.text('Allocation d\'Actifs', 115, 95);

            const allocationTable = [
                ['Livret A', formatCurrency(portfolio.values.livret), ((portfolio.values.livret / portfolio.values.total) * 100).toFixed(1) + '%'],
                ['PEA (S&P 500)', formatCurrency(portfolio.values.pea), ((portfolio.values.pea / portfolio.values.total) * 100).toFixed(1) + '%'],
                ['Crypto (BTC+ETH)', formatCurrency(portfolio.values.crypto), ((portfolio.values.crypto / portfolio.values.total) * 100).toFixed(1) + '%']
            ];

            doc.autoTable({
                startY: 100,
                head: [['Actif', 'Valeur', 'Alloc.']],
                body: allocationTable,
                theme: 'striped',
                headStyles: { fillColor: [0, 255, 65], textColor: [0, 0, 0] },
                styles: { fontSize: 9 },
                margin: { left: 115, right: 20 }
            });

            // Holdings
            const holdingsY = Math.max(doc.lastAutoTable.finalY + 15, 180);
            doc.setFontSize(12);
            doc.text('Positions Detaillees', 20, holdingsY);

            const holdingsTable = [
                ['Livret A', formatCurrency(portfolio.values.livret), '--', '--', formatCurrency(portfolio.gains.livret)],
                ['ETF S&P 500', formatCurrency(portfolio.values.pea), portfolio.holdings.spShares.toFixed(3) + ' parts', formatCurrency(metrics.snapshots.length > 0 ? DATA.prices.sp500.current : 0), formatCurrency(portfolio.gains.pea)],
                ['Bitcoin', formatCurrency(portfolio.values.btc), portfolio.holdings.btcQty.toFixed(6) + ' BTC', formatCurrency(DATA.prices.btc.current), formatCurrency(portfolio.gains.btc)],
                ['Ethereum', formatCurrency(portfolio.values.eth), portfolio.holdings.ethQty.toFixed(5) + ' ETH', formatCurrency(DATA.prices.eth.current), formatCurrency(portfolio.gains.eth)]
            ];

            doc.autoTable({
                startY: holdingsY + 5,
                head: [['Actif', 'Valeur', 'Quantite', 'Prix Actuel', 'Gain']],
                body: holdingsTable,
                theme: 'striped',
                headStyles: { fillColor: [168, 85, 247], textColor: [255, 255, 255] },
                styles: { fontSize: 9 }
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Document genere automatiquement - Olympus Capital Tracker', 105, 280, { align: 'center' });
            doc.text('Ce document ne constitue pas un conseil en investissement', 105, 285, { align: 'center' });

            // Sauvegarder
            doc.save('rapport_olympus_' + new Date().toISOString().split('T')[0] + '.pdf');
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updatePreview() {
            const livret = parseFloat(document.getElementById('quickLivret').value) || 0;
            const pea = parseFloat(document.getElementById('quickPea').value) || 0;
            const btcEur = parseFloat(document.getElementById('quickBtc').value) || 0;
            const ethEur = parseFloat(document.getElementById('quickEth').value) || 0;

            const total = livret + pea + btcEur + ethEur;
            document.getElementById('previewTotal').textContent = formatCurrency(total);

            const btcPrice = DATA.prices.btc.current;
            const ethPrice = DATA.prices.eth.current;
            const spPrice = DATA.prices.sp500.current;

            if (btcPrice > 0) {
                document.getElementById('previewBtcQty').textContent = (btcEur / btcPrice).toFixed(6);
                document.getElementById('previewBtcPrice').textContent = '@ ' + formatCurrency(btcPrice);
            }

            if (ethPrice > 0) {
                document.getElementById('previewEthQty').textContent = (ethEur / ethPrice).toFixed(5);
                document.getElementById('previewEthPrice').textContent = '@ ' + formatCurrency(ethPrice);
            }

            if (spPrice > 0) {
                document.getElementById('previewSpQty').textContent = (pea / spPrice).toFixed(3);
                document.getElementById('previewSpPrice').textContent = '@ ' + formatCurrency(spPrice);
            }
        }

        function updateUI() {
            const hasData = DATA.transactions.length > 0;

            // Toggle visibility
            document.getElementById('emptyState').style.display = hasData ? 'none' : 'block';
            document.getElementById('patrimoineHero').style.display = hasData ? 'block' : 'none';
            document.getElementById('assetGrid').style.display = hasData ? 'grid' : 'none';
            document.getElementById('holdingsCard').style.display = hasData ? 'block' : 'none';
            document.getElementById('chartsSection').style.display = hasData ? 'grid' : 'none';

            // Module Intelligence - toujours visible
            document.getElementById('timingCard').style.display = 'block';
            document.getElementById('indicatorsGrid').style.display = 'grid';

            if (!hasData) return;

            const portfolio = calculatePortfolio();

            // Hero section
            document.getElementById('totalValue').textContent = formatNumber(portfolio.values.total);
            document.getElementById('totalInvested').textContent = formatCurrency(portfolio.invested.total);

            const gainEl = document.getElementById('totalGain');
            gainEl.textContent = formatGain(portfolio.gains.total) + ' (' + formatChange(portfolio.perf.total) + ')';
            gainEl.className = 'patrimoine-gain ' + (portfolio.gains.total >= 0 ? 'positive' : 'negative');

            document.getElementById('perfPercent').textContent = formatChange(portfolio.perf.total);
            document.getElementById('trackingMonths').textContent = calculateMonths();
            document.getElementById('nbVersements').textContent = DATA.transactions.length;

            // Asset cards
            updateAssetCard('livret', portfolio.values.livret, portfolio.invested.livret, portfolio.gains.livret, portfolio.values.total);
            updateAssetCard('pea', portfolio.values.pea, portfolio.invested.pea, portfolio.gains.pea, portfolio.values.total);
            updateAssetCard('crypto', portfolio.values.crypto, portfolio.invested.btc + portfolio.invested.eth, portfolio.gains.crypto, portfolio.values.total);

            // Holdings detail
            document.getElementById('holdLivretValue').textContent = formatCurrency(portfolio.values.livret);
            document.getElementById('holdLivretInv').textContent = formatCurrency(portfolio.invested.livret);
            document.getElementById('holdLivretInt').textContent = formatCurrency(portfolio.gains.livret);

            document.getElementById('holdSpValue').textContent = formatCurrency(portfolio.values.pea);
            document.getElementById('holdSpQty').textContent = portfolio.holdings.spShares.toFixed(3);
            document.getElementById('holdSpPru').textContent = formatCurrency(portfolio.pru.sp);
            document.getElementById('holdSpChange').textContent = formatChange(portfolio.perf.pea);
            document.getElementById('holdSpChange').className = 'holding-change ' + (portfolio.perf.pea >= 0 ? 'up' : 'down');

            document.getElementById('holdBtcValue').textContent = formatCurrency(portfolio.values.btc);
            document.getElementById('holdBtcQty').textContent = portfolio.holdings.btcQty.toFixed(6) + ' BTC';
            document.getElementById('holdBtcPru').textContent = formatCurrency(portfolio.pru.btc);
            document.getElementById('holdBtcChange').textContent = formatChange(portfolio.perf.btc);
            document.getElementById('holdBtcChange').className = 'holding-change ' + (portfolio.perf.btc >= 0 ? 'up' : 'down');

            document.getElementById('holdEthValue').textContent = formatCurrency(portfolio.values.eth);
            document.getElementById('holdEthQty').textContent = portfolio.holdings.ethQty.toFixed(5) + ' ETH';
            document.getElementById('holdEthPru').textContent = formatCurrency(portfolio.pru.eth);
            document.getElementById('holdEthChange').textContent = formatChange(portfolio.perf.eth);
            document.getElementById('holdEthChange').className = 'holding-change ' + (portfolio.perf.eth >= 0 ? 'up' : 'down');

            // Transactions table
            updateTransactionsTable();

            // Analytics
            document.getElementById('statPerf').textContent = formatChange(portfolio.perf.total);
            document.getElementById('statTotalGain').textContent = formatCurrency(portfolio.gains.total);

            // Mettre Ã  jour les mÃ©triques pro
            updateMetricsPro();

            // Mettre Ã  jour Track Record et Objectif
            updateTrackRecord();
            updateObjective();

            // Alertes et suggestion rÃ©Ã©quilibrage
            renderAlerts();
            updateRebalanceSuggestion();

            // Find best asset
            const perfs = [
                { name: 'BTC', perf: portfolio.perf.btc },
                { name: 'ETH', perf: portfolio.perf.eth },
                { name: 'S&P500', perf: portfolio.perf.pea }
            ];
            const best = perfs.sort((a, b) => b.perf - a.perf)[0];
            document.getElementById('statBestAsset').textContent = best.name + ' (' + formatChange(best.perf) + ')';
        }

        function updateAssetCard(type, value, invested, gain, total) {
            const alloc = total > 0 ? (value / total) * 100 : 0;

            document.getElementById(type + 'Value').textContent = formatCurrency(value);
            document.getElementById(type + 'Invested').textContent = 'Investi: ' + formatCurrency(invested);
            document.getElementById(type + 'Alloc').textContent = alloc.toFixed(1) + '%';

            const gainEl = document.getElementById(type + 'Gain');
            gainEl.textContent = formatGain(gain);
            gainEl.className = 'asset-gain ' + (gain >= 0 ? 'positive' : 'negative');

            document.getElementById(type + 'Bar').style.width = Math.min(alloc, 100) + '%';
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            const foot = document.getElementById('transactionsFoot');

            if (DATA.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="muted" style="text-align: center;">Aucune transaction</td></tr>';
                foot.style.display = 'none';
                return;
            }

            foot.style.display = 'table-footer-group';

            tbody.innerHTML = DATA.transactions.map(tx => `
                <tr>
                    <td>${formatDate(tx.date)}</td>
                    <td>${formatCurrency(tx.livret)}</td>
                    <td>${formatCurrency(tx.pea)}</td>
                    <td>${formatCurrency(tx.btc.eur)} <span class="muted">(${tx.btc.qty.toFixed(6)})</span></td>
                    <td>${formatCurrency(tx.eth.eur)} <span class="muted">(${tx.eth.qty.toFixed(5)})</span></td>
                    <td><strong>${formatCurrency(tx.total)}</strong></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${tx.id}')">&times;</button>
                    </td>
                </tr>
            `).join('');

            // Footer totals
            document.getElementById('footLivret').textContent = formatCurrency(DATA.invested.livret);
            document.getElementById('footPea').textContent = formatCurrency(DATA.invested.pea);
            document.getElementById('footBtc').textContent = formatCurrency(DATA.invested.btc);
            document.getElementById('footEth').textContent = formatCurrency(DATA.invested.eth);
            document.getElementById('footTotal').textContent = formatCurrency(DATA.invested.livret + DATA.invested.pea + DATA.invested.btc + DATA.invested.eth);

            // Holdings acquired
            document.getElementById('totalBtcQty').textContent = DATA.holdings.btcQty.toFixed(6) + ' BTC';
            document.getElementById('totalBtcInv').textContent = formatCurrency(DATA.invested.btc);
            document.getElementById('totalEthQty').textContent = DATA.holdings.ethQty.toFixed(5) + ' ETH';
            document.getElementById('totalEthInv').textContent = formatCurrency(DATA.invested.eth);
            document.getElementById('totalSpQty').textContent = DATA.holdings.spShares.toFixed(3);
            document.getElementById('totalSpInv').textContent = formatCurrency(DATA.invested.pea);
        }

        // ============================================
        // CHARTS
        // ============================================
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#fff', font: { family: "'JetBrains Mono'" } } }
                },
                scales: {
                    x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                }
            };

            CHARTS.evolution = new Chart(document.getElementById('evolutionChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: chartOptions
            });

            CHARTS.allocation = new Chart(document.getElementById('allocationChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Livret A', 'PEA', 'Crypto'],
                    datasets: [{ data: [0, 0, 0], backgroundColor: ['#00d9ff', '#a855f7', '#ff6b35'], borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
                }
            });

            CHARTS.monthly = new Chart(document.getElementById('monthlyChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: chartOptions
            });

            CHARTS.contribution = new Chart(document.getElementById('contributionChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Livret A', 'PEA', 'BTC', 'ETH'],
                    datasets: [{ data: [0, 0, 0, 0], backgroundColor: ['#00d9ff', '#a855f7', '#f7931a', '#627eea'], borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            if (DATA.transactions.length === 0) return;

            const portfolio = calculatePortfolio();

            // Allocation chart
            CHARTS.allocation.data.datasets[0].data = [
                portfolio.values.livret,
                portfolio.values.pea,
                portfolio.values.crypto
            ];
            CHARTS.allocation.update();

            // Contribution chart
            CHARTS.contribution.data.datasets[0].data = [
                DATA.invested.livret,
                DATA.invested.pea,
                DATA.invested.btc,
                DATA.invested.eth
            ];
            CHARTS.contribution.update();

            // Evolution chart - cumulative value over time
            const sortedTx = [...DATA.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            let cumInvested = 0;

            const labels = sortedTx.map(tx => formatDate(tx.date));
            const investedData = sortedTx.map(tx => {
                cumInvested += tx.total;
                return cumInvested;
            });

            CHARTS.evolution.data.labels = labels;
            CHARTS.evolution.data.datasets = [
                {
                    label: 'Valeur actuelle',
                    data: investedData.map(() => portfolio.values.total),
                    borderColor: '#00ff41',
                    backgroundColor: 'rgba(0, 255, 65, 0.1)',
                    fill: true
                },
                {
                    label: 'Investi',
                    data: investedData,
                    borderColor: '#00d9ff',
                    borderDash: [5, 5],
                    fill: false
                }
            ];
            CHARTS.evolution.update();

            // Monthly chart
            const monthlyData = {};
            sortedTx.forEach(tx => {
                const month = tx.date.substring(0, 7);
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += tx.total;
            });

            CHARTS.monthly.data.labels = Object.keys(monthlyData);
            CHARTS.monthly.data.datasets = [{
                label: 'Versements',
                data: Object.values(monthlyData),
                backgroundColor: '#00ff41'
            }];
            CHARTS.monthly.update();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showPanel(panelId) {
            // Normaliser l'ID du panel
            const normalizedId = panelId.startsWith('panel-') ? panelId.replace('panel-', '') : panelId;

            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            const panel = document.getElementById('panel-' + normalizedId);
            if (panel) {
                panel.classList.add('active');
            }

            // Trouver et activer le bon onglet de navigation
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                const tabPanel = tab.getAttribute('onclick')?.match(/showPanel\('([^']+)'\)/)?.[1];
                if (tabPanel === normalizedId) {
                    tab.classList.add('active');
                }
            });
        }

        // ============================================
        // SETTINGS
        // ============================================
        function saveConfig() {
            DATA.config.monthlyBudget = parseFloat(document.getElementById('configBudget').value) || 800;
            DATA.config.defaultLivret = parseFloat(document.getElementById('configLivret').value) || 300;
            DATA.config.defaultPea = parseFloat(document.getElementById('configPea').value) || 350;
            DATA.config.defaultBtc = parseFloat(document.getElementById('configBtc').value) || 105;
            DATA.config.defaultEth = parseFloat(document.getElementById('configEth').value) || 45;

            document.getElementById('quickLivret').value = DATA.config.defaultLivret;
            document.getElementById('quickPea').value = DATA.config.defaultPea;
            document.getElementById('quickBtc').value = DATA.config.defaultBtc;
            document.getElementById('quickEth').value = DATA.config.defaultEth;

            saveData();
            updatePreview();
            alert('Configuration sauvegardee !');
        }

        function updateSpPrice() {
            const price = parseFloat(document.getElementById('manualSpPrice').value);
            if (price > 0) {
                DATA.prices.sp500.current = price;
                saveData();
                updatePricesDisplay();
                updatePreview();
                updateUI();
                alert('Prix ETF mis a jour !');
            }
        }

        function exportJSON() {
            const dataStr = JSON.stringify(DATA, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tracker-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            let csv = 'Date,Livret A,PEA,BTC EUR,BTC Qty,ETH EUR,ETH Qty,Total\n';
            DATA.transactions.forEach(tx => {
                csv += `${tx.date},${tx.livret},${tx.pea},${tx.btc.eur},${tx.btc.qty},${tx.eth.eur},${tx.eth.qty},${tx.total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transactions-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.version && imported.transactions) {
                        DATA = imported;
                        saveData();
                        updateUI();
                        updateCharts();
                        alert('Donnees importees !');
                    } else {
                        alert('Format invalide');
                    }
                } catch (err) {
                    alert('Erreur: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('Supprimer toutes les donnees ?')) {
                if (confirm('Cette action est irreversible. Continuer ?')) {
                    DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    saveData();
                    updateUI();
                    updateCharts();
                    alert('Donnees effacees');
                }
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(value || 0);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value || 0);
        }

        function formatCompact(value) {
            if (value >= 1000) {
                return (value / 1000).toFixed(1) + 'kâ‚¬';
            }
            return value.toFixed(0) + 'â‚¬';
        }

        function formatChange(value) {
            return (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
        }

        function formatGain(value) {
            return (value >= 0 ? '+' : '') + formatCurrency(value);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function calculateMonths() {
            if (DATA.transactions.length === 0) return 0;
            const first = new Date(DATA.transactions[0].date);
            const now = new Date();
            return Math.ceil((now - first) / (1000 * 60 * 60 * 24 * 30));
        }

        // ============================================
        // RACCOURCIS CLAVIER (Ã  la fin pour s'assurer que toutes les fonctions sont dÃ©finies)
        // ============================================

        const KEYBOARD_SHORTCUTS = {
            'n': {
                action: () => document.getElementById('quickLivret')?.focus(),
                description: 'Nouveau versement',
                category: 'Actions'
            },
            's': {
                action: () => { captureSnapshot(); showNotification('Snapshot capture !', 'success'); },
                description: 'Capturer snapshot',
                category: 'Actions'
            },
            'r': {
                action: () => { refreshPrices(); showNotification('Prix actualises', 'info'); },
                description: 'Rafraichir prix',
                category: 'Actions'
            },
            'i': {
                action: () => refreshMarketIntelligence(),
                description: 'Actualiser indicateurs',
                category: 'Actions'
            },
            'm': {
                action: () => { showPanel('trackrecord'); setTimeout(() => runAdvancedMonteCarlo(), 100); },
                description: 'Lancer Monte Carlo',
                category: 'Analyses'
            },
            'g': {
                action: () => { showPanel('trackrecord'); setTimeout(() => document.getElementById('goalTarget')?.focus(), 100); },
                description: 'Goal Planner',
                category: 'Analyses'
            },
            'e': {
                action: () => exportJSON(),
                description: 'Exporter JSON',
                category: 'Export'
            },
            'p': {
                action: () => exportPDF(),
                description: 'Exporter PDF',
                category: 'Export'
            },
            'b': {
                action: () => showBackupManager(),
                description: 'Gerer backups',
                category: 'Donnees'
            },
            '1': {
                action: () => showPanel('dashboard'),
                description: 'Dashboard',
                category: 'Navigation'
            },
            '2': {
                action: () => showPanel('trackrecord'),
                description: 'Track Record',
                category: 'Navigation'
            },
            '3': {
                action: () => showPanel('transactions'),
                description: 'Transactions',
                category: 'Navigation'
            },
            '4': {
                action: () => showPanel('analytics'),
                description: 'Analytics',
                category: 'Navigation'
            },
            '5': {
                action: () => showPanel('settings'),
                description: 'Parametres',
                category: 'Navigation'
            },
            '6': {
                action: () => showPanel('shortcuts'),
                description: 'Raccourcis',
                category: 'Navigation'
            },
            '?': {
                action: () => showKeyboardHelp(),
                description: 'Aide raccourcis',
                category: 'Aide'
            },
            'Escape': {
                action: () => closeAllModals(),
                description: 'Fermer modales',
                category: 'Navigation'
            }
        };

        // Notification rapide
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 0.75rem 1.25rem;
                border-radius: 8px;
                font-size: 0.85rem;
                z-index: 9999;
                animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
                background: ${type === 'success' ? 'var(--success-dim)' : type === 'error' ? 'var(--danger-dim)' : 'var(--info-dim)'};
                border: 1px solid ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--info)'};
                color: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--info)'};
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        // Fermer toutes les modales et tooltips
        function closeAllModals() {
            // Fermer les modales classiques
            document.querySelectorAll('.modal-overlay.active').forEach(m => {
                m.classList.remove('active');
            });

            // Fermer les tooltips
            document.querySelectorAll('.tooltip-panel.active').forEach(t => {
                t.classList.remove('active');
            });
            document.querySelectorAll('.tooltip-overlay.active').forEach(o => {
                o.classList.remove('active');
            });

            // Fermer le level up
            const levelUp = document.querySelector('.levelup-overlay.active');
            if (levelUp) levelUp.classList.remove('active');

            // Appeler closeAllTooltips si existe
            if (typeof closeAllTooltips === 'function') {
                closeAllTooltips();
            }
        }

        // Ecouter les raccourcis clavier
        document.addEventListener('keydown', (e) => {
            // Ignorer si dans un champ de saisie
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // Ignorer si Ctrl/Alt/Meta est presse (sauf pour nos raccourcis)
            if (e.ctrlKey || e.altKey || e.metaKey) {
                return;
            }

            const key = e.key.toLowerCase();
            const shortcut = KEYBOARD_SHORTCUTS[key] || KEYBOARD_SHORTCUTS[e.key];

            if (shortcut) {
                e.preventDefault();
                try {
                    shortcut.action();
                } catch (err) {
                    console.error('Erreur raccourci:', err);
                }
            }
        });

        // Modal d'aide des raccourcis (groupee par categories)
        function showKeyboardHelp() {
            // Verifier si la modale existe deja
            let modal = document.getElementById('keyboardHelpModal');

            if (modal) {
                modal.classList.add('active');
                return;
            }

            // Creer la modale
            modal = document.createElement('div');
            modal.id = 'keyboardHelpModal';
            modal.className = 'modal-overlay active';
            modal.onclick = (e) => {
                if (e.target === modal) modal.classList.remove('active');
            };

            // Grouper par categorie
            const categories = {};
            Object.entries(KEYBOARD_SHORTCUTS).forEach(([key, data]) => {
                if (!categories[data.category]) categories[data.category] = [];
                categories[data.category].push({ key, ...data });
            });

            modal.innerHTML = `
                <div class="modal" style="max-width: 450px;">
                    <div class="modal-header">
                        <div class="modal-title">Raccourcis Clavier</div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').classList.remove('active')">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                        ${Object.entries(categories).map(([category, shortcuts]) => `
                            <div style="margin-bottom: 1.25rem;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid var(--border);">
                                    ${category}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    ${shortcuts.map(s => `
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <kbd style="
                                                background: var(--bg-primary);
                                                padding: 0.3rem 0.6rem;
                                                border-radius: 4px;
                                                font-family: var(--font-mono);
                                                font-size: 0.8rem;
                                                border: 1px solid var(--border);
                                                color: var(--text-primary);
                                                min-width: 28px;
                                                text-align: center;
                                            ">${s.key === 'Escape' ? 'Esc' : s.key.toUpperCase()}</kbd>
                                            <span style="color: var(--text-dim); font-size: 0.85rem;">${s.description}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-footer" style="justify-content: center;">
                        <span style="font-size: 0.7rem; color: var(--text-muted);">
                            Appuyez sur <kbd style="background: var(--bg-primary); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.7rem;">Esc</kbd> pour fermer
                        </span>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ============================================
        // SYSTEME DE BACKUP
        // ============================================

        const BACKUP_CONFIG = {
            maxBackups: 5,
            autoBackupInterval: 7 * 24 * 60 * 60 * 1000, // 7 jours
            storageKey: 'trackerBackups'
        };

        /**
         * Cree un backup des donnees
         */
        function createBackup(reason = 'manual') {
            const backups = JSON.parse(localStorage.getItem(BACKUP_CONFIG.storageKey) || '[]');

            const backup = {
                id: Date.now(),
                date: new Date().toISOString(),
                reason: reason,
                data: JSON.parse(JSON.stringify(DATA)),
                size: JSON.stringify(DATA).length
            };

            backups.unshift(backup);

            // Garder seulement les X derniers backups
            while (backups.length > BACKUP_CONFIG.maxBackups) {
                backups.pop();
            }

            localStorage.setItem(BACKUP_CONFIG.storageKey, JSON.stringify(backups));

            console.log('Backup cree (' + reason + '):', backup.id);
            if (reason === 'manual') {
                showNotification('Backup cree !', 'success');
            }
            return backup;
        }

        /**
         * Liste tous les backups
         */
        function listBackups() {
            return JSON.parse(localStorage.getItem(BACKUP_CONFIG.storageKey) || '[]');
        }

        /**
         * Restaure un backup
         */
        function restoreBackup(backupId) {
            const backups = listBackups();
            const backup = backups.find(b => b.id === backupId);

            if (!backup) {
                showNotification('Backup non trouve', 'error');
                return false;
            }

            // Creer un backup de l'etat actuel avant restauration
            createBackup('before_restore');

            // Restaurer
            DATA = backup.data;
            saveData();
            updateUI();

            showNotification('Backup du ' + formatDate(backup.date) + ' restaure !', 'success');
            return true;
        }

        /**
         * Verifie si un backup automatique est necessaire
         */
        function checkAutoBackup() {
            const lastBackup = localStorage.getItem('lastAutoBackup');
            const now = Date.now();

            if (!lastBackup || (now - parseInt(lastBackup)) > BACKUP_CONFIG.autoBackupInterval) {
                createBackup('auto');
                localStorage.setItem('lastAutoBackup', now.toString());
                console.log('Backup automatique effectue');
            }
        }

        /**
         * Affiche la modal de gestion des backups
         */
        function showBackupManager() {
            const backups = listBackups();

            let modal = document.getElementById('backupManagerModal');
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = 'backupManagerModal';
            modal.className = 'modal-overlay active';
            modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('active'); };

            const formatBackupDate = (dateStr) => {
                const d = new Date(dateStr);
                return d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            const getReasonLabel = (reason) => {
                if (reason === 'auto') return 'Automatique';
                if (reason === 'before_restore') return 'Avant restauration';
                return 'Manuel';
            };

            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title">Gestion des Backups</div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').classList.remove('active')">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <button class="btn btn-primary" onclick="createBackup('manual'); showBackupManager();" style="width: 100%;">
                                Creer un backup maintenant
                            </button>
                        </div>

                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 1rem;">
                            ${backups.length} backup(s) disponible(s) (max: ${BACKUP_CONFIG.maxBackups})
                        </div>

                        ${backups.length === 0 ? `
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                Aucun backup disponible
                            </div>
                        ` : `
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                                ${backups.map(b => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border);">
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-white);">
                                                ${formatBackupDate(b.date)}
                                            </div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">
                                                ${getReasonLabel(b.reason)} - ${(b.size / 1024).toFixed(1)} KB
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" onclick="if(confirm('Restaurer ce backup ?')) { restoreBackup(${b.id}); document.getElementById('backupManagerModal').classList.remove('active'); }">
                                            Restaurer
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <span style="font-size: 0.7rem; color: var(--text-muted);">
                            Backup auto tous les 7 jours
                        </span>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ============================================
        // PWA - SERVICE WORKER & INSTALLATION
        // ============================================

        // Enregistrer le Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker enregistre:', reg.scope))
                    .catch(err => console.log('Service Worker erreur:', err));

                // Verifier backup automatique apres chargement complet
                checkAutoBackup();
            });
        }

        // Gestion installation PWA
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Afficher un bouton d'installation
            const installBtn = document.createElement('button');
            installBtn.id = 'installPWA';
            installBtn.className = 'btn btn-secondary';
            installBtn.innerHTML = 'Installer l\'app';
            installBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 999;';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        installBtn.remove();
                    }
                    deferredPrompt = null;
                }
            };

            document.body.appendChild(installBtn);
        });

        window.addEventListener('appinstalled', () => {
            document.getElementById('installPWA')?.remove();
            console.log('PWA installee !');
        });
    </script>

    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator">
        <span class="sync-dot"></span>
        <span class="sync-text">Synchronise</span>
    </div>
</body>
</html>
